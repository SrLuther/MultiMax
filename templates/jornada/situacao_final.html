{% extends 'base.html' %}
{% block title %}Jornada - Situação Final — MultiMax{% endblock %}

{% block content %}
<div class="jornada-container">
    <!-- Hero Header com Navegação -->
    <div class="jornada-hero">
        <div class="jornada-hero-content">
            <div>
                <h1 class="jornada-title">
                    <i class="bi bi-clipboard-data jornada-title-icon"></i>
                    Situação Final
                </h1>
                <p class="jornada-subtitle">Situação consolidada atual de cada colaborador (apenas dados ativos)</p>
            </div>
            <div class="jornada-hero-actions">
                {% if current_user.nivel in ('admin', 'DEV', 'operador') %}
                <div class="btn-group" style="margin-right: 1rem;">
                    <button type="button" class="btn-jornada btn-jornada-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-download"></i>
                        <span>PDF</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="{{ url_for('jornada_pdf.situacao_final') }}" target="_blank">
                                <i class="bi bi-eye"></i> Visualizar PDF
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('jornada_pdf.situacao_final') }}" download>
                                <i class="bi bi-download"></i> Download PDF
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('jornada_pdf.situacao_final') }}" onclick="window.print(); return false;">
                                <i class="bi bi-printer"></i> Imprimir
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" onclick="sharePDF('{{ url_for('jornada_pdf.situacao_final') }}'); return false;">
                                <i class="bi bi-share"></i> Compartilhar
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
                <!-- Navegação entre subpáginas -->
                <div class="jornada-nav">
                    <a href="{{ url_for('jornada.em_aberto') }}" class="jornada-nav-item">
                        <i class="bi bi-circle-fill"></i>
                        <span>Em Aberto</span>
                    </a>
                    <a href="{{ url_for('jornada.fechado_revisao') }}" class="jornada-nav-item">
                        <i class="bi bi-clock-history"></i>
                        <span>Fechado para Revisão</span>
                    </a>
                    <a href="{{ url_for('jornada.arquivados') }}" class="jornada-nav-item">
                        <i class="bi bi-archive-fill"></i>
                        <span>Arquivados</span>
                    </a>
                    <a href="{{ url_for('jornada.situacao_final') }}" class="jornada-nav-item active">
                        <i class="bi bi-clipboard-data"></i>
                        <span>Situação Final</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Resumo Padronizado -->
    <div class="jornada-card">
        <div class="jornada-card-header">
            <h3 class="jornada-card-title">
                <i class="bi bi-graph-up"></i>
                Resumo Geral
            </h3>
        </div>
        <div class="jornada-stats-grid">
            <div class="jornada-stat-card">
                <div class="jornada-stat-icon">
                    <i class="bi bi-clock"></i>
                </div>
                <div class="jornada-stat-label">Total de Horas</div>
                <div class="jornada-stat-value">{{ "%.2f"|format(total_geral_horas) }}h</div>
            </div>
            <div class="jornada-stat-card">
                <div class="jornada-stat-icon" style="background: var(--jornada-success);">
                    <i class="bi bi-calendar-plus"></i>
                </div>
                <div class="jornada-stat-label">Folgas Adicionadas</div>
                <div class="jornada-stat-value">{{ total_geral_folgas_adicionadas }} dias</div>
            </div>
            <div class="jornada-stat-card">
                <div class="jornada-stat-icon" style="background: var(--jornada-warning);">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <div class="jornada-stat-label">Folgas Usadas</div>
                <div class="jornada-stat-value">{{ total_geral_folgas_usadas }} dias</div>
            </div>
            <div class="jornada-stat-card">
                <div class="jornada-stat-icon" style="background: var(--jornada-info);">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="jornada-stat-label">Conversões</div>
                <div class="jornada-stat-value">{{ total_geral_conversoes }} dias</div>
            </div>
            <div class="jornada-stat-card">
                <div class="jornada-stat-icon" style="background: var(--jornada-primary);">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="jornada-stat-label">Saldo Total de Folgas</div>
                <div class="jornada-stat-value">{{ total_geral_saldo }} dias</div>
            </div>
        </div>
    </div>

    <!-- Tabela de Situação por Colaborador -->
    <div class="jornada-card">
        <div class="jornada-card-header">
            <h3 class="jornada-card-title">
                <i class="bi bi-table"></i>
                Situação por Colaborador
            </h3>
            <small style="color: var(--jornada-text-muted); margin-top: 0.5rem; display: block;">
                Dados consolidados apenas de registros ativos (não arquivados)
            </small>
        </div>
        <div class="jornada-table-wrapper">
            <table class="jornada-table">
                <thead>
                    <tr>
                        <th>Colaborador</th>
                        <th>Total Horas</th>
                        <th>Horas Residuais</th>
                        <th>Dias das Horas</th>
                        <th>Folgas Adicionadas</th>
                        <th>Folgas Usadas</th>
                        <th>Conversões</th>
                        <th>Saldo de Folgas</th>
                    </tr>
                </thead>
                <tbody>
                    {% for situacao in situacoes %}
                    <tr>
                        <td>
                            <strong>{{ situacao.display_name }}</strong>
                        </td>
                        <td>
                            <strong>{{ "%.2f"|format(situacao.total_horas) }}h</strong>
                        </td>
                        <td>
                            {{ "%.2f"|format(situacao.horas_residuais) }}h
                        </td>
                        <td>
                            {{ situacao.dias_das_horas }} dias
                        </td>
                        <td>
                            <span class="jornada-badge jornada-badge-success">{{ situacao.folgas_adicionadas }} dias</span>
                        </td>
                        <td>
                            <span class="jornada-badge jornada-badge-danger">{{ situacao.folgas_usadas }} dias</span>
                        </td>
                        <td>
                            <span class="jornada-badge jornada-badge-info">{{ situacao.conversoes }} dias</span>
                        </td>
                        <td>
                            <strong style="color: var(--jornada-primary); font-size: 1.1rem;">
                                {{ situacao.saldo_folgas }} dias
                            </strong>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: rgba(102, 126, 234, 0.1); border-top: 2px solid var(--jornada-primary);">
                        <td><strong>TOTAL GERAL</strong></td>
                        <td><strong>{{ "%.2f"|format(total_geral_horas) }}h</strong></td>
                        <td>-</td>
                        <td>-</td>
                        <td><strong>{{ total_geral_folgas_adicionadas }} dias</strong></td>
                        <td><strong>{{ total_geral_folgas_usadas }} dias</strong></td>
                        <td><strong>{{ total_geral_conversoes }} dias</strong></td>
                        <td><strong style="color: var(--jornada-primary); font-size: 1.2rem;">{{ total_geral_saldo }} dias</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
<script>
function sharePDF(url) {
    if (navigator.share) {
        navigator.share({
            title: 'Jornada - Situação Final',
            text: 'Relatório de Jornada - Situação Final',
            url: url
        }).catch(err => console.log('Erro ao compartilhar:', err));
    } else {
        navigator.clipboard.writeText(window.location.origin + url).then(() => {
            alert('URL copiada para a área de transferência!');
        });
    }
}
</script>
{% endblock %}
