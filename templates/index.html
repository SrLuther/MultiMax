{% extends 'base.html' %}
{% block title %}MultiMax{% endblock %}
{% block content %}
<div class="mb-3">
  <h2 class="mb-2">Controle de Estoque</h2>
  <div class="d-flex flex-wrap align-items-center gap-2">
    {% if current_user.nivel in ('operador','admin') %}
    <a class="btn btn-outline-success" href="{{ url_for('estoque.lista_produtos') }}">Gerenciar Produtos</a>
    {% endif %}
    <a class="btn btn-outline-danger" href="{{ url_for('exportacao.exportar') }}">Exportar Estoque (PDF)</a>
    <span class="ms-auto text-muted">{{ current_user.username }}</span>
  </div>
  <div class="mt-2 small text-muted">
    <span class="me-2">Legenda:</span>
    <span class="badge bg-secondary me-1">CX</span> Caixas
    <span class="badge bg-secondary ms-3 me-1">PC</span> Pacotes
    <span class="badge bg-secondary ms-3 me-1">VA</span> A vácuo
    <span class="badge bg-secondary ms-3 me-1">AV</span> Avulsos
  </div>
</div>

<form class="row g-3 mb-3" method="get" action="{{ url_for('estoque.index') }}">
  <div class="col-md-6">
    <input type="search" name="busca" value="{{ busca or '' }}" class="form-control" placeholder="Buscar por Código ou Nome">
  </div>
  <div class="col-md-6 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Buscar</button>
    <a class="btn btn-secondary" href="{{ url_for('estoque.index') }}">Limpar</a>
  </div>
  <div class="col-12">
    <small class="text-muted">Resultados: {{ produtos|length }}</small>
  </div>
  {% if busca %}
  <div class="col-12">
    <div class="alert alert-info py-2">Filtro: "{{ busca }}"</div>
  </div>
  {% endif %}
</form>

<div class="table-responsive-sm mb-4">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th style="width: 8rem">Código</th>
        <th>Produto</th>
        <th class="text-end" style="width: 6rem">Estoque</th>
        <th class="text-end" style="width: 6rem">Mínimo</th>
        <th class="text-center" style="width: 14rem">Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for p in produtos %}
      {% set status_class = 'table-success' %}
      {% if p.quantidade < p.estoque_minimo %}
        {% set status_class = 'table-danger' %}
      {% elif p.quantidade == p.estoque_minimo and p.quantidade > 0 %}
        {% set status_class = 'table-warning' %}
      {% endif %}
      <tr class="{{ status_class }}">
        <td>{{ p.codigo }}</td>
        <td>{{ p.nome }}</td>
        <td class="text-end">{{ p.quantidade }}</td>
        <td class="text-end">{{ p.estoque_minimo }}</td>
        <td class="text-center">
          {% if current_user.nivel in ('operador','admin') %}
          <div class="btn-group btn-group-sm" role="group">
            <form method="post" action="{{ url_for('estoque.entrada_produto', id=p.id) }}" class="d-inline">
              <input type="hidden" name="quantidade" value="1">
              <button class="btn btn-outline-primary" type="submit">+1</button>
            </form>
            <form method="post" action="{{ url_for('estoque.saida_produto', id=p.id) }}" class="d-inline">
              <input type="hidden" name="quantidade" value="1">
              <button class="btn btn-outline-warning" type="submit">-1</button>
            </form>
            <a class="btn btn-outline-info" href="{{ url_for('estoque.editar', id=p.id) }}">Editar</a>
          </div>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted">Nenhum produto encontrado</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h4 class="mb-2">Histórico de Movimentações</h4>
<div class="table-responsive-sm">
  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th style="width: 12rem">Data</th>
        <th style="width: 8rem">Tipo</th>
        <th>Detalhes</th>
        <th class="text-end" style="width: 6rem">Qtd</th>
        <th style="width: 10rem">Usuário</th>
      </tr>
    </thead>
    <tbody>
      {% for h in historico.items %}
      <tr>
        <td>{{ h.data.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ h.action }}</td>
        <td>{{ h.details }}</td>
        <td class="text-end">{{ h.quantidade }}</td>
        <td>{{ h.usuario }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted">Sem movimentações</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Paginação Histórico" class="mt-2">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if not historico.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('estoque.index', page=historico.prev_num, busca=busca) }}">Anterior</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Página {{ historico.page }} de {{ historico.pages }}</span></li>
    <li class="page-item {% if not historico.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('estoque.index', page=historico.next_num, busca=busca) }}">Próxima</a>
    </li>
  </ul>
</nav>
{% endblock %}
