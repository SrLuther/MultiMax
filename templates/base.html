<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <meta name="description" content="MultiMax - Sistema de gestão completo para seu negócio">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/design-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='multimax-estilo.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-fixes.css') }}">
    {% if 'jornada' in request.endpoint %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/jornada-modern.css') }}">
    {% endif %}
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon-180.png') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/logo-user.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='icons/logo-user.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#00ff88">
    <title>{% block title %}MultiMax{% endblock %}</title>
    {% block head %}{% endblock %}
</head>
<body class="mm-safe-area">
    <a href="#main-content" class="mm-skip-link">Pular para o conteúdo principal</a>
    <aside class="mm-sidebar" id="sidebar" role="navigation" aria-label="Menu principal">
        <div class="mm-sidebar-header">
            <img src="{{ url_for('static', filename='icons/logo-user.png') }}" alt="Logo MultiMax" class="mm-sidebar-logo" loading="lazy">
            <div class="mm-sidebar-brand">
                MultiMax
                <span>Gestão Amora</span>
            </div>
        </div>
        
        <nav class="mm-sidebar-nav" aria-label="Navegação do sistema">
            <div class="mm-nav-section">
                <div class="mm-nav-section-title">Principal</div>
                <a href="{{ url_for('home.index') }}" class="mm-nav-item {% if request.endpoint == 'home.index' %}active{% endif %}">
                    <i class="bi bi-house-door mm-nav-icon"></i>
                    <span class="mm-nav-text">Dashboard</span>
                </a>
                <a href="{{ url_for('estoque.index') }}" class="mm-nav-item {% if 'estoque' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-box-seam mm-nav-icon"></i>
                    <span class="mm-nav-text">Estoque</span>
                </a>
            </div>
            
            {% if current_user.is_authenticated and current_user.nivel in ('visualizador','operador','admin','DEV') %}
            <div class="mm-nav-section">
                <div class="mm-nav-section-title">Operações</div>
                <a href="{{ url_for('cronograma.cronograma') }}" class="mm-nav-item {% if 'cronograma' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-calendar-check mm-nav-icon"></i>
                    <span class="mm-nav-text">Cronograma</span>
                </a>
                <a href="{{ url_for('carnes.index') }}" class="mm-nav-item {% if 'carnes' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-basket mm-nav-icon"></i>
                    <span class="mm-nav-text">Carnes</span>
                </a>
                <a href="{{ url_for('receitas.index') }}" class="mm-nav-item {% if 'receitas' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-journal-text mm-nav-icon"></i>
                    <span class="mm-nav-text">Receitas</span>
                </a>
                <a href="{{ url_for('colaboradores.escala') }}" class="mm-nav-item {% if 'colaboradores' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-people mm-nav-icon"></i>
                    <span class="mm-nav-text">Escalas</span>
                </a>
                <a href="{{ url_for('ciclos.index') }}" class="mm-nav-item {% if 'ciclos' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-arrow-repeat mm-nav-icon"></i>
                    <span class="mm-nav-text">Ciclos</span>
                </a>
            </div>
            
            {% endif %}
            
            
            {% if current_user.is_authenticated and current_user.nivel in ('admin', 'DEV') %}
            <div class="mm-nav-section">
                <div class="mm-nav-section-title">Administração</div>
                <a href="{{ url_for('usuarios.gestao') }}" class="mm-nav-item {% if 'usuarios' in request.endpoint %}active{% endif %}">
                    <i class="bi bi-gear mm-nav-icon"></i>
                    <span class="mm-nav-text">Gestão</span>
                </a>
                {% if current_user.is_authenticated and current_user.nivel == 'DEV' %}
                <a href="/db" class="mm-nav-item {% if 'dbadmin' in request.endpoint or request.path.startswith('/db') %}active{% endif %}">
                    <i class="bi bi-database mm-nav-icon"></i>
                    <span class="mm-nav-text">Banco de Dados</span>
                </a>
                {% endif %}
            </div>
            {% endif %}
        </nav>
        
        <div class="mm-sidebar-footer">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('usuarios.perfil') }}" class="mm-nav-item">
                <i class="bi bi-person-circle mm-nav-icon"></i>
                <span class="mm-nav-text">{{ current_user.nome or current_user.username }}</span>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="mm-nav-item" style="color: var(--mm-danger);">
                <i class="bi bi-box-arrow-right mm-nav-icon"></i>
                <span class="mm-nav-text">Sair</span>
            </a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="mm-nav-item">
                <i class="bi bi-box-arrow-in-right mm-nav-icon"></i>
                <span class="mm-nav-text">Entrar</span>
            </a>
            {% endif %}
        </div>
    </aside>

    <header class="mm-topbar" role="banner">
        <div class="mm-topbar-left">
            <button class="mm-toggle-sidebar" onclick="toggleSidebar()" aria-label="Alternar menu lateral" aria-expanded="true" aria-controls="sidebar">
                <i class="bi bi-list" aria-hidden="true"></i>
            </button>
            <nav class="mm-breadcrumb d-none d-md-flex" aria-label="Trilha de navegação">
                <a href="{{ url_for('home.index') }}">Home</a>
                {% block breadcrumb %}{% endblock %}
            </nav>
        </div>
        <div class="mm-topbar-right">
            {% if current_user.is_authenticated %}
            
            <div class="mm-quick-actions d-none d-lg-flex" role="toolbar" aria-label="Ações rápidas">
                <a href="{{ url_for('estoque.lista_produtos') }}" class="mm-quick-action" title="Gerenciar produtos" aria-label="Gerenciar produtos">
                    <i class="bi bi-plus-circle" aria-hidden="true"></i>
                </a>
                <a href="{{ url_for('estoque.index') }}" class="mm-quick-action" title="Ver estoque" aria-label="Ver estoque">
                    <i class="bi bi-box-seam" aria-hidden="true"></i>
                </a>
                {% if current_user.nivel in ('operador','admin','DEV') %}
                <a href="{{ url_for('cronograma.cronograma') }}" class="mm-quick-action" title="Cronograma de limpeza" aria-label="Cronograma de limpeza">
                    <i class="bi bi-calendar-check" aria-hidden="true"></i>
                </a>
                {% endif %}
            </div>
            
            <div class="mm-topbar-divider d-none d-lg-block" aria-hidden="true"></div>
            
            <button class="mm-search-trigger" onclick="openSearch()" title="Buscar (Ctrl+K)" aria-label="Abrir busca global, atalho Ctrl+K">
                <i class="bi bi-search" aria-hidden="true"></i>
                <span class="d-none d-md-inline">Buscar</span>
                <kbd class="d-none d-lg-inline" aria-hidden="true">Ctrl+K</kbd>
            </button>
            
            <div class="mm-notifications-wrapper">
                <button class="mm-notifications-btn" onclick="toggleNotifications()" id="notificationsBtn" aria-label="Notificações" aria-haspopup="true" aria-expanded="false">
                    <i class="bi bi-bell" aria-hidden="true"></i>
                    <span class="mm-notifications-badge" id="notificationsBadge" style="display: none;" aria-live="polite">0</span>
                </button>
                <div class="mm-notifications-dropdown" id="notificationsDropdown" role="menu" aria-label="Lista de notificações">
                    <div class="mm-notifications-header">
                        <span>Notificações</span>
                        <button class="mm-btn mm-btn-sm mm-btn-ghost" onclick="markAllRead()" aria-label="Marcar todas como lidas">Limpar</button>
                    </div>
                    <div class="mm-notifications-list" id="notificationsList" role="list">
                        <div class="mm-notifications-empty">
                            <i class="bi bi-bell-slash" aria-hidden="true"></i>
                            <span>Sem notificações</span>
                        </div>
                    </div>
                    <div class="mm-notifications-footer">
                        <a href="{{ url_for('home.index') }}">Ver todas</a>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <button class="mm-theme-toggle" onclick="toggleTheme()" aria-label="Alternar tema claro/escuro" aria-pressed="false">
                <i class="bi bi-moon" id="themeIcon" aria-hidden="true"></i>
            </button>
            {% if current_user.is_authenticated %}
            <span class="mm-user-name d-none d-md-inline-flex" aria-label="Usuário">
                <i class="bi bi-person-circle"></i>
                {{ current_user.collaborator_name or current_user.name }}
            </span>
            {% endif %}
        </div>
    </header>
    
    <div class="mm-install-banner" id="installBanner" role="alert" style="display: none;">
        <div class="mm-install-content">
            <i class="bi bi-download" aria-hidden="true"></i>
            <span>Instale o MultiMax no seu dispositivo para acesso rápido!</span>
        </div>
        <div class="mm-install-actions">
            <button class="mm-btn mm-btn-sm mm-btn-primary" onclick="installPWA()" aria-label="Instalar aplicativo">Instalar</button>
            <button class="mm-btn mm-btn-sm mm-btn-ghost" onclick="dismissInstall()" aria-label="Fechar banner de instalação">
                <i class="bi bi-x" aria-hidden="true"></i>
            </button>
        </div>
    </div>
    
    <div class="mm-search-modal" id="searchModal" onclick="closeSearchOnOverlay(event)" role="dialog" aria-modal="true" aria-label="Busca global">
        <div class="mm-search-container">
            <div class="mm-search-input-wrapper">
                <i class="bi bi-search" aria-hidden="true"></i>
                <input type="text" id="searchInput" class="mm-search-input" placeholder="Buscar produtos, páginas, colaboradores..." autocomplete="off" aria-label="Campo de busca">
                <kbd aria-hidden="true">ESC</kbd>
            </div>
            <div class="mm-search-results" id="searchResults" role="listbox" aria-label="Resultados da busca">
                <div class="mm-search-empty">
                    <i class="bi bi-search" style="font-size: 2rem; opacity: 0.3;" aria-hidden="true"></i>
                    <span>Digite para buscar...</span>
                </div>
            </div>
            <div class="mm-search-footer" aria-hidden="true">
                <span><kbd>↑</kbd><kbd>↓</kbd> navegar</span>
                <span><kbd>Enter</kbd> selecionar</span>
                <span><kbd>ESC</kbd> fechar</span>
            </div>
        </div>
    </div>

    <main class="mm-main" id="main-content" role="main" tabindex="-1">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mm-alert mm-alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'info' }} mm-mb-4">
                    <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
                    <span>{{ message }}</span>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <div class="mm-sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                // Mobile: toggle sidebar e overlay
                sidebar.classList.toggle('active');
                sidebar.classList.toggle('mm-sidebar-open');
                overlay.classList.toggle('active');
                
                // Prevenir scroll do body quando sidebar está aberto
                if (sidebar.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            } else {
                // Desktop: apenas collapse
                sidebar.classList.toggle('collapsed');
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('active', 'mm-sidebar-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Fechar sidebar ao clicar em um link (mobile)
        if (window.innerWidth <= 768) {
            document.addEventListener('DOMContentLoaded', function() {
                const navLinks = document.querySelectorAll('.mm-nav-item');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        setTimeout(closeSidebar, 300); // Delay para animação
                    });
                });
            });
        }
        
        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });
        
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            const currentTheme = html.getAttribute('data-theme');
            
            if (currentTheme === 'light') {
                html.setAttribute('data-theme', 'dark');
                icon.classList.remove('bi-moon');
                icon.classList.add('bi-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                icon.classList.remove('bi-sun');
                icon.classList.add('bi-moon');
                localStorage.setItem('theme', 'light');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const icon = document.getElementById('themeIcon');
            
            html.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                icon.classList.remove('bi-moon');
                icon.classList.add('bi-sun');
            }
        });
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .catch(function(err) {
                        // Service Worker falhou silenciosamente
                        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                            console.error('Erro no Service Worker:', err);
                        }
                    });
            });
        }
        
        let notificationsOpen = false;
        let searchOpen = false;
        let searchResults = [];
        let selectedIndex = -1;
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            notificationsOpen = !notificationsOpen;
            dropdown.classList.toggle('open', notificationsOpen);
            if (notificationsOpen) {
                loadNotifications();
            }
        }
        
        async function loadNotifications() {
            try {
                const res = await fetch('/api/v1/notifications');
                const data = await res.json();
                const list = document.getElementById('notificationsList');
                const badge = document.getElementById('notificationsBadge');
                
                if (data.count > 0) {
                    badge.textContent = data.count > 9 ? '9+' : data.count;
                    badge.style.display = 'flex';
                    
                    list.innerHTML = data.notifications.map(n => `
                        <a href="${n.url}" class="mm-notification-item" onclick="markRead('${n.type}', ${n.id})">
                            <div class="mm-notification-icon mm-notification-${n.color}">
                                <i class="bi bi-${n.icon}"></i>
                            </div>
                            <div class="mm-notification-content">
                                <div class="mm-notification-title">${n.title}</div>
                                <div class="mm-notification-subtitle">${n.subtitle}</div>
                            </div>
                        </a>
                    `).join('');
                } else {
                    badge.style.display = 'none';
                    list.innerHTML = `
                        <div class="mm-notifications-empty">
                            <i class="bi bi-check-circle" style="color: var(--mm-success);"></i>
                            <span>Tudo em dia!</span>
                        </div>
                    `;
                }
            } catch (e) {
                console.error('Erro ao carregar notificações:', e);
            }
        }
        
        async function markRead(type, id) {
            if (!type || !id) return;
            try {
                await fetch('/api/v1/notifications/read', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type, id})
                });
            } catch (e) {}
        }
        
        function markAllRead() {
            const badge = document.getElementById('notificationsBadge');
            badge.style.display = 'none';
            document.getElementById('notificationsList').innerHTML = `
                <div class="mm-notifications-empty">
                    <i class="bi bi-check-circle" style="color: var(--mm-success);"></i>
                    <span>Tudo em dia!</span>
                </div>
            `;
        }
        
        function openSearch() {
            searchOpen = true;
            document.getElementById('searchModal').classList.add('open');
            document.getElementById('searchInput').focus();
            document.body.style.overflow = 'hidden';
        }
        
        function closeSearch() {
            searchOpen = false;
            document.getElementById('searchModal').classList.remove('open');
            document.getElementById('searchInput').value = '';
            document.body.style.overflow = '';
            selectedIndex = -1;
        }
        
        function closeSearchOnOverlay(e) {
            if (e.target.id === 'searchModal') closeSearch();
        }
        
        async function performSearch(query) {
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = `
                    <div class="mm-search-empty">
                        <i class="bi bi-search" style="font-size: 2rem; opacity: 0.3;"></i>
                        <span>Digite para buscar...</span>
                    </div>
                `;
                searchResults = [];
                return;
            }
            
            try {
                const res = await fetch(`/api/v1/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();
                searchResults = data.results;
                
                if (searchResults.length === 0) {
                    document.getElementById('searchResults').innerHTML = `
                        <div class="mm-search-empty">
                            <i class="bi bi-emoji-frown" style="font-size: 2rem; opacity: 0.3;"></i>
                            <span>Nenhum resultado encontrado</span>
                        </div>
                    `;
                } else {
                    document.getElementById('searchResults').innerHTML = searchResults.map((r, i) => `
                        <a href="${r.url}" class="mm-search-result ${i === selectedIndex ? 'selected' : ''}" data-index="${i}">
                            <div class="mm-search-result-icon">
                                <i class="bi bi-${r.icon}"></i>
                            </div>
                            <div class="mm-search-result-content">
                                <div class="mm-search-result-title">${r.title}</div>
                                <div class="mm-search-result-subtitle">${r.subtitle}</div>
                            </div>
                            <span class="mm-search-result-type">${r.type}</span>
                        </a>
                    `).join('');
                }
            } catch (e) {
                console.error('Erro na busca:', e);
            }
        }
        
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openSearch();
            }
            
            if (e.key === 'Escape' && searchOpen) {
                closeSearch();
            }
            
            if (searchOpen && searchResults.length > 0) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, searchResults.length - 1);
                    updateSearchSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSearchSelection();
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    window.location.href = searchResults[selectedIndex].url;
                }
            }
        });
        
        function updateSearchSelection() {
            document.querySelectorAll('.mm-search-result').forEach((el, i) => {
                el.classList.toggle('selected', i === selectedIndex);
            });
        }
        
        document.getElementById('searchInput')?.addEventListener('input', function(e) {
            performSearch(e.target.value);
        });
        
        document.addEventListener('click', function(e) {
            if (notificationsOpen && !e.target.closest('.mm-notifications-wrapper')) {
                notificationsOpen = false;
                document.getElementById('notificationsDropdown').classList.remove('open');
            }
        });
        
        if (document.getElementById('notificationsBadge')) {
            loadNotifications();
            setInterval(loadNotifications, 60000);
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('a[data-pdf-export]').forEach(function(link) {
            var href = link.getAttribute('href');
            var group = document.createElement('div');
            group.className = 'mm-flex mm-gap-2';
            var btnView = document.createElement('a');
            btnView.className = 'mm-btn mm-btn-outline';
            btnView.innerHTML = '<i class="bi bi-eye"></i> Visualizar';
            btnView.href = '#';
            btnView.addEventListener('click', function(e) {
                e.preventDefault();
                var url = href + (href.indexOf('?') >= 0 ? '&' : '?') + 'mode=view';
                window.open(url, '_blank', 'noopener,noreferrer');
            });
            var btnPrint = document.createElement('a');
            btnPrint.className = 'mm-btn mm-btn-outline';
            btnPrint.innerHTML = '<i class="bi bi-printer"></i> Imprimir';
            btnPrint.href = '#';
            btnPrint.addEventListener('click', function(e) {
                e.preventDefault();
                var url = href + (href.indexOf('?') >= 0 ? '&' : '?') + 'mode=view';
                var iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                iframe.src = url;
                iframe.onload = function() {
                    try {
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                    } catch (err) {}
                    setTimeout(function(){ iframe.remove(); }, 3000);
                };
                document.body.appendChild(iframe);
            });
            var btnDownload = document.createElement('a');
            btnDownload.className = 'mm-btn mm-btn-outline';
            btnDownload.innerHTML = '<i class="bi bi-download"></i> Download';
            btnDownload.href = href + (href.indexOf('?') >= 0 ? '&' : '?') + 'mode=download';
            group.appendChild(btnView);
            group.appendChild(btnPrint);
            group.appendChild(btnDownload);
            link.replaceWith(group);
        });
    });
    </script>
    
    <style>
    .mm-search-trigger {
        display: flex;
        align-items: center;
        gap: var(--mm-space-2);
        padding: var(--mm-space-2) var(--mm-space-3);
        background: var(--mm-bg-secondary);
        border: 1px solid var(--mm-border);
        border-radius: var(--mm-radius-md);
        color: var(--mm-text-muted);
        cursor: pointer;
        transition: all var(--mm-transition);
        font-size: var(--mm-text-sm);
    }
    .mm-search-trigger:hover {
        background: var(--mm-bg-tertiary);
        color: var(--mm-text-primary);
        border-color: var(--mm-primary);
    }
    .mm-search-trigger kbd {
        background: var(--mm-bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        color: var(--mm-text-muted);
    }
    
    .mm-notifications-wrapper {
        position: relative;
    }
    .mm-notifications-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: var(--mm-radius);
        background: transparent;
        border: none;
        color: var(--mm-text-secondary);
        cursor: pointer;
        position: relative;
        transition: all var(--mm-transition);
    }
    .mm-notifications-btn:hover {
        background: var(--mm-bg-secondary);
        color: var(--mm-primary);
    }
    .mm-notifications-badge {
        position: absolute;
        top: 2px;
        right: 2px;
        min-width: 16px;
        height: 16px;
        background: var(--mm-danger);
        color: white;
        font-size: 10px;
        font-weight: 600;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
    }
    .mm-notifications-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        width: 320px;
        background: var(--mm-bg-card);
        border: 1px solid var(--mm-border);
        border-radius: var(--mm-radius-lg);
        box-shadow: var(--mm-shadow-xl);
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all var(--mm-transition);
        z-index: 1000;
        margin-top: var(--mm-space-2);
    }
    .mm-notifications-dropdown.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    .mm-notifications-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--mm-space-3) var(--mm-space-4);
        border-bottom: 1px solid var(--mm-border);
        font-weight: var(--mm-font-semibold);
    }
    .mm-notifications-list {
        max-height: 300px;
        overflow-y: auto;
    }
    .mm-notifications-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--mm-space-2);
        padding: var(--mm-space-6);
        color: var(--mm-text-muted);
    }
    .mm-notification-item {
        display: flex;
        align-items: flex-start;
        gap: var(--mm-space-3);
        padding: var(--mm-space-3) var(--mm-space-4);
        text-decoration: none;
        color: var(--mm-text-primary);
        border-bottom: 1px solid var(--mm-border);
        transition: background var(--mm-transition);
    }
    .mm-notification-item:hover {
        background: var(--mm-bg-secondary);
    }
    .mm-notification-icon {
        width: 32px;
        height: 32px;
        border-radius: var(--mm-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    .mm-notification-danger { background: rgba(239, 68, 68, 0.15); color: var(--mm-danger); }
    .mm-notification-warning { background: rgba(245, 158, 11, 0.15); color: var(--mm-warning); }
    .mm-notification-info { background: rgba(59, 130, 246, 0.15); color: var(--mm-info); }
    .mm-notification-success { background: rgba(34, 197, 94, 0.15); color: var(--mm-success); }
    .mm-notification-content { flex: 1; min-width: 0; }
    .mm-notification-title { font-size: var(--mm-text-sm); font-weight: var(--mm-font-medium); }
    .mm-notification-subtitle { font-size: var(--mm-text-xs); color: var(--mm-text-muted); }
    .mm-notifications-footer {
        padding: var(--mm-space-3) var(--mm-space-4);
        border-top: 1px solid var(--mm-border);
        text-align: center;
    }
    .mm-notifications-footer a {
        color: var(--mm-primary);
        text-decoration: none;
        font-size: var(--mm-text-sm);
    }
    
    .mm-search-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding-top: 15vh;
        opacity: 0;
        visibility: hidden;
        transition: all var(--mm-transition);
    }
    .mm-search-modal.open {
        opacity: 1;
        visibility: visible;
    }
    .mm-search-container {
        width: 100%;
        max-width: 560px;
        background: var(--mm-bg-card);
        border: 1px solid var(--mm-border);
        border-radius: var(--mm-radius-xl);
        box-shadow: var(--mm-shadow-xl);
        overflow: hidden;
        margin: 0 var(--mm-space-4);
    }
    .mm-search-input-wrapper {
        display: flex;
        align-items: center;
        gap: var(--mm-space-3);
        padding: var(--mm-space-4);
        border-bottom: 1px solid var(--mm-border);
    }
    .mm-search-input-wrapper i { color: var(--mm-text-muted); font-size: 1.25rem; }
    .mm-search-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: var(--mm-text-lg);
        color: var(--mm-text-primary);
        outline: none;
    }
    .mm-search-input::placeholder { color: var(--mm-text-muted); }
    .mm-search-input-wrapper kbd {
        background: var(--mm-bg-tertiary);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        color: var(--mm-text-muted);
    }
    .mm-search-results {
        max-height: 400px;
        overflow-y: auto;
    }
    .mm-search-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--mm-space-2);
        padding: var(--mm-space-8);
        color: var(--mm-text-muted);
    }
    .mm-search-result {
        display: flex;
        align-items: center;
        gap: var(--mm-space-3);
        padding: var(--mm-space-3) var(--mm-space-4);
        text-decoration: none;
        color: var(--mm-text-primary);
        transition: background var(--mm-transition);
    }
    .mm-search-result:hover, .mm-search-result.selected {
        background: var(--mm-bg-secondary);
    }
    .mm-search-result.selected {
        background: rgba(var(--mm-primary-rgb), 0.1);
    }
    .mm-search-result-icon {
        width: 36px;
        height: 36px;
        border-radius: var(--mm-radius);
        background: var(--mm-bg-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--mm-primary);
    }
    .mm-search-result-content { flex: 1; min-width: 0; }
    .mm-search-result-title { font-weight: var(--mm-font-medium); }
    .mm-search-result-subtitle { font-size: var(--mm-text-xs); color: var(--mm-text-muted); }
    .mm-search-result-type {
        font-size: var(--mm-text-xs);
        color: var(--mm-text-muted);
        text-transform: capitalize;
        background: var(--mm-bg-tertiary);
        padding: 2px 8px;
        border-radius: 4px;
    }
    .mm-search-footer {
        display: flex;
        gap: var(--mm-space-4);
        padding: var(--mm-space-3) var(--mm-space-4);
        border-top: 1px solid var(--mm-border);
        font-size: var(--mm-text-xs);
        color: var(--mm-text-muted);
    }
    .mm-search-footer kbd {
        background: var(--mm-bg-tertiary);
        padding: 2px 6px;
        border-radius: 3px;
        margin-right: 4px;
    }
    
    @media (max-width: 768px) {
        .mm-notifications-dropdown { width: 280px; right: -60px; }
        .mm-search-container { margin: 0 var(--mm-space-2); }
    }
    
    .mm-skip-link {
        position: absolute;
        top: -100px;
        left: 0;
        background: var(--mm-primary);
        color: #0f172a;
        padding: var(--mm-space-3) var(--mm-space-4);
        z-index: 10000;
        font-weight: var(--mm-font-semibold);
        text-decoration: none;
        border-radius: 0 0 var(--mm-radius) 0;
        transition: top var(--mm-transition);
    }
    .mm-skip-link:focus {
        top: 0;
        outline: 2px solid var(--mm-primary-dark);
        outline-offset: 2px;
    }
    
    .mm-quick-actions {
        display: flex;
        align-items: center;
        gap: var(--mm-space-1);
    }
    .mm-quick-action {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: var(--mm-radius);
        background: transparent;
        color: var(--mm-text-secondary);
        text-decoration: none;
        transition: all var(--mm-transition);
        border: 1px solid transparent;
    }
    .mm-quick-action:hover {
        background: rgba(var(--mm-primary-rgb), 0.1);
        color: var(--mm-primary);
        border-color: rgba(var(--mm-primary-rgb), 0.3);
    }
    .mm-quick-action:focus {
        outline: 2px solid var(--mm-primary);
        outline-offset: 2px;
    }
    .mm-quick-action i { font-size: 1.1rem; }
    
    .mm-topbar-divider {
        width: 1px;
        height: 24px;
        background: var(--mm-border);
        margin: 0 var(--mm-space-2);
    }
    
    .mm-install-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, var(--mm-bg-card) 0%, var(--mm-bg-secondary) 100%);
        border-top: 1px solid var(--mm-border);
        padding: var(--mm-space-3) var(--mm-space-4);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--mm-space-3);
        z-index: 1000;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
        animation: mm-slide-up var(--mm-transition) ease-out;
    }
    .mm-install-content {
        display: flex;
        align-items: center;
        gap: var(--mm-space-3);
        color: var(--mm-text-primary);
    }
    .mm-install-content i {
        font-size: 1.5rem;
        color: var(--mm-primary);
    }
    .mm-install-actions {
        display: flex;
        align-items: center;
        gap: var(--mm-space-2);
    }
    
    @media (max-width: 768px) {
        .mm-install-banner {
            flex-direction: column;
            text-align: center;
        }
    }
    
    *:focus-visible {
        outline: 2px solid var(--mm-primary);
        outline-offset: 2px;
    }
    </style>
    
    <script>
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!localStorage.getItem('pwaInstallDismissed')) {
                document.getElementById('installBanner').style.display = 'flex';
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA instalado');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').style.display = 'none';
                });
            }
        }
        
        function dismissInstall() {
            document.getElementById('installBanner').style.display = 'none';
            localStorage.setItem('pwaInstallDismissed', 'true');
        }
        
        window.addEventListener('appinstalled', () => {
            document.getElementById('installBanner').style.display = 'none';
            deferredPrompt = null;
        });
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then((reg) => {
                if (reg) {
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if (confirm('Nova versão disponível! Deseja atualizar?')) {
                                    newWorker.postMessage('skipWaiting');
                                    window.location.reload();
                                }
                            }
                        });
                    });
                }
            });
        }
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.mm-table[data-sortable="true"]').forEach(function(table) {
            var tbody = table.querySelector('tbody');
            var headers = table.querySelectorAll('thead th');
            var dir = {};
            headers.forEach(function(th, idx) {
                th.setAttribute('tabindex', '0');
                th.setAttribute('role', 'button');
                th.addEventListener('click', function() { sortBy(idx); });
                th.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); sortBy(idx); } });
            });
            function sortBy(colIndex) {
                var rows = Array.from(tbody.querySelectorAll('tr'));
                var asc = !(dir[colIndex] === 'asc');
                rows.sort(function(a, b) {
                    var ta = (a.children[colIndex].textContent || '').trim().toLowerCase();
                    var tb = (b.children[colIndex].textContent || '').trim().toLowerCase();
                    var na = parseFloat(ta.replace(',', '.'));
                    var nb = parseFloat(tb.replace(',', '.'));
                    var isNum = !isNaN(na) && !isNaN(nb);
                    if (isNum) return asc ? na - nb : nb - na;
                    return asc ? ta.localeCompare(tb) : tb.localeCompare(ta);
                });
                rows.forEach(function(r){ tbody.appendChild(r); });
                dir[colIndex] = asc ? 'asc' : 'desc';
                headers.forEach(function(h){ h.removeAttribute('aria-sort'); });
                headers[colIndex].setAttribute('aria-sort', asc ? 'ascending' : 'descending');
            }
        });
    });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
