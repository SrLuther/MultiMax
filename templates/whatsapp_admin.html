{% extends "base.html" %}
{% block title %}Notificações WhatsApp · MultiMax{% endblock %}
{% block breadcrumb %}
    <span aria-hidden="true">/</span>
    <span>Notificações WhatsApp</span>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 py-lg-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
        <div>
            <p class="text-uppercase text-muted small mb-1">Central de notificações</p>
            <h1 class="h3 mb-2">WhatsApp (Baileys local)</h1>
            <p class="text-muted mb-0">Envie alertas diretamente para o gateway local. O MultiMax não conhece nem armazena IDs de grupos.</p>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="badge {% if auto_enabled %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %}">
                Automáticas: {% if auto_enabled %}ativadas{% else %}desativadas{% endif %}
            </span>
            <span class="badge bg-light text-muted border">Endpoint local: {{ gateway_url }}</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <p class="text-uppercase text-muted small mb-1">Bloco A — envio manual</p>
                            <h4 class="mb-2">Disparar mensagem agora</h4>
                            <p class="text-muted mb-0">Entrega imediata para todos os grupos configurados no serviço Baileys. Ignora qualquer bloqueio ou agendamento.</p>
                        </div>
                        <span class="badge bg-primary-subtle text-primary">Envio prioritário</span>
                    </div>
                    <form method="post" action="{{ url_for('whatsapp_admin.enviar') }}" class="d-flex flex-column gap-3">
                        <div class="form-floating">
                            <textarea class="form-control" placeholder="Digite a mensagem" id="mensagem" name="message" style="height: 160px;" required></textarea>
                            <label for="mensagem">Mensagem para o(s) grupo(s)</label>
                        </div>
                        <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
                            <div class="text-muted small">
                                Enviado para todos os grupos mantidos pelo serviço local. O MultiMax não envia IDs nem escolhe grupos.
                            </div>
                            <button type="submit" class="btn btn-success px-4">
                                <i class="bi bi-send me-1"></i> Enviar mensagem
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-5">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-body p-4 d-flex flex-column">
                    <p class="text-uppercase text-muted small mb-1">Bloco B — controle automático</p>
                    <h4 class="mb-2">Notificações automáticas do sistema</h4>
                    <p class="text-muted">Ligue ou pause envios gerados por automações (estoque, rotinas, futuros bots). O envio manual permanece sempre liberado.</p>

                    <form method="post" action="{{ url_for('whatsapp_admin.toggle_auto') }}" class="mt-3">
                        <input type="hidden" name="auto_enabled" value="off">
                        <div class="form-check form-switch fs-5 mb-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="autoSwitch" name="auto_enabled" value="on" {% if auto_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="autoSwitch">Ativar notificações automáticas</label>
                        </div>
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="bi bi-save me-1"></i> Salvar estado
                            </button>
                            <span class="badge {% if auto_enabled %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %}">
                                Estado atual: {% if auto_enabled %}Ativado{% else %}Desativado{% endif %}
                            </span>
                        </div>
                    </form>

                    <div class="alert alert-info mt-4 mb-0" role="alert">
                        <div class="d-flex align-items-start gap-2">
                            <i class="bi bi-shield-lock text-info fs-5"></i>
                            <div class="small text-muted">
                                Acesso restrito a DEV. O endpoint local ({{ gateway_url }}) concentra toda lógica de entrega e grupos. Se desligado, nenhuma automação enviará mensagens.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
