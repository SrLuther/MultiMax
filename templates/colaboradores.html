{% extends 'base.html' %}
{% block title %}MultiMax{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Colaboradores</h3>
  {% if current_user.nivel in ('operador','admin') %}
  <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#novoColaborador">Novo</button>
  {% endif %}
</div>

<div class="table-responsive-sm">
  <table class="table table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Nome</th>
        <th>Cargo</th>
        <th>Equipe 1/2</th>
        <th>Domingo 1/2</th>
        <th>Especial 1/2</th>
        <th>Banco</th>
        <th>Status</th>
        <th class="text-end" style="width: 14rem">Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for c in colaboradores %}
      <tr>
        <td>{{ c.name }}</td>
        <td>{{ c.role or '-' }}</td>
        <td>{{ c.regular_team or '-' }}</td>
        <td>{{ c.sunday_team or '-' }}</td>
        <td>{{ c.special_team or '-' }}</td>
        {% set saldo = (bank_balances.get(c.id) or 0.0) %}
        {% set cls = 'text-bg-secondary' %}
        {% if saldo > 0 %}{% set cls = 'text-bg-success' %}{% elif saldo < 0 %}{% set cls = 'text-bg-danger' %}{% endif %}
        <td><span class="badge {{ cls }}">{{ '%.2f'|format(saldo) }}h</span></td>
        <td>{% if c.active %}<span class="badge text-bg-success">Ativo</span>{% else %}<span class="badge text-bg-secondary">Inativo</span>{% endif %}</td>
        <td class="text-end">
          {% if current_user.nivel in ('operador','admin') %}
          <form method="post" action="{{ url_for('colaboradores.editar_colaborador', id=c.id) }}" class="d-inline-flex gap-2 align-items-center">
            <input type="text" name="name" class="form-control form-control-sm" placeholder="Nome" value="{{ c.name }}" style="width: 10rem">
            <input type="text" name="role" class="form-control form-control-sm" placeholder="Cargo" value="{{ c.role }}" style="width: 8rem">
            <select name="regular_team" class="form-select form-select-sm" style="width: 6rem">
              <option value="">Eq 1/2</option>
              <option value="1" {% if c.regular_team == '1' %}selected{% endif %}>1</option>
              <option value="2" {% if c.regular_team == '2' %}selected{% endif %}>2</option>
            </select>
            <select name="sunday_team" class="form-select form-select-sm" style="width: 6rem">
              <option value="">Dom 1/2</option>
              <option value="1" {% if c.sunday_team == '1' %}selected{% endif %}>1</option>
              <option value="2" {% if c.sunday_team == '2' %}selected{% endif %}>2</option>
            </select>
            <select name="special_team" class="form-select form-select-sm" style="width: 6rem">
              <option value="">Esp 1/2</option>
              <option value="1" {% if c.special_team == '1' %}selected{% endif %}>1</option>
              <option value="2" {% if c.special_team == '2' %}selected{% endif %}>2</option>
            </select>
            <div class="form-check form-check-sm">
              <input class="form-check-input" type="checkbox" name="active" {% if c.active %}checked{% endif %}>
              <label class="form-check-label">Ativo</label>
            </div>
            <button class="btn btn-primary btn-sm" type="submit">Salvar</button>
          </form>
          {% endif %}
          {% if current_user.nivel == 'admin' %}
          <form method="post" action="{{ url_for('colaboradores.excluir_colaborador', id=c.id) }}" class="d-inline" onsubmit="return confirm('Excluir {{ c.name }}?')">
            <button class="btn btn-danger btn-sm" type="submit">Excluir</button>
          </form>
          {% endif %}
        </td>
      </tr>
        {% endfor %}
        {% if colaboradores|length == 0 %}
      <tr><td colspan="7" class="text-center text-muted">Nenhum colaborador</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

{% if current_user.nivel in ('operador','admin') %}
<div class="card mt-4">
  <div class="card-header">Banco de Horas</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('colaboradores.horas_adicionar') }}" class="row g-2 mb-3">
      <div class="col-md-3">
        <label class="form-label">Colaborador</label>
        <select name="collaborator_id" class="form-select" required>
          {% for c in colaboradores %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Data</label>
        <input type="date" name="date" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Horas (+/-)</label>
        <input type="number" name="hours" step="0.25" class="form-control" placeholder="ex: 2 ou -1" required>
      </div>
      <div class="col-md-5">
        <label class="form-label">Motivo</label>
        <input type="text" name="reason" class="form-control" placeholder="Motivo do lançamento">
      </div>
      <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-primary" type="submit">Registrar</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Data</th>
            <th>Colaborador</th>
            <th class="text-end">Horas</th>
            <th>Motivo</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for e in recent_entries %}
          {% set col = colaboradores|selectattr('id', 'equalto', e.collaborator_id)|list|first %}
          <tr>
            <td>{{ e.date.strftime('%d/%m/%Y') }}</td>
            <td>{{ col and col.name or ('ID ' ~ e.collaborator_id) }}</td>
            <td class="text-end">{{ '%.2f'|format(e.hours) }}h</td>
            <td>{{ e.reason or '-' }}</td>
            <td class="text-end">
              {% if current_user.nivel == 'admin' %}
              <form method="post" action="{{ url_for('colaboradores.horas_excluir', id=e.id) }}" class="d-inline" onsubmit="return confirm('Excluir lançamento?')">
                <button class="btn btn-sm btn-danger" type="submit">Excluir</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-center text-muted">Sem lançamentos</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}

<div class="modal fade" id="novoColaborador" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('colaboradores.criar_colaborador') }}">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Novo Colaborador</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Nome</label>
          <input type="text" name="name" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Cargo</label>
          <input type="text" name="role" class="form-control">
        </div>
        
        <div class="mb-2">
          <label class="form-label">Equipe 1/2</label>
          <select name="regular_team" class="form-select">
            <option value="">—</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Equipe Domingo 1/2</label>
          <select name="sunday_team" class="form-select">
            <option value="">—</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Equipe Especial 1/2</label>
          <select name="special_team" class="form-select">
            <option value="">—</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </div>
        
      </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-success" type="submit">Criar</button>
        </div>
      </div>
    </form>
  </div>
{% endblock %}
