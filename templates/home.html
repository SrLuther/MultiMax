{% extends 'base.html' %}
{% block title %}Dashboard — MultiMax{% endblock %}

{% block breadcrumb %}
<span class="mm-breadcrumb-separator">/</span>
<span>Dashboard</span>
{% endblock %}

{% block content %}
<div class="mm-animate-fade-in">
    <div class="mm-flex mm-items-center mm-justify-between mm-mb-6">
        <div>
            <h1 class="mm-m-0" style="font-size: var(--mm-text-2xl); font-weight: var(--mm-font-bold); color: var(--mm-text-primary);">
                Dashboard
            </h1>
            <p class="mm-text-muted mm-m-0" style="margin-top: var(--mm-space-1);">
                Visão geral do sistema
            </p>
        </div>
        <div class="mm-flex mm-gap-2">
            <a href="{{ url_for('estoque.index') }}" class="mm-btn mm-btn-primary">
                <i class="bi bi-plus-lg"></i>
                Ver Estoque
            </a>
        </div>
    </div>

    <div class="mm-grid mm-grid-cols-4 mm-gap-4 mm-mb-6">
        <div class="mm-card mm-kpi-card mm-animate-slide-up" style="--delay: 0.1s; animation-delay: var(--delay);">
            <div class="mm-kpi-label">Produtos Cadastrados</div>
            <div class="mm-kpi-value mm-text-primary">{{ metrics.total_produtos }}</div>
            <div class="mm-flex mm-items-center mm-gap-2">
                <i class="bi bi-box-seam" style="color: var(--mm-primary); font-size: 1.5rem;"></i>
            </div>
        </div>
        
        <div class="mm-card mm-kpi-card mm-animate-slide-up" style="--delay: 0.2s; animation-delay: var(--delay);">
            <div class="mm-kpi-label">Estoque Baixo</div>
            <div class="mm-kpi-value" style="color: var(--mm-danger);">{{ metrics.produtos_baixo_estoque }}</div>
            <div class="mm-flex mm-items-center mm-gap-2">
                <span class="mm-kpi-trend down">
                    <i class="bi bi-exclamation-triangle"></i>
                    Atenção
                </span>
            </div>
        </div>
        
        <div class="mm-card mm-kpi-card mm-animate-slide-up" style="--delay: 0.3s; animation-delay: var(--delay);">
            <div class="mm-kpi-label">Valor em Estoque</div>
            <div class="mm-kpi-value" style="color: var(--mm-info);">R$ {{ "%.2f"|format(metrics.valor_total_estoque) }}</div>
            <div class="mm-flex mm-items-center mm-gap-2">
                <i class="bi bi-currency-dollar" style="color: var(--mm-info); font-size: 1.5rem;"></i>
            </div>
        </div>
        
        <div class="mm-card mm-kpi-card mm-animate-slide-up" style="--delay: 0.4s; animation-delay: var(--delay);">
            <div class="mm-kpi-label">Movimentações Hoje</div>
            <div class="mm-kpi-value" style="color: var(--mm-warning);">{{ metrics.movimentacoes_hoje }}</div>
            <div class="mm-flex mm-items-center mm-gap-2">
                <i class="bi bi-arrow-left-right" style="color: var(--mm-warning); font-size: 1.5rem;"></i>
            </div>
        </div>
    </div>

    <div class="mm-grid mm-grid-cols-4 mm-gap-4 mm-mb-6">
        <div class="mm-card mm-animate-slide-up" style="text-align: center;">
            <div class="mm-text-danger" style="font-size: var(--mm-text-3xl); font-weight: var(--mm-font-bold);">
                {{ metrics.tarefas_atrasadas }}
            </div>
            <div class="mm-text-muted" style="font-size: var(--mm-text-sm);">Tarefas Atrasadas</div>
        </div>
        
        <div class="mm-card mm-animate-slide-up" style="text-align: center;">
            <div style="font-size: var(--mm-text-3xl); font-weight: var(--mm-font-bold); color: var(--mm-warning);">
                {{ metrics.tarefas_proximas }}
            </div>
            <div class="mm-text-muted" style="font-size: var(--mm-text-sm);">Tarefas Próximas</div>
        </div>
        
        <div class="mm-card mm-animate-slide-up" style="text-align: center;">
            <div style="font-size: var(--mm-text-3xl); font-weight: var(--mm-font-bold); color: var(--mm-success);">
                {{ metrics.colaboradores_ativos }}
            </div>
            <div class="mm-text-muted" style="font-size: var(--mm-text-sm);">Colaboradores Ativos</div>
        </div>
        
        <div class="mm-card mm-animate-slide-up" style="text-align: center;">
            <div class="mm-flex mm-justify-between" style="justify-content: center; gap: var(--mm-space-6);">
                <div>
                    <span style="color: var(--mm-success); font-weight: var(--mm-font-bold); font-size: var(--mm-text-xl);">+{{ metrics.entradas_mes }}</span>
                    <div class="mm-text-muted" style="font-size: var(--mm-text-xs);">Entradas</div>
                </div>
                <div>
                    <span style="color: var(--mm-danger); font-weight: var(--mm-font-bold); font-size: var(--mm-text-xl);">-{{ metrics.saidas_mes }}</span>
                    <div class="mm-text-muted" style="font-size: var(--mm-text-xs);">Saídas</div>
                </div>
            </div>
            <div class="mm-text-muted" style="font-size: var(--mm-text-xs); margin-top: var(--mm-space-2);">Este Mês</div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="mm-card">
                <div class="mm-card-header">
                    <h3 class="mm-card-title">
                        <i class="bi bi-bar-chart me-2"></i>
                        Movimentações - Últimos 7 Dias
                    </h3>
                </div>
                <div class="mm-card-body">
                    <canvas id="chartMovimentacoes" style="min-height: 280px;"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="mm-card h-100">
                <div class="mm-card-header">
                    <h3 class="mm-card-title">
                        <i class="bi bi-exclamation-diamond me-2" style="color: var(--mm-danger);"></i>
                        Estoque Crítico
                    </h3>
                    <a href="{{ url_for('estoque.index') }}" class="mm-btn mm-btn-sm mm-btn-outline">Ver Todos</a>
                </div>
                <div class="mm-card-body" style="padding: 0;">
                    {% if low_stock %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for item in low_stock %}
                        <div class="mm-flex mm-items-center mm-justify-between" style="padding: var(--mm-space-3) var(--mm-space-4); border-bottom: 1px solid var(--mm-border);">
                            <span style="max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ item.nome }}</span>
                            <span class="mm-badge {% if item.quantidade == 0 %}mm-badge-danger{% else %}mm-badge-warning{% endif %}">
                                {{ item.quantidade }}/{{ item.minimo }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="padding: var(--mm-space-6); text-align: center;">
                        <i class="bi bi-check-circle" style="font-size: 3rem; color: var(--mm-success);"></i>
                        <div class="mm-text-muted" style="margin-top: var(--mm-space-2);">Estoque em dia!</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="mm-card">
                <div class="mm-card-header">
                    <h3 class="mm-card-title">
                        <i class="bi bi-megaphone me-2" style="color: var(--mm-warning);"></i>
                        Quadro de Avisos
                    </h3>
                    {% if current_user.nivel == 'admin' %}
                    <button class="mm-btn mm-btn-sm mm-btn-outline" data-bs-toggle="modal" data-bs-target="#modalEditarMural">
                        <i class="bi bi-pencil"></i>
                        Editar
                    </button>
                    {% endif %}
                </div>
                <div class="mm-card-body">
                    {% if mural_html and mural_html|length > 0 %}
                    <div class="mural-content">{{ mural_html|safe }}</div>
                    {% else %}
                    <div class="mm-text-muted" style="text-align: center; padding: var(--mm-space-4);">
                        Sem avisos no momento
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="mm-card">
                <div class="mm-card-header">
                    <h3 class="mm-card-title">
                        <i class="bi bi-bell me-2" style="color: var(--mm-info);"></i>
                        Notificações
                    </h3>
                    {% if current_user.nivel == 'admin' %}
                    <a class="mm-btn mm-btn-sm mm-btn-ghost" href="{{ url_for('usuarios.notifications_read_all') }}?next={{ url_for('home.index') }}">
                        Marcar todas
                    </a>
                    {% endif %}
                </div>
                <div class="mm-card-body" style="padding: 0;">
                    {% if notifications %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for n in notifications[:5] %}
                        <div class="mm-flex mm-items-center mm-gap-4" style="padding: var(--mm-space-3) var(--mm-space-4); border-bottom: 1px solid var(--mm-border);">
                            <span style="font-size: 1.5rem;">{{ n.emoji }}</span>
                            <div style="flex: 1;">
                                <a href="{{ n.url }}" style="text-decoration: none; color: var(--mm-text-primary); font-weight: var(--mm-font-medium);">
                                    {{ n.title }}
                                </a>
                                {% if n.subtitle %}
                                <div class="mm-text-muted" style="font-size: var(--mm-text-sm);">{{ n.subtitle }}</div>
                                {% endif %}
                            </div>
                            {% if current_user.nivel == 'admin' and n.id and n.type in ['estoque','limpeza'] %}
                            <a class="mm-btn mm-btn-sm mm-btn-ghost" href="{{ url_for('usuarios.notifications_read') }}?tipo={{ n.type }}&id={{ n.id }}&next={{ url_for('home.index') }}" style="color: var(--mm-success);">
                                <i class="bi bi-check-lg"></i>
                            </a>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="mm-text-muted" style="text-align: center; padding: var(--mm-space-6);">
                        <i class="bi bi-bell-slash" style="font-size: 2rem; opacity: 0.5;"></i>
                        <div style="margin-top: var(--mm-space-2);">Sem notificações</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.nivel == 'admin' %}
<div class="modal fade" id="modalEditarMural">
    <div class="modal-dialog modal-lg">
        <form method="post" action="{{ url_for('home.update_mural') }}">
            <div class="modal-content" style="background: var(--mm-bg-card); border: 1px solid var(--mm-border); border-radius: var(--mm-radius-xl);">
                <div class="modal-header" style="border-bottom: 1px solid var(--mm-border);">
                    <h5 class="modal-title" style="color: var(--mm-text-primary);">Editar Quadro de Avisos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea class="mm-input" name="mural_text" rows="8" placeholder="Escreva o aviso...">{{ mural_text }}</textarea>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--mm-border);">
                    <button type="button" class="mm-btn mm-btn-ghost" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="mm-btn mm-btn-primary">Salvar</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('chartMovimentacoes');
    if (ctx) {
        const chartData = {{ chart_data | tojson }};
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Entradas',
                        data: chartData.entradas,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: 'rgba(0, 255, 136, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    },
                    {
                        label: 'Saídas',
                        data: chartData.saidas,
                        backgroundColor: 'rgba(239, 68, 68, 0.7)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: isDark ? '#cbd5e1' : '#475569',
                            font: { family: 'Inter', weight: '500' }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' },
                        ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: isDark ? '#94a3b8' : '#64748b' }
                    }
                }
            }
        });
    }
});
</script>

<style>
.mural-content {
    background: rgba(251, 191, 36, 0.1);
    border: 1px solid rgba(251, 191, 36, 0.3);
    border-radius: var(--mm-radius-lg);
    padding: var(--mm-space-4);
    color: var(--mm-text-primary);
}

[data-theme="dark"] .mural-content {
    background: rgba(251, 191, 36, 0.15);
    border-color: rgba(251, 191, 36, 0.25);
}
</style>
{% endblock %}
