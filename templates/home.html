{% extends 'base.html' %}
{% block title %}Home — MultiMax{% endblock %}
{% block content %}
<div class="mb-3">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Quadro de Avisos</span>
      {% if current_user.nivel == 'admin' %}
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarMural">Editar Quadro</button>
      {% endif %}
    </div>
    <div class="card-body">
      {% if mural_html and mural_html|length > 0 %}
      <div class="mural-content">{{ mural_html|safe }}</div>
      {% else %}
      <div class="text-muted">Sem aviso</div>
      {% endif %}
    </div>
  </div>
  {% if current_user.nivel == 'admin' %}
  <div class="modal fade" id="modalEditarMural">
    <div class="modal-dialog modal-lg">
      <form id="formEditarMural" method="post" action="{{ url_for('home.update_mural') }}">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Quadro de Avisos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea class="form-control" name="mural_text" id="mural_text" rows="8" placeholder="Escreva o aviso. Texto simples.">{{ mural_text }}</textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
  </div>

<div class="card">
  <div class="card-header">Calendário do Sistema</div>
  <div class="card-body">
    <div id="calendar" style="min-height: 600px"></div>
    <script id="events-data" type="application/json">{{ events|tojson|safe }}</script>
  </div>
  <div class="card-footer">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <span class="badge" style="background:#0d6efd">Estoque</span>
      <span class="badge" style="background:#20c997">Limpeza prevista</span>
      <span class="badge" style="background:#198754">Limpeza concluída</span>
      <span class="badge" style="background:#6c757d">Carnes</span>
      <span class="badge" style="background:#6610f2">Sistema</span>
      <span class="badge" style="background:#dc3545">Feriados</span>
    </div>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js"></script>
<script>
  (function(){
    // nenhuma lógica adicional para formatação; texto simples
    var el = document.getElementById('calendar');
    var events = JSON.parse((document.getElementById('events-data')?.textContent) || '[]');
    events = (events || []).map(function(e){ return {
      title: e.title,
      start: e.start,
      end: e.end || null,
      color: e.color || '#0d6efd',
      url: e.url || null,
    }; });
    var calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'pt-br',
      height: 'auto',
      dayMaxEvents: 2,
      moreLinkClick: 'popover',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'viewsMenu'
      },
      customButtons: {
        viewsMenu: {
          text: 'Visualizações ▾',
          click: function(){
            var menu = el.querySelector('#fc-views-menu');
            if(menu){ menu.classList.toggle('show'); }
          }
        }
      },
      buttonText: {
        today: 'Hoje',
        month: 'Mês',
        week: 'Semana',
        day: 'Dia',
        list: 'Lista',
        listDay: 'Dia (lista)',
        listMonth: 'Mês (lista)'
      },
      events: events,
      dateClick: function(info){
        calendar.changeView('listDay', info.dateStr);
      },
      eventClick: function(info){
        if(info.event && info.event.url){
          info.jsEvent.preventDefault();
          window.location.href = info.event.url;
        }
      }
    });
    calendar.render();
    // criar menu de visualizações como dropdown dentro do cabeçalho do calendário
    (function(){
      var btn = el.querySelector('.fc-viewsMenu-button');
      if(!btn) return;
      var parent = btn.parentElement;
      if(parent) parent.style.position = 'relative';
      if(el.querySelector('#fc-views-menu')) return;
      var menu = document.createElement('div');
      menu.id = 'fc-views-menu';
      menu.className = 'dropdown-menu';
      menu.style.minWidth = '180px';
      menu.style.position = 'absolute';
      menu.style.right = '0';
      menu.style.top = 'calc(100% + 4px)';
      menu.innerHTML = [
        {label: 'Mês', view: 'dayGridMonth'},
        {label: 'Semana', view: 'timeGridWeek'},
        {label: 'Dia', view: 'timeGridDay'},
        {label: 'Lista (Dia)', view: 'listDay'},
        {label: 'Lista (Mês)', view: 'listMonth'},
      ].map(function(it){ return '<button type="button" class="dropdown-item" data-view="'+it.view+'">'+it.label+'</button>'; }).join('');
      parent.appendChild(menu);
      menu.querySelectorAll('[data-view]').forEach(function(item){
        item.addEventListener('click', function(ev){
          var v = ev.currentTarget.getAttribute('data-view');
          if(v){ calendar.changeView(v); }
          menu.classList.remove('show');
        });
      });
      document.addEventListener('click', function(e){
        if(!parent.contains(e.target)){
          menu.classList.remove('show');
        }
      });
    })();
  })();
</script>
{% endblock %}
