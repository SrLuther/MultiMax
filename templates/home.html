{% extends 'base.html' %}
{% block title %}Home — MultiMax{% endblock %}
{% block content %}
<div class="mb-3">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Mural</span>
      {% if current_user.nivel == 'admin' %}
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditarMural">Editar Mural</button>
      {% endif %}
    </div>
    <div class="card-body">
      {% if mural_html and mural_html|length > 0 %}
      <div class="mural-content">{{ mural_html|safe }}</div>
      {% else %}
      <div class="text-muted">Sem aviso</div>
      {% endif %}
    </div>
  </div>
  {% if current_user.nivel == 'admin' %}
  <div class="modal fade" id="modalEditarMural">
    <div class="modal-dialog modal-lg">
      <form id="formEditarMural" method="post" action="{{ url_for('home.update_mural') }}">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Mural</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea class="form-control" name="mural_text" id="mural_text" rows="8" placeholder="Escreva o aviso. Texto simples.">{{ mural_text }}</textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
  </div>

<div class="card">
  <div class="card-header">Calendário do Sistema</div>
  <div class="card-body">
    <div id="calendar" style="min-height: 600px"></div>
    <script id="events-data" type="application/json">{{ events|tojson|safe }}</script>
  </div>
  <div class="card-footer">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <span class="badge" style="background:#0d6efd">Estoque</span>
      <span class="badge" style="background:#20c997">Limpeza prevista</span>
      <span class="badge" style="background:#198754">Limpeza concluída</span>
      <span class="badge" style="background:#6c757d">Carnes</span>
      <span class="badge" style="background:#6610f2">Sistema</span>
    </div>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.global.min.js"></script>
<script>
  (function(){
    // nenhuma lógica adicional para formatação; texto simples
    var el = document.getElementById('calendar');
    var events = JSON.parse((document.getElementById('events-data')?.textContent) || '[]');
    events = (events || []).map(function(e){ return {
      title: e.title,
      start: e.start,
      end: e.end || null,
      color: e.color || '#0d6efd',
      url: e.url || null,
    }; });
    var calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'pt-br',
      height: 'auto',
      dayMaxEvents: 2,
      moreLinkClick: 'popover',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listDay,listMonth'
      },
      buttonText: {
        today: 'Hoje',
        month: 'Mês',
        week: 'Semana',
        day: 'Dia',
        list: 'Lista',
        listDay: 'Dia (lista)',
        listMonth: 'Mês (lista)'
      },
      events: events,
      dateClick: function(info){
        calendar.changeView('listDay', info.dateStr);
      },
      eventClick: function(info){
        if(info.event && info.event.url){
          info.jsEvent.preventDefault();
          window.location.href = info.event.url;
        }
      }
    });
    calendar.render();
  })();
</script>
{% endblock %}
