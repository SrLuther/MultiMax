{% extends 'base.html' %}
{% block title %}MultiMax{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Gráficos por Produto</h3>
  <a class="btn btn-outline-secondary" href="{{ url_for('usuarios.graficos') }}">Limpar</a>
  {% if produto %}
  <a class="btn btn-outline-danger ms-2" href="{{ url_for('exportacao.exportar_graficos_produto', id=produto.id, data_inicio=data_inicio, data_fim=data_fim) }}" data-pdf-export>
    Exportar PDF
  </a>
  {% endif %}
</div>

<form class="row g-3 mb-4" method="get" action="{{ url_for('usuarios.graficos') }}">
  <div class="col-md-6">
    <input type="search" name="q" value="{{ q or '' }}" class="form-control" placeholder="Buscar por Código ou Nome">
  </div>
  <div class="col-md-6 d-flex gap-2">
    <input type="date" name="data_inicio" value="{{ data_inicio or '' }}" class="form-control" placeholder="Data Inicial">
    <input type="date" name="data_fim" value="{{ data_fim or '' }}" class="form-control" placeholder="Data Final">
    <button class="btn btn-primary" type="submit">Buscar</button>
  </div>
</form>

{% if resultados and not produto %}
  <div class="alert alert-warning">{{ resultados|length }} resultado(s) encontrados. Selecione um:</div>
  <div class="list-group mb-4">
    {% for r in resultados %}
    <a class="list-group-item list-group-item-action" href="{{ url_for('usuarios.graficos', produto_id=r.id, data_inicio=data_inicio, data_fim=data_fim) }}">
      <strong>{{ r.codigo }}</strong> — {{ r.nome }}
    </a>
    {% endfor %}
  </div>
{% endif %}

{% if produto %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">{{ produto.nome }}</h5>
          <small class="text-muted">Código: {{ produto.codigo }}</small>
        </div>
        <div class="text-end">
          <span class="badge bg-dark">Estoque: {{ produto.quantidade }}</span>
          <span class="badge bg-secondary">Mínimo: {{ produto.estoque_minimo }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Semanal (Últimas 8 semanas)</div>
        <div class="card-body">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6">
              <div style="height:260px"><canvas id="chartWeekly"></canvas></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Período</th>
                      <th class="text-end">Entradas</th>
                      <th class="text-end">Saídas</th>
                    </tr>
                  </thead>
                  <tbody id="tableWeeklyBody"></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Mensal (Últimos 12 meses)</div>
        <div class="card-body">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6">
              <div style="height:260px"><canvas id="chartMonthly"></canvas></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Período</th>
                      <th class="text-end">Entradas</th>
                      <th class="text-end">Saídas</th>
                    </tr>
                  </thead>
                  <tbody id="tableMonthlyBody"></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Anual (Últimos 5 anos)</div>
        <div class="card-body">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6">
              <div style="height:260px"><canvas id="chartYearly"></canvas></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Período</th>
                      <th class="text-end">Entradas</th>
                      <th class="text-end">Saídas</th>
                    </tr>
                  </thead>
                  <tbody id="tableYearlyBody"></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Período Personalizado</div>
        <div class="card-body">
          <div class="row g-3 align-items-start">
            <div class="col-12 col-md-6">
              <div style="height:260px"><canvas id="chartCustom"></canvas></div>
            </div>
            <div class="col-12 col-md-6">
              <div class="table-responsive">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th>Período</th>
                      <th class="text-end">Entradas</th>
                      <th class="text-end">Saídas</th>
                    </tr>
                  </thead>
                  <tbody id="tableCustomBody"></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="alert alert-info">Busque um produto pelo código ou nome para visualizar os gráficos.</div>
{% endif %}

<div id="chartsDataHolder" data-json='{{ charts|tojson if charts else none|tojson }}' style="display:none"></div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const chartsDataEl = document.getElementById('chartsDataHolder');
  const chartsData = chartsDataEl ? JSON.parse(chartsDataEl.dataset.json || 'null') : null;
  function makeTable(bodyId, labels, entradas, saidas) {
    const body = document.getElementById(bodyId);
    if (!body) return;
    body.textContent = '';
    let sumE = 0, sumS = 0;
    const n = Math.max(labels.length, entradas.length, saidas.length);
    for (let i = 0; i < n; i++) {
      const tr = document.createElement('tr');
      const tdL = document.createElement('td');
      tdL.textContent = (labels[i] ?? '-');
      const tdE = document.createElement('td');
      tdE.className = 'text-end';
      const eVal = Number(entradas[i] ?? 0);
      tdE.textContent = eVal.toString();
      const tdS = document.createElement('td');
      tdS.className = 'text-end';
      const sVal = Number(saidas[i] ?? 0);
      tdS.textContent = sVal.toString();
      tr.appendChild(tdL);
      tr.appendChild(tdE);
      tr.appendChild(tdS);
      body.appendChild(tr);
      sumE += eVal;
      sumS += sVal;
    }
    const table = body.parentElement;
    const tfoot = table ? table.querySelector('tfoot') : null;
    if (tfoot) {
      tfoot.textContent = '';
      const trf = document.createElement('tr');
      trf.className = 'table-light';
      const tdT = document.createElement('td');
      tdT.textContent = 'Total';
      const tdTE = document.createElement('td');
      tdTE.className = 'text-end';
      tdTE.textContent = sumE.toString();
      const tdTS = document.createElement('td');
      tdTS.className = 'text-end';
      tdTS.textContent = sumS.toString();
      trf.appendChild(tdT);
      trf.appendChild(tdTE);
      trf.appendChild(tdTS);
      tfoot.appendChild(trf);
    }
  }
  function makeBarChart(canvasId, labels, entradas, saidas) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    const data = {
      labels: labels || [],
      datasets: [
        {
          label: 'Entradas',
          data: (entradas || []).map(v => Number(v || 0)),
          backgroundColor: '#0d6efd',
          borderColor: '#0b5ed7',
          borderWidth: 1,
        },
        {
          label: 'Saídas',
          data: (saidas || []).map(v => Number(v || 0)),
          backgroundColor: '#dc3545',
          borderColor: '#bb2d3b',
          borderWidth: 1,
        },
      ],
    };
    const valueLabelPlugin = {
      id: 'valueLabelPlugin',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const { ctx } = chart;
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bs-body-color') || '#000';
        chart.data.datasets.forEach((dataset, i) => {
          const meta = chart.getDatasetMeta(i);
          meta.data.forEach((bar, index) => {
            const val = dataset.data[index];
            if (val === undefined || val === null) return;
            const x = bar.x;
            const y = bar.y;
            ctx.fillText(String(val), x, y - 2);
          });
        });
        ctx.restore();
      }
    };
    new Chart(ctx, {
      type: 'bar',
      data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        },
        plugins: {
          legend: { position: 'top' },
          tooltip: { enabled: true },
        }
      },
      plugins: [valueLabelPlugin],
    });
  }
  if (chartsData) {
    makeTable('tableWeeklyBody', chartsData.weekly.labels, chartsData.weekly.entrada, chartsData.weekly.saida);
    makeTable('tableMonthlyBody', chartsData.monthly.labels, chartsData.monthly.entrada, chartsData.monthly.saida);
    makeTable('tableYearlyBody', chartsData.yearly.labels, chartsData.yearly.entrada, chartsData.yearly.saida);
    makeTable('tableCustomBody', chartsData.custom.labels, chartsData.custom.entrada, chartsData.custom.saida);
    makeBarChart('chartWeekly', chartsData.weekly.labels, chartsData.weekly.entrada, chartsData.weekly.saida);
    makeBarChart('chartMonthly', chartsData.monthly.labels, chartsData.monthly.entrada, chartsData.monthly.saida);
    makeBarChart('chartYearly', chartsData.yearly.labels, chartsData.yearly.entrada, chartsData.yearly.saida);
    makeBarChart('chartCustom', chartsData.custom.labels, chartsData.custom.entrada, chartsData.custom.saida);
  }
</script>
{% endblock %}
