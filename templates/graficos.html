{% extends 'base.html' %}
{% block title %}Gráficos — MultiMax{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Gráficos por Produto</h3>
  <a class="btn btn-outline-secondary" href="{{ url_for('usuarios.graficos') }}">Limpar</a>
  {% if produto %}
  <a class="btn btn-outline-danger ms-2" href="{{ url_for('exportacao.exportar_graficos_produto', id=produto.id, data_inicio=data_inicio, data_fim=data_fim) }}">
    Exportar PDF
  </a>
  {% endif %}
</div>

<form class="row g-3 mb-4" method="get" action="{{ url_for('usuarios.graficos') }}">
  <div class="col-md-6">
    <input type="search" name="q" value="{{ q or '' }}" class="form-control" placeholder="Buscar por Código ou Nome">
  </div>
  <div class="col-md-6 d-flex gap-2">
    <input type="date" name="data_inicio" value="{{ data_inicio or '' }}" class="form-control" placeholder="Data Inicial">
    <input type="date" name="data_fim" value="{{ data_fim or '' }}" class="form-control" placeholder="Data Final">
    <button class="btn btn-primary" type="submit">Buscar</button>
  </div>
</form>

{% if resultados and not produto %}
  <div class="alert alert-warning">{{ resultados|length }} resultado(s) encontrados. Selecione um:</div>
  <div class="list-group mb-4">
    {% for r in resultados %}
    <a class="list-group-item list-group-item-action" href="{{ url_for('usuarios.graficos', produto_id=r.id, data_inicio=data_inicio, data_fim=data_fim) }}">
      <strong>{{ r.codigo }}</strong> — {{ r.nome }}
    </a>
    {% endfor %}
  </div>
{% endif %}

{% if produto %}
  <div class="card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="card-title mb-1">{{ produto.nome }}</h5>
          <small class="text-muted">Código: {{ produto.codigo }}</small>
        </div>
        <div class="text-end">
          <span class="badge bg-dark">Estoque: {{ produto.quantidade }}</span>
          <span class="badge bg-secondary">Mínimo: {{ produto.estoque_minimo }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Semanal (Últimas 8 semanas)</div>
        <div class="card-body"><canvas id="chartWeekly"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Mensal (Últimos 12 meses)</div>
        <div class="card-body"><canvas id="chartMonthly"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Anual (Últimos 5 anos)</div>
        <div class="card-body"><canvas id="chartYearly"></canvas></div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header fw-bold">Período Personalizado</div>
        <div class="card-body"><canvas id="chartCustom"></canvas></div>
      </div>
    </div>
  </div>
{% else %}
  <div class="alert alert-info">Busque um produto pelo código ou nome para visualizar os gráficos.</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const chartsData = {{ charts|tojson if charts else 'null' }};
  function makeChart(ctxId, labels, entradas, saidas, title) {
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Entradas',
            data: entradas,
            backgroundColor: 'rgba(22, 163, 74, 0.6)',
            borderColor: 'rgba(22, 163, 74, 1)',
            borderWidth: 1,
          },
          {
            label: 'Saídas',
            data: saidas,
            backgroundColor: 'rgba(234, 179, 8, 0.6)',
            borderColor: 'rgba(234, 179, 8, 1)',
            borderWidth: 1,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          title: { display: false, text: title }
        },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }
  if (chartsData) {
    makeChart('chartWeekly', chartsData.weekly.labels, chartsData.weekly.entrada, chartsData.weekly.saida, 'Semanal');
    makeChart('chartMonthly', chartsData.monthly.labels, chartsData.monthly.entrada, chartsData.monthly.saida, 'Mensal');
    makeChart('chartYearly', chartsData.yearly.labels, chartsData.yearly.entrada, chartsData.yearly.saida, 'Anual');
    makeChart('chartCustom', chartsData.custom.labels, chartsData.custom.entrada, chartsData.custom.saida, 'Personalizado');
  }
</script>
{% endblock %}
