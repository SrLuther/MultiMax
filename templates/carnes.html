{% extends 'base.html' %}
{% block title %}Carnes — MultiMax{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Recepção de Carnes</h3>
  {% if not nova %}
  <a class="btn btn-success" href="{{ url_for('carnes.nova') }}">Nova Recepção</a>
  {% endif %}
</div>

{% if nova %}
<form method="post" action="{{ url_for('carnes.nova') }}" class="bg-white p-3 rounded border">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Fornecedor</label>
      <input type="text" name="fornecedor" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Tipo</label>
      <select name="tipo" class="form-select">
        <option value="bovina">Bovina</option>
        <option value="suina">Suína</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">Observação</label>
      <input type="text" name="observacao" class="form-control">
    </div>
  </div>
  <hr>
  <h5>Funcionários do fornecedor</h5>
  <div id="carriers" class="mb-2"></div>
  <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCarrier()">Adicionar Funcionário</button>
  <hr>
  <h5>Animais e partes</h5>
  <div id="animals" class="mb-2"></div>
  <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAnimal()">Adicionar Animal</button>
  <hr>
  <div class="d-flex justify-content-between align-items-center">
    <div><strong>Total líquido estimado:</strong> <span id="totalLiquido">0.00</span> kg</div>
    <button type="submit" class="btn btn-primary">Salvar Recepção</button>
  </div>
</form>

<script>
let carrierCount = 0;
function addCarrier(){
  const wrap = document.getElementById('carriers');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-end mb-2';
  row.innerHTML = `
    <div class="col-md-5">
      <label class="form-label">Nome</label>
      <input type="text" name="carrier_nome" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Peso (kg)</label>
      <input type="number" step="0.01" name="carrier_peso" class="form-control" required>
    </div>
  `;
  wrap.appendChild(row);
  carrierCount++;
  updateTotal();
}
function addAnimal(){
  const idx = document.querySelectorAll('.animal-block').length + 1;
  const wrap = document.getElementById('animals');
  const blk = document.createElement('div');
  blk.className = 'animal-block border rounded p-2 mb-3';
  blk.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div><strong>Animal #${idx}</strong></div>
    </div>
    <input type="hidden" name="animal_numero" value="${idx}">
    <div class="row g-2">${['dianteiro','dianteiro','traseiro','traseiro'].map((cat, i)=>{
      const lado = i%2===0 ? 'direito' : 'esquerdo';
      return `
      <div class="col-md-3">
        <div class="border rounded p-2">
          <div class="small text-muted mb-1">${cat} — ${lado}</div>
          <input type="hidden" name="part_categoria" value="${cat}">
          <input type="hidden" name="part_lado" value="${lado}">
          <label class="form-label">Peso bruto (kg)</label>
          <input type="number" step="0.01" name="part_peso_bruto" class="form-control" oninput="updateTotal()">
          <label class="form-label mt-2">Funcionário</label>
          <select name="part_carrier" class="form-select" onchange="updateTotal()">${carrierOptions()}</select>
        </div>
      </div>`;
    }).join('')}</div>
  `;
  wrap.appendChild(blk);
}
function carrierOptions(){
  const names = Array.from(document.querySelectorAll('input[name="carrier_nome"]')).map(i=>i.value.trim());
  let opts = '<option value="-1">—</option>';
  for(let i=0;i<names.length;i++){
    const n = names[i] || `Funcionário ${i+1}`;
    opts += `<option value="${i}">${n}</option>`;
  }
  return opts;
}
function updateCarrierSelects(){
  const selects = document.querySelectorAll('select[name="part_carrier"]');
  selects.forEach(s=>{ const cur = s.value; s.innerHTML = carrierOptions(); s.value = cur; });
}
function updateTotal(){
  updateCarrierSelects();
  const weights = Array.from(document.querySelectorAll('input[name="carrier_peso"]')).map(i=>parseFloat(i.value||'0'));
  let total = 0.0;
  const parts = document.querySelectorAll('.animal-block input[name="part_peso_bruto"]');
  const carriers = document.querySelectorAll('.animal-block select[name="part_carrier"]');
  for(let i=0;i<parts.length;i++){
    const pb = parseFloat(parts[i].value||'0');
    const idx = parseInt(carriers[i].value||'-1');
    const cw = (idx>=0 && idx<weights.length) ? weights[idx] : 0;
    total += Math.max(0, pb - cw);
  }
  document.getElementById('totalLiquido').textContent = total.toFixed(2);
}
addCarrier();
addCarrier();
</script>
{% else %}
<div class="table-responsive">
  <table class="table table-hover">
    <thead class="table-dark">
      <tr>
        <th>Data</th>
        <th>Fornecedor</th>
        <th>Tipo</th>
        <th>Partes</th>
        <th>Total líquido (kg)</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      <tr>
        <td>{{ it.r.data.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>{{ it.r.fornecedor }}</td>
        <td>{{ it.r.tipo|capitalize }}</td>
        <td>{{ it.count }}</td>
        <td>{{ '%.2f'|format(it.total) }}</td>
      </tr>
      {% endfor %}
      {% if items|length == 0 %}
      <tr><td colspan="5" class="text-muted">Sem registros</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>
{% endif %}
{% endblock %}
