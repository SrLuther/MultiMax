{% extends 'base.html' %}
{% block title %}Ciclos — MultiMax{% endblock %}

{% block head %}
<!-- Meta tags para configuração do módulo Ciclos -->
<meta name="ciclos-can-edit" content="{% if can_edit %}true{% else %}false{% endif %}">
<meta name="ciclos-url-confirmar-fechamento" content="{{ url_for('ciclos.confirmar_fechamento') }}">
<meta name="ciclos-url-pdf-geral" content="{{ url_for('ciclos.pdf_geral') }}">
<meta name="ciclos-url-resumo-fechamento" content="{{ url_for('ciclos.resumo_fechamento') }}">
{% endblock %}

{% block content %}
<div class="ciclos-container">
    <!-- Hero Header -->
    <div class="ciclos-hero">
        <div class="ciclos-hero-content">
            <div>
                <h1 class="ciclos-title">
                    <i class="bi bi-arrow-repeat ciclos-title-icon"></i>
                    Sistema de Ciclos
                </h1>
                <p class="ciclos-subtitle">Gestão de horas, dias e pagamentos por colaborador</p>
                {% if ciclo_atual %}
                <div class="ciclo-atual-badge">
                    <i class="bi bi-calendar-check"></i>
                    Ciclo {{ ciclo_atual.ciclo_id }} | {{ ciclo_atual.mes_inicio }}
                </div>
                {% endif %}
            </div>
            <div class="ciclos-hero-actions">
                {% if can_edit and tem_registros_ativos %}
                <button type="button" class="btn-action btn-action-primary" id="btnRegistrarPagamento">
                    <i class="bi bi-cash-coin"></i>
                    <span>Registrar Pagamento</span>
                </button>
                {% endif %}
                {% if can_edit %}
                <a href="{{ url_for('ciclos.config') }}" class="btn-action btn-action-secondary">
                    <i class="bi bi-gear"></i>
                    <span>Configurações</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="resumo-geral-card">
        <div class="resumo-header">
            <h3 class="resumo-title">
                <i class="bi bi-bar-chart"></i>
                Resumo Geral
            </h3>
        </div>
        <div class="resumo-grid">
            <div class="resumo-item">
                <div class="resumo-label">Total de Horas</div>
                <div class="resumo-value">{{ "%.1f"|format(total_horas_geral) }}h</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Dias Completos</div>
                <div class="resumo-value">{{ total_dias_geral }} dias</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Horas Restantes</div>
                <div class="resumo-value">{{ "%.1f"|format(total_horas_restantes_geral) }}h</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Valor Total Aproximado</div>
                <div class="resumo-value">R$ {{ "%.2f"|format(total_valor_geral) }}</div>
            </div>
        </div>
    </div>

    <!-- Cards de Colaboradores -->
    <div class="colaboradores-grid">
        {% for stat in colaboradores_stats %}
        <div class="colaborador-card">
            <div class="colaborador-header">
                <h4 class="colaborador-nome">{{ stat.collaborator.name }}</h4>
            </div>
            <div class="colaborador-stats">
                <div class="stat-item">
                    <span class="stat-label">Horas Totais:</span>
                    <span class="stat-value">{{ "%.1f"|format(stat.balance.total_horas) }}h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dias Completos:</span>
                    <span class="stat-value">{{ stat.balance.dias_completos }} dias</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Horas Restantes:</span>
                    <span class="stat-value">{{ "%.1f"|format(stat.balance.horas_restantes) }}h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Valor Aproximado:</span>
                    <span class="stat-value">R$ {{ "%.2f"|format(stat.balance.valor_aproximado) }}</span>
                </div>
            </div>
            <div class="colaborador-actions">
                <button type="button" class="btn-card btn-card-secondary btn-abrir-historico" data-collaborator-id="{{ stat.collaborator.id }}" data-collaborator-name="{{ stat.collaborator.name }}">
                    <i class="bi bi-clock-history"></i>
                    Detalhes / Histórico
                </button>
                {% if can_edit %}
                <button type="button" class="btn-card btn-card-primary btn-abrir-lancamento" data-collaborator-id="{{ stat.collaborator.id }}" data-collaborator-name="{{ stat.collaborator.name }}">
                    <i class="bi bi-plus-circle"></i>
                    + Lançar Horas
                </button>
                <a href="/ciclos/?collaborator_id={{ stat.collaborator.id }}" class="btn-card btn-card-secondary" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">
                    <i class="bi bi-calendar-check"></i>
                    Férias / Atestados
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Férias e Atestados -->
{% if selected_collaborator and can_edit %}
<div class="ferias-atestados-grid-modern">
    <!-- Férias -->
    <div class="ferias-card-modern">
        <div class="ferias-header-modern">
            <h3 class="ferias-title">
                <i class="bi bi-airplane"></i>
                Férias
            </h3>
        </div>
        <div class="ferias-body-modern">
            <form method="POST" action="{{ url_for('ciclos.ferias_adicionar') }}" class="ferias-form-modern">
                <input type="hidden" name="collaborator_id" value="{{ selected_collaborator.id }}">
                <div class="form-row-modern">
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-calendar3"></i>
                            Data Início <span class="required">*</span>
                        </label>
                        <input type="date" name="data_inicio" class="form-input-modern" required>
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-calendar-check"></i>
                            Data Fim <span class="required">*</span>
                        </label>
                        <input type="date" name="data_fim" class="form-input-modern" required>
                    </div>
                </div>
                <div class="form-group-modern">
                    <label class="form-label-modern">
                        <i class="bi bi-chat-left-text"></i>
                        Observação
                    </label>
                    <textarea name="observacao" class="form-textarea-modern" rows="2"></textarea>
                </div>
                <div class="form-actions-modern">
                    <button type="submit" class="btn-save-modern">
                        <i class="bi bi-plus-circle"></i>
                        Adicionar Férias
                    </button>
                </div>
            </form>
            
            {% if ferias %}
            <div class="ferias-table-wrapper">
                <table class="ferias-table-modern">
                    <thead>
                        <tr>
                            <th>Início</th>
                            <th>Fim</th>
                            <th class="text-center">Dias</th>
                            <th>Observação</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in ferias %}
                        <tr>
                            <td>{{ f.data_inicio.strftime('%d/%m/%Y') }}</td>
                            <td>{{ f.data_fim.strftime('%d/%m/%Y') }}</td>
                            <td class="text-center">
                                <span class="badge-dias-modern">{{ (f.data_fim - f.data_inicio).days + 1 }}</span>
                            </td>
                            <td>{{ f.observacao or '-' }}</td>
                            <td class="text-center">
                                <form method="POST" action="{{ url_for('ciclos.ferias_excluir', id=f.id) }}" style="display: inline;" onsubmit="return confirm('Excluir férias?');">
                                    <button type="submit" class="btn-action-small btn-delete-small" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state-small-modern">
                <i class="bi bi-calendar-x"></i>
                <p>Nenhuma férias registrada</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Atestados Médicos -->
    <div class="atestados-card-modern">
        <div class="atestados-header-modern">
            <h3 class="atestados-title">
                <i class="bi bi-file-medical"></i>
                Atestados Médicos
            </h3>
        </div>
        <div class="atestados-body-modern">
            <form method="POST" action="{{ url_for('ciclos.atestado_adicionar') }}" enctype="multipart/form-data" class="atestados-form-modern">
                <input type="hidden" name="collaborator_id" value="{{ selected_collaborator.id }}">
                <div class="form-row-modern">
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-calendar3"></i>
                            Data Início <span class="required">*</span>
                        </label>
                        <input type="date" name="data_inicio" class="form-input-modern" required>
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-calendar-check"></i>
                            Data Fim <span class="required">*</span>
                        </label>
                        <input type="date" name="data_fim" class="form-input-modern" required>
                    </div>
                </div>
                <div class="form-row-modern">
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-file-text"></i>
                            CID
                        </label>
                        <input type="text" name="cid" class="form-input-modern" placeholder="Código CID">
                    </div>
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="bi bi-person-badge"></i>
                            Médico
                        </label>
                        <input type="text" name="medico" class="form-input-modern" placeholder="Nome do médico">
                    </div>
                </div>
                <div class="form-group-modern">
                    <label class="form-label-modern">
                        <i class="bi bi-chat-left-text"></i>
                        Motivo
                    </label>
                    <textarea name="motivo" class="form-textarea-modern" rows="2"></textarea>
                </div>
                <div class="form-group-modern">
                    <label class="form-label-modern">
                        <i class="bi bi-image"></i>
                        Foto do Atestado
                    </label>
                    <input type="file" name="foto_atestado" class="form-input-modern" accept="image/*">
                    <small class="form-hint-modern">PNG, JPG, JPEG, GIF (máx. 10MB)</small>
                </div>
                <div class="form-actions-modern">
                    <button type="submit" class="btn-save-modern">
                        <i class="bi bi-plus-circle"></i>
                        Adicionar Atestado
                    </button>
                </div>
            </form>
            
            {% if atestados %}
            <div class="atestados-table-wrapper">
                <table class="atestados-table-modern">
                    <thead>
                        <tr>
                            <th>Início</th>
                            <th>Fim</th>
                            <th class="text-center">Dias</th>
                            <th>CID</th>
                            <th>Médico</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in atestados %}
                        <tr>
                            <td>{{ a.data_inicio.strftime('%d/%m/%Y') }}</td>
                            <td>{{ a.data_fim.strftime('%d/%m/%Y') }}</td>
                            <td class="text-center">
                                <span class="badge-dias-modern">{{ a.dias or ((a.data_fim - a.data_inicio).days + 1) }}</span>
                            </td>
                            <td>{{ a.cid or '-' }}</td>
                            <td>{{ a.medico or '-' }}</td>
                            <td class="text-center">
                                <div class="atestado-actions-modern">
                                    {% if a.foto_atestado %}
                                    <a href="{{ url_for('static', filename='uploads/atestados/' + a.foto_atestado) }}" target="_blank" class="btn-action-small btn-view-small" title="Ver foto">
                                        <i class="bi bi-image"></i>
                                    </a>
                                    {% endif %}
                                    <form method="POST" action="{{ url_for('ciclos.atestado_excluir', id=a.id) }}" style="display: inline;" onsubmit="return confirm('Excluir atestado?');">
                                        <button type="submit" class="btn-action-small btn-delete-small" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-state-small-modern">
                <i class="bi bi-file-medical"></i>
                <p>Nenhum atestado registrado</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Card Explicativo -->
<div class="ciclos-info-card">
    <div class="ciclos-info-header">
        <h3 class="ciclos-info-title">
            <i class="bi bi-info-circle"></i>
            Como Funciona o Sistema de Ciclos
        </h3>
    </div>
    <div class="ciclos-info-body">
        <div class="ciclos-info-content">
            <div class="ciclos-info-item">
                <div class="ciclos-info-icon">
                    <i class="bi bi-clock"></i>
                </div>
                <div class="ciclos-info-text">
                    <h4>Lançamento de Horas</h4>
                    <p>Os colaboradores recebem horas trabalhadas de diferentes origens: domingos, feriados, horas adicionais ou outros eventos especiais. Cada lançamento registra as horas acumuladas no ciclo atual.</p>
                </div>
            </div>
            <div class="ciclos-info-item">
                <div class="ciclos-info-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="ciclos-info-text">
                    <h4>Conversão em Dias</h4>
                    <p>A cada <strong>8 horas</strong> completas, o sistema converte automaticamente em <strong>1 dia completo</strong>. Por exemplo: 16 horas = 2 dias completos, 10 horas = 1 dia completo + 2 horas restantes.</p>
                </div>
            </div>
            <div class="ciclos-info-item">
                <div class="ciclos-info-icon">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="ciclos-info-text">
                    <h4>Valor Aproximado</h4>
                    <p>O valor em R$ é calculado apenas sobre os <strong>dias completos</strong> (múltiplos de 8h). As horas restantes (menos de 8h) não entram no cálculo de pagamento do ciclo atual, mas são preservadas para o próximo ciclo.</p>
                </div>
            </div>
            <div class="ciclos-info-item">
                <div class="ciclos-info-icon">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="ciclos-info-text">
                    <h4>Fechamento do Ciclo</h4>
                    <p>Quando o ciclo é fechado (Registrar Pagamento), os <strong>dias completos</strong> são convertidos em R$ para pagamento. As <strong>horas restantes</strong> (ex: 2h, 5h, etc.) são automaticamente transportadas para o próximo ciclo como "Carryover", onde poderão se somar a novas horas lançadas.</p>
                </div>
            </div>
            <div class="ciclos-info-item">
                <div class="ciclos-info-icon">
                    <i class="bi bi-lightbulb"></i>
                </div>
                <div class="ciclos-info-text">
                    <h4>Exemplo Prático</h4>
                    <p>Se um colaborador tem <strong>18 horas</strong> acumuladas: isso resulta em <strong>2 dias completos</strong> (16h) + <strong>2 horas restantes</strong>. Ao fechar o ciclo, receberá o valor de 2 dias. As 2 horas restantes seguirão para o próximo ciclo e, se somarem mais 6 horas, completarão 1 dia adicional.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Lançamento de Horas -->
{% if can_edit %}
<div class="modal fade" id="modalLancamento" tabindex="-1" aria-labelledby="modalLancamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLancamentoLabel">
                    <i class="bi bi-plus-circle"></i>
                    Lançar Horas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formLancamento" method="POST" action="{{ url_for('ciclos.lancar_horas') }}">
                <input type="hidden" name="collaborator_id" id="lancamento_collaborator_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Colaborador</label>
                        <input type="text" class="form-control" id="lancamento_colaborador_nome" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="data_lancamento" id="lancamento_data" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Origem <span class="text-danger">*</span></label>
                        <select class="form-select" name="origem" id="lancamento_origem" required>
                            <option value="">Selecione...</option>
                            <option value="Domingo">Domingo</option>
                            <option value="Feriado">Feriado</option>
                            <option value="Horas adicionais">Horas adicionais</option>
                            <option value="Outro">Outro</option>
                            <option value="Folga utilizada">Folga utilizada</option>
                        </select>
                    </div>
                    <div class="mb-3" id="lancamento_descricao_group" style="display: none;">
                        <label class="form-label">Descrição <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="descricao" id="lancamento_descricao" rows="3"></textarea>
                        <small class="form-text text-muted">Obrigatório para "Horas adicionais" ou "Outro"</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Horas <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="valor_horas" id="lancamento_horas" 
                               placeholder="Ex: 1 ou 1.5 ou 2.5" required>
                        <small class="form-text text-muted">Apenas múltiplos de 0.5 são permitidos (ex: 1, 1.5, 2, 2.5)</small>
                        <div class="invalid-feedback" id="lancamento_horas_error"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarLancamento" disabled>
                        <i class="bi bi-check-circle"></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Histórico -->
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-labelledby="modalHistoricoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHistoricoLabel">
                    <i class="bi bi-clock-history"></i>
                    Histórico - <span id="historico_colaborador_nome"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="historico_loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="historico_content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Origem</th>
                                    <th>Descrição</th>
                                    <th>Horas</th>
                                    {% if can_edit %}
                                    <th>Ações</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="historico_tbody">
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginação do histórico">
                        <ul class="pagination justify-content-center" id="historico_pagination">
                        </ul>
                    </nav>
                    <div class="historico-resumo mt-3 p-3 bg-light rounded">
                        <h6>Resumo:</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Horas Totais:</strong> <span id="historico_total_horas">0.0h</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Dias Fechados:</strong> <span id="historico_dias_fechados">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Horas Restantes:</strong> <span id="historico_horas_restantes">0.0h</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Valor Aproximado:</strong> <span id="historico_valor_aproximado">R$ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="historico_empty" style="display: none;" class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Nenhum registro encontrado</p>
                </div>
            </div>
            <div class="modal-footer">
                {% if can_edit %}
                <button type="button" class="btn btn-warning" id="btnAjustarHistorico" style="display: none;">
                    <i class="bi bi-pencil"></i>
                    Ajustar
                </button>
                {% endif %}
                <button type="button" class="btn btn-info" id="btnPDFIndividual" style="display: none;">
                    <i class="bi bi-file-earmark-pdf"></i>
                    Visualizar PDF Individual
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Registro -->
{% if can_edit %}
<div class="modal fade" id="modalAjustar" tabindex="-1" aria-labelledby="modalAjustarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjustarLabel">
                    <i class="bi bi-pencil"></i>
                    Ajustar Registro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formAjustar" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="ciclo_id" id="ajustar_ciclo_id">
                    <div class="mb-3">
                        <label class="form-label">Horas <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="valor_horas" id="ajustar_horas" required>
                        <small class="form-text text-muted">Apenas múltiplos de 0.5 são permitidos</small>
                        <div class="invalid-feedback" id="ajustar_horas_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="descricao" id="ajustar_descricao" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarAjuste" disabled>
                        <i class="bi bi-check-circle"></i>
                        Salvar Ajuste
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Fechamento de Ciclo -->
{% if can_edit %}
<div class="modal fade" id="modalFechamento" tabindex="-1" aria-labelledby="modalFechamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFechamentoLabel">
                    <i class="bi bi-cash-coin"></i>
                    Registrar Pagamento - Fechamento de Ciclo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="fechamento_loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="fechamento_content" style="display: none;">
                    <div class="alert alert-warning" id="fechamento_avisos" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> Avisos:</h6>
                        <ul id="fechamento_avisos_list"></ul>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Horas Totais</th>
                                    <th>Dias Completos</th>
                                    <th>Horas Restantes</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="fechamento_tbody">
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th>TOTAL</th>
                                    <th id="fechamento_total_horas">0.0h</th>
                                    <th id="fechamento_total_dias">0 dias</th>
                                    <th id="fechamento_total_horas_restantes">0.0h</th>
                                    <th id="fechamento_total_valor">R$ 0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" id="fechamento_observacoes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                {% if can_edit %}
                <button type="button" class="btn btn-warning" id="btnAjustarFechamento">
                    <i class="bi bi-pencil"></i>
                    Ajustar
                </button>
                {% endif %}
                <button type="button" class="btn btn-info" id="btnPDFGeral">
                    <i class="bi bi-file-earmark-pdf"></i>
                    Visualizar PDF Geral
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarFechamento">
                    <i class="bi bi-check-circle"></i>
                    Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.ciclos-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.ciclos-hero {
    background: linear-gradient(135deg, var(--mm-primary) 0%, var(--mm-primary-dark) 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
}

.ciclos-hero-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.ciclos-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ciclos-title-icon {
    font-size: 2.5rem;
}

.ciclos-subtitle {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.ciclo-atual-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    backdrop-filter: blur(10px);
}

.ciclo-atual-badge i {
    font-size: 1.1rem;
}

.btn-action {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-action-primary {
    background: white;
    color: var(--mm-primary);
}

.btn-action-primary:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

.btn-action-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-action-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
}

.resumo-geral-card {
    background: var(--mm-bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.resumo-header {
    margin-bottom: 1rem;
}

.resumo-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.resumo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.resumo-item {
    text-align: center;
    padding: 1rem;
    background: var(--mm-bg);
    border-radius: 8px;
}

.resumo-label {
    font-size: 0.875rem;
    color: var(--mm-text-secondary);
    margin-bottom: 0.5rem;
}

.resumo-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--mm-primary);
}

.colaboradores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.colaborador-card {
    background: var(--mm-bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.colaborador-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.colaborador-header {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--mm-border);
}

.colaborador-nome {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--mm-text);
}

.colaborador-stats {
    margin-bottom: 1.5rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--mm-border);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: var(--mm-text-secondary);
    font-size: 0.875rem;
}

.stat-value {
    font-weight: 600;
    color: var(--mm-text);
}

.colaborador-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-card {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
}

.btn-card-primary {
    background: var(--mm-primary);
    color: white;
}

.btn-card-primary:hover {
    background: var(--mm-primary-dark);
    transform: translateY(-2px);
}

.btn-card-secondary {
    background: var(--mm-bg);
    color: var(--mm-text);
    border: 1px solid var(--mm-border);
}

.btn-card-secondary:hover {
    background: var(--mm-border);
}

.historico-resumo {
    background: var(--mm-bg) !important;
}

@media (max-width: 768px) {
    .ciclos-container {
        padding: 1rem;
    }
    
    .ciclos-hero-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .resumo-grid {
        grid-template-columns: 1fr;
    }
    
    .colaboradores-grid {
        grid-template-columns: 1fr;
    }
    
    .colaborador-actions {
        flex-direction: column;
    }
    
    .btn-card {
        width: 100%;
    }
    
    .ferias-atestados-grid-modern {
        grid-template-columns: 1fr;
    }
}

/* Férias e Atestados */
.ferias-atestados-grid-modern {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
    margin-top: 2rem;
}

.ferias-card-modern,
.atestados-card-modern {
    background: white;
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
}

.ferias-card-modern {
    border-left: 4px solid #f59e0b;
}

.atestados-card-modern {
    border-left: 4px solid #ef4444;
}

.ferias-header-modern,
.atestados-header-modern {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f3f4f6;
}

.ferias-title,
.atestados-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}

.ferias-title i {
    color: #f59e0b;
}

.atestados-title i {
    color: #ef4444;
}

.ferias-form-modern,
.atestados-form-modern {
    margin-bottom: 1.5rem;
}

.form-group-modern {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.form-label-modern {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label-modern i {
    color: #667eea;
}

.required {
    color: #ef4444;
}

.form-input-modern,
.form-textarea-modern {
    padding: 0.75rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
    font-family: inherit;
}

.form-textarea-modern {
    resize: vertical;
    min-height: 80px;
}

.form-input-modern:focus,
.form-textarea-modern:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-hint-modern {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.form-actions-modern {
    display: flex;
    justify-content: flex-end;
    margin-top: 1rem;
}

.btn-save-modern {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
}

.btn-save-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.ferias-table-wrapper,
.atestados-table-wrapper {
    overflow-x: auto;
}

.ferias-table-modern,
.atestados-table-modern {
    width: 100%;
    border-collapse: collapse;
}

.ferias-table-modern th,
.atestados-table-modern th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e5e7eb;
    background: #f9fafb;
}

.ferias-table-modern td,
.atestados-table-modern td {
    padding: 1rem;
    color: #1f2937;
    border-bottom: 1px solid #f3f4f6;
}

.badge-dias-modern {
    display: inline-flex;
    padding: 0.375rem 0.75rem;
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
}

.atestado-actions-modern {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.empty-state-small-modern {
    text-align: center;
    padding: 3rem 1rem;
    color: #6b7280;
}

.empty-state-small-modern i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-small-modern p {
    margin: 0;
    font-size: 0.875rem;
}

.btn-action-small {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    color: #374151;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-action-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-view-small:hover {
    background: #3b82f6;
    color: white;
}

.btn-delete-small:hover {
    background: #ef4444;
    color: white;
}

.text-center {
    text-align: center;
}

/* Dark Mode Support para Modais */
[data-theme="dark"] .modal-content {
    background-color: #1f2937;
    color: #f9fafb;
    border-color: #374151;
}

[data-theme="dark"] .modal-header {
    background-color: #1f2937;
    border-bottom-color: #374151;
    color: #f9fafb;
}

[data-theme="dark"] .modal-title {
    color: #f9fafb;
}

[data-theme="dark"] .modal-body {
    background-color: #1f2937;
    color: #f9fafb;
}

[data-theme="dark"] .modal-footer {
    background-color: #1f2937;
    border-top-color: #374151;
}

[data-theme="dark"] .table {
    color: #f9fafb;
}

[data-theme="dark"] .table thead th {
    background-color: #374151;
    color: #e5e7eb;
    border-bottom-color: #4b5563;
}

[data-theme="dark"] .table tbody td {
    color: #ffffff !important;
    background-color: #1f2937 !important;
    border-bottom-color: #374151;
}

[data-theme="dark"] .table tbody tr {
    background-color: #1f2937 !important;
}

[data-theme="dark"] .table tbody tr td {
    color: #ffffff !important;
}

[data-theme="dark"] .table-hover tbody tr:hover {
    background-color: #374151 !important;
}

[data-theme="dark"] .table-hover tbody tr:hover td {
    color: #ffffff !important;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) {
    background-color: #374151 !important;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(odd) td {
    color: #f9fafb !important;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(even) {
    background-color: #1f2937 !important;
}

[data-theme="dark"] .table-striped tbody tr:nth-of-type(even) td {
    color: #f9fafb !important;
}

[data-theme="dark"] .table-primary {
    background-color: #1e40af;
    color: #f9fafb;
}

[data-theme="dark"] .table-primary th {
    background-color: #1e40af;
    color: #f9fafb;
}

[data-theme="dark"] .form-label {
    color: #e5e7eb;
}

[data-theme="dark"] .form-control {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .form-control:focus {
    background-color: #374151;
    border-color: #3b82f6;
    color: #f9fafb;
}

[data-theme="dark"] .form-control::placeholder {
    color: #9ca3af;
}

[data-theme="dark"] .form-select {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .form-select:focus {
    background-color: #374151;
    border-color: #3b82f6;
    color: #f9fafb;
}

[data-theme="dark"] .text-muted {
    color: #9ca3af !important;
}

[data-theme="dark"] .text-secondary {
    color: #d1d5db !important;
}

[data-theme="dark"] .bg-light {
    background-color: #374151 !important;
    color: #f9fafb !important;
}

[data-theme="dark"] .bg-primary {
    background-color: #1e40af !important;
    color: #f9fafb !important;
}

[data-theme="dark"] .btn-close {
    filter: invert(1) grayscale(100%) brightness(200%);
}

[data-theme="dark"] .btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}

[data-theme="dark"] .historico-resumo {
    background-color: #374151 !important;
    color: #f9fafb !important;
}

[data-theme="dark"] .historico-resumo h6 {
    color: #f9fafb;
}

[data-theme="dark"] .historico-resumo strong {
    color: #e5e7eb;
}

[data-theme="dark"] .pagination .page-link {
    background-color: #374151;
    border-color: #4b5563;
    color: #d1d5db;
}

[data-theme="dark"] .pagination .page-link:hover {
    background-color: #4b5563;
    border-color: #6b7280;
    color: #f9fafb;
}

[data-theme="dark"] .pagination .page-item.active .page-link {
    background-color: #3b82f6;
    border-color: #3b82f6;
    color: #f9fafb;
}

[data-theme="dark"] .alert {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .alert-warning {
    background-color: #78350f;
    border-color: #92400e;
    color: #fef3c7;
}

[data-theme="dark"] .spinner-border {
    color: #3b82f6;
}

/* Dark Mode para Cards de Férias e Atestados */
[data-theme="dark"] .ferias-card-modern,
[data-theme="dark"] .atestados-card-modern {
    background-color: #1f2937;
    border-color: #374151;
    color: #f9fafb;
}

[data-theme="dark"] .ferias-header-modern,
[data-theme="dark"] .atestados-header-modern {
    border-bottom-color: #374151;
}

[data-theme="dark"] .ferias-title,
[data-theme="dark"] .atestados-title {
    color: #f9fafb;
}

[data-theme="dark"] .form-label-modern {
    color: #e5e7eb;
}

[data-theme="dark"] .form-input-modern,
[data-theme="dark"] .form-textarea-modern {
    background-color: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .form-input-modern:focus,
[data-theme="dark"] .form-textarea-modern:focus {
    background-color: #374151;
    border-color: #3b82f6;
    color: #f9fafb;
}

[data-theme="dark"] .form-hint-modern {
    color: #9ca3af;
}

[data-theme="dark"] .ferias-table-modern th,
[data-theme="dark"] .atestados-table-modern th {
    background-color: #374151;
    color: #e5e7eb;
    border-bottom-color: #4b5563;
}

[data-theme="dark"] .ferias-table-modern td,
[data-theme="dark"] .atestados-table-modern td {
    color: #f3f4f6;
    border-bottom-color: #374151;
}

[data-theme="dark"] .badge-dias-modern {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399;
}

[data-theme="dark"] .btn-action-small {
    background-color: #374151;
    color: #d1d5db;
}

[data-theme="dark"] .btn-action-small:hover {
    background-color: #4b5563;
}

[data-theme="dark"] .empty-state-small-modern {
    color: #9ca3af;
}

[data-theme="dark"] .empty-state-small-modern i {
    color: #6b7280;
}

/* Card Explicativo */
.ciclos-info-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-top: 3rem;
    margin-bottom: 2rem;
    border: 2px solid #667eea;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
}

.ciclos-info-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
}

.ciclos-info-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ciclos-info-title i {
    color: #667eea;
    font-size: 1.75rem;
}

.ciclos-info-body {
    padding: 0;
}

.ciclos-info-content {
    display: grid;
    gap: 1.5rem;
}

.ciclos-info-item {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
    padding: 1.25rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
}

.ciclos-info-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.ciclos-info-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.ciclos-info-text {
    flex: 1;
}

.ciclos-info-text h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
}

.ciclos-info-text p {
    font-size: 0.9375rem;
    color: #4b5563;
    line-height: 1.6;
    margin: 0;
}

.ciclos-info-text p strong {
    color: #667eea;
    font-weight: 600;
}

@media (max-width: 768px) {
    .ciclos-info-card {
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .ciclos-info-title {
        font-size: 1.25rem;
    }
    
    .ciclos-info-item {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .ciclos-info-text {
        text-align: left;
    }
}

[data-theme="dark"] .ciclos-info-card {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border-color: #667eea;
}

[data-theme="dark"] .ciclos-info-header {
    border-bottom-color: rgba(102, 126, 234, 0.3);
}

[data-theme="dark"] .ciclos-info-title {
    color: #f9fafb;
}

[data-theme="dark"] .ciclos-info-item {
    background-color: #1f2937;
    border: 1px solid #374151;
}

[data-theme="dark"] .ciclos-info-text h4 {
    color: #f9fafb;
}

[data-theme="dark"] .ciclos-info-text p {
    color: #d1d5db;
}

[data-theme="dark"] .ciclos-info-text p strong {
    color: #a78bfa;
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/ciclos.js') }}"></script>
{% endblock %}
