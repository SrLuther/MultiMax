{% extends 'base.html' %}
{% block title %}Ciclos — MultiMax{% endblock %}

{% block content %}
<div class="ciclos-container">
    <!-- Hero Header -->
    <div class="ciclos-hero">
        <div class="ciclos-hero-content">
            <div>
                <h1 class="ciclos-title">
                    <i class="bi bi-arrow-repeat ciclos-title-icon"></i>
                    Sistema de Ciclos
                </h1>
                <p class="ciclos-subtitle">Gestão de horas, dias e pagamentos por colaborador</p>
            </div>
            <div class="ciclos-hero-actions">
                {% if can_edit and tem_registros_ativos %}
                <button type="button" class="btn-action btn-action-primary" id="btnRegistrarPagamento">
                    <i class="bi bi-cash-coin"></i>
                    <span>Registrar Pagamento</span>
                </button>
                {% endif %}
                {% if can_edit %}
                <a href="{{ url_for('ciclos.config') }}" class="btn-action btn-action-secondary">
                    <i class="bi bi-gear"></i>
                    <span>Configurações</span>
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="resumo-geral-card">
        <div class="resumo-header">
            <h3 class="resumo-title">
                <i class="bi bi-bar-chart"></i>
                Resumo Geral
            </h3>
        </div>
        <div class="resumo-grid">
            <div class="resumo-item">
                <div class="resumo-label">Total de Horas</div>
                <div class="resumo-value">{{ "%.1f"|format(total_horas_geral) }}h</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Dias Completos</div>
                <div class="resumo-value">{{ total_dias_geral }} dias</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Horas Restantes</div>
                <div class="resumo-value">{{ "%.1f"|format(total_horas_restantes_geral) }}h</div>
            </div>
            <div class="resumo-item">
                <div class="resumo-label">Valor Total Aproximado</div>
                <div class="resumo-value">R$ {{ "%.2f"|format(total_valor_geral) }}</div>
            </div>
        </div>
    </div>

    <!-- Cards de Colaboradores -->
    <div class="colaboradores-grid">
        {% for stat in colaboradores_stats %}
        <div class="colaborador-card">
            <div class="colaborador-header">
                <h4 class="colaborador-nome">{{ stat.collaborator.name }}</h4>
            </div>
            <div class="colaborador-stats">
                <div class="stat-item">
                    <span class="stat-label">Horas Totais:</span>
                    <span class="stat-value">{{ "%.1f"|format(stat.balance.total_horas) }}h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Dias Completos:</span>
                    <span class="stat-value">{{ stat.balance.dias_completos }} dias</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Horas Restantes:</span>
                    <span class="stat-value">{{ "%.1f"|format(stat.balance.horas_restantes) }}h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Valor Aproximado:</span>
                    <span class="stat-value">R$ {{ "%.2f"|format(stat.balance.valor_aproximado) }}</span>
                </div>
            </div>
            <div class="colaborador-actions">
                <button type="button" class="btn-card btn-card-secondary" onclick="abrirHistorico({{ stat.collaborator.id }}, '{{ stat.collaborator.name }}')">
                    <i class="bi bi-clock-history"></i>
                    Detalhes / Histórico
                </button>
                {% if can_edit %}
                <button type="button" class="btn-card btn-card-primary" onclick="abrirLancamento({{ stat.collaborator.id }}, '{{ stat.collaborator.name }}')">
                    <i class="bi bi-plus-circle"></i>
                    + Lançar Horas
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Lançamento de Horas -->
{% if can_edit %}
<div class="modal fade" id="modalLancamento" tabindex="-1" aria-labelledby="modalLancamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLancamentoLabel">
                    <i class="bi bi-plus-circle"></i>
                    Lançar Horas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formLancamento" method="POST" action="{{ url_for('ciclos.lancar_horas') }}">
                <input type="hidden" name="collaborator_id" id="lancamento_collaborator_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Colaborador</label>
                        <input type="text" class="form-control" id="lancamento_colaborador_nome" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" name="data_lancamento" id="lancamento_data" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Origem <span class="text-danger">*</span></label>
                        <select class="form-select" name="origem" id="lancamento_origem" required>
                            <option value="">Selecione...</option>
                            <option value="Domingo">Domingo</option>
                            <option value="Feriado">Feriado</option>
                            <option value="Horas adicionais">Horas adicionais</option>
                            <option value="Outro">Outro</option>
                            <option value="Folga utilizada">Folga utilizada</option>
                        </select>
                    </div>
                    <div class="mb-3" id="lancamento_descricao_group" style="display: none;">
                        <label class="form-label">Descrição <span class="text-danger">*</span></label>
                        <textarea class="form-control" name="descricao" id="lancamento_descricao" rows="3"></textarea>
                        <small class="form-text text-muted">Obrigatório para "Horas adicionais" ou "Outro"</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Horas <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="valor_horas" id="lancamento_horas" 
                               placeholder="Ex: 1 ou 1.5 ou 2.5" required>
                        <small class="form-text text-muted">Apenas múltiplos de 0.5 são permitidos (ex: 1, 1.5, 2, 2.5)</small>
                        <div class="invalid-feedback" id="lancamento_horas_error"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarLancamento" disabled>
                        <i class="bi bi-check-circle"></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Histórico -->
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-labelledby="modalHistoricoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHistoricoLabel">
                    <i class="bi bi-clock-history"></i>
                    Histórico - <span id="historico_colaborador_nome"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="historico_loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="historico_content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Origem</th>
                                    <th>Descrição</th>
                                    <th>Horas</th>
                                    {% if can_edit %}
                                    <th>Ações</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="historico_tbody">
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Paginação do histórico">
                        <ul class="pagination justify-content-center" id="historico_pagination">
                        </ul>
                    </nav>
                    <div class="historico-resumo mt-3 p-3 bg-light rounded">
                        <h6>Resumo:</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Horas Totais:</strong> <span id="historico_total_horas">0.0h</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Dias Fechados:</strong> <span id="historico_dias_fechados">0</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Horas Restantes:</strong> <span id="historico_horas_restantes">0.0h</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Valor Aproximado:</strong> <span id="historico_valor_aproximado">R$ 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="historico_empty" style="display: none;" class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">Nenhum registro encontrado</p>
                </div>
            </div>
            <div class="modal-footer">
                {% if can_edit %}
                <button type="button" class="btn btn-warning" id="btnAjustarHistorico" style="display: none;">
                    <i class="bi bi-pencil"></i>
                    Ajustar
                </button>
                {% endif %}
                <button type="button" class="btn btn-info" id="btnPDFIndividual" style="display: none;">
                    <i class="bi bi-file-earmark-pdf"></i>
                    Visualizar PDF Individual
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajustar Registro -->
{% if can_edit %}
<div class="modal fade" id="modalAjustar" tabindex="-1" aria-labelledby="modalAjustarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjustarLabel">
                    <i class="bi bi-pencil"></i>
                    Ajustar Registro
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formAjustar" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="ciclo_id" id="ajustar_ciclo_id">
                    <div class="mb-3">
                        <label class="form-label">Horas <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="valor_horas" id="ajustar_horas" required>
                        <small class="form-text text-muted">Apenas múltiplos de 0.5 são permitidos</small>
                        <div class="invalid-feedback" id="ajustar_horas_error"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="descricao" id="ajustar_descricao" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnSalvarAjuste" disabled>
                        <i class="bi bi-check-circle"></i>
                        Salvar Ajuste
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Fechamento de Ciclo -->
{% if can_edit %}
<div class="modal fade" id="modalFechamento" tabindex="-1" aria-labelledby="modalFechamentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalFechamentoLabel">
                    <i class="bi bi-cash-coin"></i>
                    Registrar Pagamento - Fechamento de Ciclo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="fechamento_loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <div id="fechamento_content" style="display: none;">
                    <div class="alert alert-warning" id="fechamento_avisos" style="display: none;">
                        <h6><i class="bi bi-exclamation-triangle"></i> Avisos:</h6>
                        <ul id="fechamento_avisos_list"></ul>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Colaborador</th>
                                    <th>Horas Totais</th>
                                    <th>Dias Completos</th>
                                    <th>Horas Restantes</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody id="fechamento_tbody">
                            </tbody>
                            <tfoot>
                                <tr class="table-primary">
                                    <th>TOTAL</th>
                                    <th id="fechamento_total_horas">0.0h</th>
                                    <th id="fechamento_total_dias">0 dias</th>
                                    <th id="fechamento_total_horas_restantes">0.0h</th>
                                    <th id="fechamento_total_valor">R$ 0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Observações</label>
                        <textarea class="form-control" name="observacoes" id="fechamento_observacoes" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                {% if can_edit %}
                <button type="button" class="btn btn-warning" id="btnAjustarFechamento">
                    <i class="bi bi-pencil"></i>
                    Ajustar
                </button>
                {% endif %}
                <button type="button" class="btn btn-info" id="btnPDFGeral">
                    <i class="bi bi-file-earmark-pdf"></i>
                    Visualizar PDF Geral
                </button>
                <button type="button" class="btn btn-success" id="btnConfirmarFechamento">
                    <i class="bi bi-check-circle"></i>
                    Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.ciclos-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.ciclos-hero {
    background: linear-gradient(135deg, var(--mm-primary) 0%, var(--mm-primary-dark) 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
}

.ciclos-hero-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.ciclos-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ciclos-title-icon {
    font-size: 2.5rem;
}

.ciclos-subtitle {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}

.btn-action {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-action-primary {
    background: white;
    color: var(--mm-primary);
}

.btn-action-primary:hover {
    background: #f0f0f0;
    transform: translateY(-2px);
}

.btn-action-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-action-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
}

.resumo-geral-card {
    background: var(--mm-bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.resumo-header {
    margin-bottom: 1rem;
}

.resumo-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.resumo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.resumo-item {
    text-align: center;
    padding: 1rem;
    background: var(--mm-bg);
    border-radius: 8px;
}

.resumo-label {
    font-size: 0.875rem;
    color: var(--mm-text-secondary);
    margin-bottom: 0.5rem;
}

.resumo-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--mm-primary);
}

.colaboradores-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.colaborador-card {
    background: var(--mm-bg-card);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.colaborador-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.colaborador-header {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--mm-border);
}

.colaborador-nome {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    color: var(--mm-text);
}

.colaborador-stats {
    margin-bottom: 1.5rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--mm-border);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: var(--mm-text-secondary);
    font-size: 0.875rem;
}

.stat-value {
    font-weight: 600;
    color: var(--mm-text);
}

.colaborador-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-card {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
}

.btn-card-primary {
    background: var(--mm-primary);
    color: white;
}

.btn-card-primary:hover {
    background: var(--mm-primary-dark);
    transform: translateY(-2px);
}

.btn-card-secondary {
    background: var(--mm-bg);
    color: var(--mm-text);
    border: 1px solid var(--mm-border);
}

.btn-card-secondary:hover {
    background: var(--mm-border);
}

.historico-resumo {
    background: var(--mm-bg) !important;
}

@media (max-width: 768px) {
    .ciclos-container {
        padding: 1rem;
    }
    
    .ciclos-hero-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .resumo-grid {
        grid-template-columns: 1fr;
    }
    
    .colaboradores-grid {
        grid-template-columns: 1fr;
    }
    
    .colaborador-actions {
        flex-direction: column;
    }
    
    .btn-card {
        width: 100%;
    }
}
</style>

<script>
// Variáveis globais
let currentCollaboratorId = null;
let currentCollaboratorName = null;
let currentPage = 1;
let currentCicloId = null;

// Função para validar horas (múltiplos de 0.5)
// NÃO aceita vírgula - bloqueia completamente
function validarHoras(valor, origem) {
    if (!valor || !valor.trim()) {
        return { valido: false, erro: 'Campo obrigatório' };
    }
    
    valor = valor.trim();
    
    // BLOQUEAR vírgula completamente (NÃO converter)
    if (valor.includes(',')) {
        return { 
            valido: false, 
            erro: 'Formato inválido. Use apenas números inteiros ou decimais com ponto (ex.: 1 ou 1.5). Apenas múltiplos de 0.5 são permitidos.' 
        };
    }
    
    // Bloquear formato 2:30
    if (valor.includes(':')) {
        return { 
            valido: false, 
            erro: 'Formato inválido. Use apenas números inteiros ou decimais com ponto (ex.: 1 ou 1.5). Apenas múltiplos de 0.5 são permitidos.' 
        };
    }
    
    try {
        const num = parseFloat(valor);
        if (isNaN(num)) {
            return { 
                valido: false, 
                erro: 'Formato inválido. Use apenas números inteiros ou decimais com ponto (ex.: 1 ou 1.5). Apenas múltiplos de 0.5 são permitidos.' 
            };
        }
        
        // Validar Folga utilizada: deve ser exatamente -8h (apenas se origem fornecida)
        if (origem && origem === 'Folga utilizada') {
            if (num !== -8.0) {
                return { valido: false, erro: 'Folga utilizada deve ser exatamente -8 horas.' };
            }
        } else if (origem !== undefined) {
            // Para outras origens (quando origem fornecida), não permitir negativo
            if (num < 0) {
                return { valido: false, erro: 'Valor não pode ser negativo' };
            }
        }
        // Se origem for undefined (ajustes), permitir negativo (será validado no backend)
        
        // Verificar se é múltiplo de 0.5
        const resto = Math.abs(num) % 0.5;
        if (resto > 0.001 && resto < 0.499) {
            return { 
                valido: false, 
                erro: 'Formato inválido. Use apenas números inteiros ou decimais com ponto (ex.: 1 ou 1.5). Apenas múltiplos de 0.5 são permitidos.' 
            };
        }
        
        return { valido: true, valor: num };
    } catch (e) {
        return { 
            valido: false, 
            erro: 'Formato inválido. Use apenas números inteiros ou decimais com ponto (ex.: 1 ou 1.5). Apenas múltiplos de 0.5 são permitidos.' 
        };
    }
}

// Abrir modal de lançamento
function abrirLancamento(collaboratorId, collaboratorName) {
    currentCollaboratorId = collaboratorId;
    currentCollaboratorName = collaboratorName;
    
    document.getElementById('lancamento_collaborator_id').value = collaboratorId;
    document.getElementById('lancamento_colaborador_nome').value = collaboratorName;
    document.getElementById('lancamento_data').value = new Date().toISOString().split('T')[0];
    document.getElementById('lancamento_origem').value = '';
    document.getElementById('lancamento_descricao').value = '';
    document.getElementById('lancamento_descricao_group').style.display = 'none';
    document.getElementById('lancamento_horas').value = '';
    document.getElementById('lancamento_horas').classList.remove('is-invalid');
    document.getElementById('lancamento_horas_error').textContent = '';
    document.getElementById('btnSalvarLancamento').disabled = true;
    
    const modal = new bootstrap.Modal(document.getElementById('modalLancamento'));
    modal.show();
}

// Abrir modal de histórico
function abrirHistorico(collaboratorId, collaboratorName) {
    currentCollaboratorId = collaboratorId;
    currentCollaboratorName = collaboratorName;
    currentPage = 1;
    
    document.getElementById('historico_colaborador_nome').textContent = collaboratorName;
    document.getElementById('historico_loading').style.display = 'block';
    document.getElementById('historico_content').style.display = 'none';
    document.getElementById('historico_empty').style.display = 'none';
    document.getElementById('btnAjustarHistorico').style.display = 'none';
    document.getElementById('btnPDFIndividual').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('modalHistorico'));
    modal.show();
    
    carregarHistorico(collaboratorId, 1);
}

// Abrir modal de ajuste
function abrirAjuste(cicloId, horasAtuais, descricaoAtual) {
    currentCicloId = cicloId;
    document.getElementById('ajustar_ciclo_id').value = cicloId;
    document.getElementById('ajustar_horas').value = horasAtuais;
    document.getElementById('ajustar_descricao').value = descricaoAtual || '';
    document.getElementById('ajustar_horas').classList.remove('is-invalid');
    document.getElementById('ajustar_horas_error').textContent = '';
    document.getElementById('btnSalvarAjuste').disabled = false;
    
    const modal = new bootstrap.Modal(document.getElementById('modalAjustar'));
    modal.show();
}

// Carregar histórico paginado
function carregarHistorico(collaboratorId, page) {
    fetch(`/ciclos/historico/${collaboratorId}?page=${page}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('historico_loading').style.display = 'none';
            
            if (!data.ok) {
                alert('Erro ao carregar histórico: ' + data.error);
                return;
            }
            
            if (data.registros.length === 0) {
                document.getElementById('historico_empty').style.display = 'block';
                return;
            }
            
            document.getElementById('historico_content').style.display = 'block';
            document.getElementById('btnAjustarHistorico').style.display = 'inline-block';
            document.getElementById('btnPDFIndividual').style.display = 'inline-block';
            
            // Preencher tabela
            const tbody = document.getElementById('historico_tbody');
            tbody.innerHTML = '';
            data.registros.forEach(reg => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = reg.data;
                row.insertCell(1).textContent = reg.origem;
                row.insertCell(2).textContent = reg.descricao;
                row.insertCell(3).textContent = reg.horas + 'h';
                {% if can_edit %}
                const cellAcoes = row.insertCell(4);
                const btnAjustar = document.createElement('button');
                btnAjustar.className = 'btn btn-sm btn-warning';
                btnAjustar.innerHTML = '<i class="bi bi-pencil"></i>';
                btnAjustar.onclick = () => abrirAjuste(reg.id, reg.horas, reg.descricao);
                cellAcoes.appendChild(btnAjustar);
                {% endif %}
            });
            
            // Preencher resumo
            document.getElementById('historico_total_horas').textContent = data.balance.total_horas.toFixed(1) + 'h';
            document.getElementById('historico_dias_fechados').textContent = data.balance.dias_completos;
            document.getElementById('historico_horas_restantes').textContent = data.balance.horas_restantes.toFixed(1) + 'h';
            document.getElementById('historico_valor_aproximado').textContent = 'R$ ' + data.balance.valor_aproximado.toFixed(2);
            
            // Preencher paginação
            const pagination = document.getElementById('historico_pagination');
            pagination.innerHTML = '';
            
            if (data.pagination.has_prev) {
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="carregarHistorico(${collaboratorId}, ${page - 1}); return false;">Anterior</a>`;
                pagination.appendChild(li);
            }
            
            for (let i = 1; i <= data.pagination.pages; i++) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === page ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#" onclick="carregarHistorico(${collaboratorId}, ${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            }
            
            if (data.pagination.has_next) {
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#" onclick="carregarHistorico(${collaboratorId}, ${page + 1}); return false;">Próxima</a>`;
                pagination.appendChild(li);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('historico_loading').style.display = 'none';
            alert('Erro ao carregar histórico');
        });
}

// Event listeners para modal de lançamento
document.addEventListener('DOMContentLoaded', function() {
    const lancamentoOrigem = document.getElementById('lancamento_origem');
    const lancamentoDescricaoGroup = document.getElementById('lancamento_descricao_group');
    const lancamentoDescricao = document.getElementById('lancamento_descricao');
    const lancamentoHoras = document.getElementById('lancamento_horas');
    const btnSalvarLancamento = document.getElementById('btnSalvarLancamento');
    
    if (lancamentoOrigem) {
        lancamentoOrigem.addEventListener('change', function() {
            if (this.value === 'Horas adicionais' || this.value === 'Outro') {
                lancamentoDescricaoGroup.style.display = 'block';
                lancamentoDescricao.required = true;
            } else {
                lancamentoDescricaoGroup.style.display = 'none';
                lancamentoDescricao.required = false;
                lancamentoDescricao.value = '';
            }
            validarFormLancamento();
        });
    }
    
    if (lancamentoHoras) {
        lancamentoHoras.addEventListener('input', function() {
            validarFormLancamento();
        });
    }
    
    // Validar formulário de lançamento
    function validarFormLancamento() {
        const data = document.getElementById('lancamento_data').value;
        const origem = document.getElementById('lancamento_origem').value;
        const descricao = document.getElementById('lancamento_descricao').value;
        const horas = document.getElementById('lancamento_horas').value;
        
        let valido = true;
        
        if (!data || !origem || !horas) {
            valido = false;
        }
        
        if ((origem === 'Horas adicionais' || origem === 'Outro') && !descricao.trim()) {
            valido = false;
        }
        
        const validacaoHoras = validarHoras(horas, origem);
        if (!validacaoHoras.valido) {
            lancamentoHoras.classList.add('is-invalid');
            document.getElementById('lancamento_horas_error').textContent = validacaoHoras.erro;
            valido = false;
        } else {
            lancamentoHoras.classList.remove('is-invalid');
            document.getElementById('lancamento_horas_error').textContent = '';
        }
        
        btnSalvarLancamento.disabled = !valido;
    }
    
    // Botão Registrar Pagamento
    const btnRegistrarPagamento = document.getElementById('btnRegistrarPagamento');
    if (btnRegistrarPagamento) {
        btnRegistrarPagamento.addEventListener('click', function() {
            abrirModalFechamento();
        });
    }
    
    // Botão Confirmar Fechamento
    const btnConfirmarFechamento = document.getElementById('btnConfirmarFechamento');
    if (btnConfirmarFechamento) {
        btnConfirmarFechamento.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja fechar o ciclo? Esta ação não pode ser desfeita.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{{ url_for("ciclos.confirmar_fechamento") }}';
                
                const observacoes = document.createElement('input');
                observacoes.type = 'hidden';
                observacoes.name = 'observacoes';
                observacoes.value = document.getElementById('fechamento_observacoes').value;
                form.appendChild(observacoes);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    }
    
    // Botão PDF Individual
    const btnPDFIndividual = document.getElementById('btnPDFIndividual');
    if (btnPDFIndividual) {
        btnPDFIndividual.addEventListener('click', function() {
            window.open(`/ciclos/pdf/individual/${currentCollaboratorId}`, '_blank');
        });
    }
    
    // Botão PDF Geral
    const btnPDFGeral = document.getElementById('btnPDFGeral');
    if (btnPDFGeral) {
        btnPDFGeral.addEventListener('click', function() {
            window.open('{{ url_for("ciclos.pdf_geral") }}', '_blank');
        });
    }
    
    // Validar formulário de ajuste
    const ajustarHoras = document.getElementById('ajustar_horas');
    const btnSalvarAjuste = document.getElementById('btnSalvarAjuste');
    if (ajustarHoras && btnSalvarAjuste) {
        ajustarHoras.addEventListener('input', function() {
            // Para ajustes, não temos origem - validar apenas formato (permitir negativo)
            const validacao = validarHoras(this.value, undefined);
            if (validacao.valido) {
                this.classList.remove('is-invalid');
                document.getElementById('ajustar_horas_error').textContent = '';
                btnSalvarAjuste.disabled = false;
            } else {
                this.classList.add('is-invalid');
                document.getElementById('ajustar_horas_error').textContent = validacao.erro;
                btnSalvarAjuste.disabled = true;
            }
        });
        
        // Form de ajuste
        const formAjustar = document.getElementById('formAjustar');
        if (formAjustar) {
            formAjustar.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const cicloId = document.getElementById('ajustar_ciclo_id').value;
                
                fetch(`/ciclos/ajustar/${cicloId}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        bootstrap.Modal.getInstance(document.getElementById('modalAjustar')).hide();
                        bootstrap.Modal.getInstance(document.getElementById('modalHistorico')).hide();
                        location.reload();
                    } else {
                        alert('Erro ao ajustar registro: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao ajustar registro');
                });
            });
        }
    }
});

// Abrir modal de fechamento
function abrirModalFechamento() {
    document.getElementById('fechamento_loading').style.display = 'block';
    document.getElementById('fechamento_content').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('modalFechamento'));
    modal.show();
    
    fetch('{{ url_for("ciclos.resumo_fechamento") }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('fechamento_loading').style.display = 'none';
            
            if (!data.ok) {
                alert('Erro ao carregar resumo: ' + data.error);
                return;
            }
            
            document.getElementById('fechamento_content').style.display = 'block';
            
            // Preencher avisos
            if (data.avisos && data.avisos.length > 0) {
                document.getElementById('fechamento_avisos').style.display = 'block';
                const avisosList = document.getElementById('fechamento_avisos_list');
                avisosList.innerHTML = '';
                data.avisos.forEach(aviso => {
                    const li = document.createElement('li');
                    li.textContent = aviso;
                    avisosList.appendChild(li);
                });
            } else {
                document.getElementById('fechamento_avisos').style.display = 'none';
            }
            
            // Preencher tabela
            const tbody = document.getElementById('fechamento_tbody');
            tbody.innerHTML = '';
            data.colaboradores.forEach(colab => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = colab.nome;
                row.insertCell(1).textContent = colab.total_horas + 'h';
                row.insertCell(2).textContent = colab.dias_completos + ' dias';
                row.insertCell(3).textContent = colab.horas_restantes + 'h';
                row.insertCell(4).textContent = 'R$ ' + colab.valor.toFixed(2);
            });
            
            // Preencher totais
            document.getElementById('fechamento_total_horas').textContent = data.totais.total_horas + 'h';
            document.getElementById('fechamento_total_dias').textContent = data.totais.total_dias + ' dias';
            document.getElementById('fechamento_total_horas_restantes').textContent = data.totais.total_horas_restantes + 'h';
            document.getElementById('fechamento_total_valor').textContent = 'R$ ' + data.totais.total_valor.toFixed(2);
        })
        .catch(error => {
            console.error('Erro:', error);
            document.getElementById('fechamento_loading').style.display = 'none';
            alert('Erro ao carregar resumo');
        });
}
</script>
{% endblock %}
