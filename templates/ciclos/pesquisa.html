{% extends 'base.html' %}
{% block title %}Pesquisa de Ciclos — MultiMax{% endblock %}

{% block content %}
<div class="ciclos-container">
    <div class="ciclos-hero" style="margin-bottom: 1.25rem;">
        <div class="ciclos-hero-content">
            <div>
                <h1 class="ciclos-title">
                    <i class="bi bi-search ciclos-title-icon"></i>
                    Pesquisa de Ciclos
                </h1>
                <p class="ciclos-subtitle">Busque por ciclo semanal (ex.: "Ciclo 1 | Janeiro" ou "Dezembro | Janeiro")</p>
            </div>
            <div class="ciclos-hero-actions">
                <a href="{{ url_for('ciclos.index') }}" class="btn-action btn-action-secondary" style="text-decoration:none;">
                    <i class="bi bi-arrow-left"></i>
                    <span>Voltar</span>
                </a>
            </div>
        </div>
    </div>

    <div class="resumo-geral-card" style="margin-bottom: 1.25rem;">
        <div class="resumo-header">
            <h3 class="resumo-title">
                <i class="bi bi-funnel"></i>
                Filtros
            </h3>
        </div>
        <div style="padding: 1rem;">
            <form method="GET" action="{{ url_for('ciclos.pesquisa') }}" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:end;">
                <div style="min-width: 280px; flex: 1;">
                    <label class="form-label-modern" style="display:block; margin-bottom:0.25rem;">Buscar</label>
                    <input type="text" name="q" value="{{ q }}" class="form-input-modern" placeholder="Ex.: Janeiro ou Ciclo 1 | Janeiro">
                </div>
                <div style="min-width: 200px;">
                    <label class="form-label-modern" style="display:block; margin-bottom:0.25rem;">Ciclo mensal (opcional)</label>
                    <input type="number" name="ciclo_id" value="{{ filtro_ciclo_id or '' }}" class="form-input-modern" placeholder="Ex.: 12">
                </div>
                <button type="submit" class="btn-action btn-action-primary">
                    <i class="bi bi-search"></i>
                    <span>Pesquisar</span>
                </button>
            </form>
        </div>
    </div>

    {% if semanas and (semanas|length) > 0 %}
        <div class="resumo-geral-card" style="margin-bottom: 1.25rem;">
            <div class="resumo-header">
                <h3 class="resumo-title">
                    <i class="bi bi-file-earmark-pdf"></i>
                    PDFs rápidos
                </h3>
            </div>
            <div style="padding: 1rem; display:flex; gap: 0.75rem; flex-wrap: wrap; align-items: end;">
                {% if ciclo_ids %}
                    {% for cid in ciclo_ids %}
                    <a class="btn-action btn-action-primary" href="{{ url_for('ciclos.pdf_geral_ciclo', ciclo_id=cid) }}">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span>PDF Geral (Ciclo {{ cid }})</span>
                    </a>
                    {% endfor %}
                {% endif %}

                <form method="GET" action="#" onsubmit="return false;" style="display:flex; gap:0.5rem; align-items:end;">
                    <div style="min-width: 160px;">
                        <label class="form-label-modern" style="display:block; margin-bottom:0.25rem;">Ciclo</label>
                        <select id="pdfCicloSelect" class="form-input-modern">
                            {% for cid in ciclo_ids %}
                            <option value="{{ cid }}">{{ cid }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="min-width: 260px;">
                        <label class="form-label-modern" style="display:block; margin-bottom:0.25rem;">PDF Individual (por colaborador)</label>
                        <select id="pdfIndSelect" class="form-input-modern">
                            <option value="">Selecione...</option>
                            {% for c in colaboradores %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn-action btn-action-secondary" onclick="openPdfIndividualCiclo()">
                        <i class="bi bi-file-earmark-pdf"></i>
                        <span>Gerar</span>
                    </button>
                </form>
            </div>
            {% if q_month_name %}
            <div style="padding: 0 1rem 1rem 1rem; color:#6b7280; font-size:0.875rem;">
                Busca por mês detectada: <strong>{{ q_month_name }}</strong> (inclui transições, ex.: "Dezembro | {{ q_month_name }}").
            </div>
            {% endif %}
        </div>

        {% for s in semanas %}
        <div class="db-card-modern" style="margin-bottom: 1rem;">
            <div class="db-card-header-modern">
                <h3 class="db-card-title">
                    <i class="bi bi-calendar-week"></i>
                    {{ s.label }} (Ciclo mensal {{ s.ciclo_id }})
                </h3>
                <div class="db-card-badges">
                    <span class="db-badge-modern db-badge-info">{{ s.week_start.strftime('%d/%m/%Y') }} — {{ s.week_end.strftime('%d/%m/%Y') }}</span>
                </div>
            </div>
            <div class="db-card-body-modern">
                {% if s.resumo %}
                <div class="resumo" style="margin-bottom: 1rem;">
                    <div class="resumo-item">
                        <span class="resumo-label">Horas Totais:</span> {{ "%.1f"|format(s.resumo.total_horas) }}h
                    </div>
                    <div class="resumo-item">
                        <span class="resumo-label">Dias Fechados:</span> {{ s.resumo.dias_completos }}
                    </div>
                    <div class="resumo-item">
                        <span class="resumo-label">Horas Restantes:</span> {{ "%.1f"|format(s.resumo.horas_restantes) }}h
                    </div>
                    <div class="resumo-item">
                        <span class="resumo-label">Valor Aproximado:</span> R$ {{ "%.2f"|format(s.resumo.valor_aproximado) }}
                    </div>
                </div>
                {% endif %}
                {% if (s.folgas and s.folgas|length > 0) or (s.horas and s.horas|length > 0) or (s.ocorrencias and s.ocorrencias|length > 0) %}
                <table class="ferias-table-modern" style="margin-top: 0.5rem;">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Colaborador</th>
                            <th>Tipo</th>
                            <th>Detalhes</th>
                            <th>Valor</th>
                            <th>Observação</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in (s.folgas or []) %}
                        <tr>
                            <td>{{ f.data_folga.strftime('%d/%m/%Y') }}</td>
                            <td>{{ f.nome_colaborador }}</td>
                            <td>Folga</td>
                            <td>{{ 'Folga adicional' if f.tipo == 'adicional' else 'Folga usada' }}</td>
                            <td>{{ f.dias }} dia(s)</td>
                            <td>{{ f.observacao or '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% for h in (s.horas or []) %}
                        <tr>
                            <td>{{ h.data_lancamento.strftime('%d/%m/%Y') }}</td>
                            <td>{{ h.nome_colaborador }}</td>
                            <td>Horas Extras</td>
                            <td>{{ h.origem }}</td>
                            <td>{{ "%.1f"|format(h.valor_horas) }}h</td>
                            <td>{{ h.descricao or '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% for o in (s.ocorrencias or []) %}
                        <tr>
                            <td>{{ o.data_ocorrencia.strftime('%d/%m/%Y') }}</td>
                            <td>{{ o.nome_colaborador }}</td>
                            <td>Ocorrência</td>
                            <td>{{ o.tipo }}</td>
                            <td>-</td>
                            <td>{{ o.descricao or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state-small-modern" style="margin-top:0.5rem;">
                    <i class="bi bi-inbox"></i>
                    <p>Nenhum registro neste ciclo</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state-large" style="margin-top: 2rem;">
            <i class="bi bi-search"></i>
            <h3>Nenhum ciclo encontrado</h3>
            <p>Tente buscar por "Janeiro", "Ciclo 1", ou "Dezembro | Janeiro".</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function openPdfIndividualCiclo() {
    const cicloSel = document.getElementById('pdfCicloSelect');
    const cicloId = cicloSel ? cicloSel.value : '';
    if (!cicloId) {
        alert('Selecione um ciclo.');
        return;
    }
    const sel = document.getElementById('pdfIndSelect');
    if (!sel || !sel.value) {
        alert('Selecione um colaborador.');
        return;
    }
    const collaboratorId = sel.value;
    const url = `/ciclos/pdf/individual/${collaboratorId}/ciclo/${cicloId}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}
