{% extends 'base.html' %}
{% block title %}Banco de Dados — MultiMax{% endblock %}

{% block breadcrumb %}
<span class="mm-breadcrumb-separator">/</span>
<span>Banco de Dados</span>
{% endblock %}

{% block content %}
<div class="mm-page-header mm-flex mm-items-center mm-justify-between mm-mb-6">
    <div>
        <h1 class="mm-page-title">Banco de Dados</h1>
        <p class="mm-text-muted">Gerencie backups e monitore a saúde do sistema</p>
    </div>
    <div class="mm-flex mm-gap-3">
        <form method="post" action="{{ url_for('dbadmin.backup_now') }}">
            <button type="submit" class="mm-btn mm-btn-primary">
                <i class="bi bi-cloud-arrow-up"></i>
                Criar Backup
            </button>
        </form>
        {% if is_sqlite %}
        <form method="post" action="{{ url_for('dbadmin.restaurar_snapshot') }}" onsubmit="return confirm('Restaurar o último snapshot? Esta ação sobrescreve o banco atual.')">
            <button type="submit" class="mm-btn mm-btn-outline">
                <i class="bi bi-arrow-counterclockwise"></i>
                Restaurar Snapshot
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="mm-card mm-mb-6">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-cpu mm-text-primary"></i>
            Uso de Recursos da Máquina
        </h3>
        <span class="mm-badge mm-badge-primary">Atualiza a cada 1s</span>
    </div>
    <div class="mm-card-body">
        <div class="mm-grid mm-grid-cols-2 mm-gap-4">
            <div>
                <div class="mm-label">CPU (%)</div>
                <canvas id="cpuChart" height="120"></canvas>
            </div>
            <div>
                <div class="mm-label">Memória (%)</div>
                <canvas id="memChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="mm-card-footer">
        <span class="mm-text-sm mm-text-muted">Origem: host local do MultiMax</span>
    </div>
</div>

<div id="problems_and_diagnostics" class="mm-card mm-mb-6">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-activity mm-text-primary"></i>
            Diagnóstico Completo
        </h3>
        <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" onclick="reloadDiag()">
            <i class="bi bi-arrow-repeat"></i>
            Recarregar
        </button>
    </div>
    <div class="mm-card-body" style="padding: 0;">
        <iframe id="dbStatusFrame" src="{{ url_for('_dbstatus') }}" style="width:100%;border:none;border-radius:0 0 var(--mm-radius-lg) var(--mm-radius-lg);"></iframe>
    </div>
</div>

<div class="mm-info-box mm-mb-6">
    <i class="bi bi-info-circle"></i>
    <span>Backups automáticos a cada 15 minutos (mínimo). Mantém no máximo 20 mais recentes. Inclui backup-24h.sqlite atualizado diariamente às 00h.</span>
</div>

{% if not is_sqlite %}
<div class="mm-alert mm-alert-warning mm-mb-6">
    <i class="bi bi-exclamation-triangle"></i>
    <span>Backup automático está disponível apenas quando o banco é SQLite.</span>
</div>
{% endif %}

{% if daily_backup %}
<div class="mm-card mm-card-highlight mm-card-success mm-mb-6">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-calendar-check mm-text-success"></i>
            Backup Diário (24h)
        </h3>
        <span class="mm-badge mm-badge-success">
            <i class="bi bi-clock-history"></i>
            Atualizado diariamente às 00h
        </span>
    </div>
    <div class="mm-card-body">
        <div class="mm-grid mm-grid-cols-3 mm-gap-4 mm-mb-4">
            <div class="mm-stat-item">
                <span class="mm-stat-label">Arquivo</span>
                <span class="mm-stat-value">{{ daily_backup.name }}</span>
            </div>
            <div class="mm-stat-item">
                <span class="mm-stat-label">Tamanho</span>
                <span class="mm-stat-value">{{ '%.2f'|format((daily_backup.size or 0)/1024/1024) }} MB</span>
            </div>
            <div class="mm-stat-item">
                <span class="mm-stat-label">Última atualização</span>
                <span class="mm-stat-value">{{ daily_backup.mtime_str }}</span>
            </div>
        </div>
        <a class="mm-btn mm-btn-success" href="{{ url_for('dbadmin.download', name=daily_backup.name) }}">
            <i class="bi bi-download"></i>
            Baixar Backup 24h
        </a>
    </div>
</div>
{% endif %}

<div class="mm-card mm-mb-6">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-archive mm-text-info"></i>
            Backups Recentes
        </h3>
        <a class="mm-btn mm-btn-sm mm-btn-outline" href="{{ url_for('dbadmin.index') }}">
            <i class="bi bi-arrow-repeat"></i>
            Atualizar
        </a>
    </div>
    <div class="mm-card-body" style="padding: 0;">
        <div class="mm-table-wrapper">
            <table class="mm-table">
                <thead>
                    <tr>
                        <th>Arquivo</th>
                        <th style="text-align: right;">Tamanho</th>
                        <th>Modificado</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for it in backups %}
                    <tr>
                        <td>
                            <div class="mm-flex mm-items-center mm-gap-2">
                                <i class="bi bi-file-earmark-zip mm-text-muted"></i>
                                {{ it.name }}
                            </div>
                        </td>
                        <td style="text-align: right;">
                            <span class="mm-badge">{{ '%.2f'|format((it.size or 0)/1024/1024) }} MB</span>
                        </td>
                        <td>{{ it.mtime_str }}</td>
                        <td style="text-align: right;">
                            <div class="mm-flex mm-gap-2 mm-justify-end">
                                <a class="mm-btn mm-btn-sm mm-btn-outline" href="{{ url_for('dbadmin.download', name=it.name) }}" title="Baixar">
                                    <i class="bi bi-download"></i>
                                </a>
                                {% if is_sqlite %}
                                <form method="post" action="{{ url_for('dbadmin.restaurar', name=it.name) }}" onsubmit="return confirm('Restaurar este backup? Esta ação sobrescreve o banco atual.')" style="display: inline;">
                                    <button class="mm-btn mm-btn-sm mm-btn-primary" type="submit" title="Restaurar">
                                        <i class="bi bi-arrow-counterclockwise"></i>
                                    </button>
                                </form>
                                {% endif %}
                                <form method="post" action="{{ url_for('dbadmin.excluir', name=it.name) }}" onsubmit="return confirm('Excluir backup {{ it.name }}?')" style="display: inline;">
                                    <button class="mm-btn mm-btn-sm mm-btn-danger" type="submit" title="Excluir">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="mm-empty-cell">
                            <div class="mm-empty-state mm-py-8">
                                <i class="bi bi-archive" style="font-size: 2rem;"></i>
                                <p>Nenhum backup disponível</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="mm-card-footer mm-flex mm-items-center mm-justify-between">
        <div class="mm-text-sm mm-text-muted">Página {{ page }} de {{ total_pages }}</div>
        <div class="mm-pagination">
            <a class="mm-btn mm-btn-sm mm-btn-outline {% if page <= 1 %}mm-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?page={{ page-1 if page>1 else 1 }}">
                <i class="bi bi-chevron-left"></i> Anterior
            </a>
            <a class="mm-btn mm-btn-sm mm-btn-outline {% if page >= total_pages %}mm-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?page={{ page+1 if page<total_pages else total_pages }}">
                Próximo <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<script>
var __mmChartsLoaded = false;
function ensureChartJs(cb){
  if (window.Chart) { __mmChartsLoaded = true; cb(); return; }
  if (__mmChartsLoaded) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
  s.onload = function(){ __mmChartsLoaded = true; cb(); };
  document.head.appendChild(s);
}
function startResourceCharts(){
  var cpuCtx = document.getElementById('cpuChart');
  var memCtx = document.getElementById('memChart');
  if (!cpuCtx || !memCtx) return;
  var labels = [];
  var cpuData = [];
  var memData = [];
  var cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'CPU %', data: cpuData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', tension: 0.25 }] },
    options: { responsive: true, animation: false, scales: { y: { beginAtZero: true, max: 100 } } }
  });
  var memChart = new Chart(memCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'Memória %', data: memData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.15)', tension: 0.25 }] },
    options: { responsive: true, animation: false, scales: { y: { beginAtZero: true, max: 100 } } }
  });
  function pushPoint(ts, cpu, mem){
    var t = new Date(ts);
    var hh = String(t.getHours()).padStart(2,'0');
    var mm = String(t.getMinutes()).padStart(2,'0');
    var ss = String(t.getSeconds()).padStart(2,'0');
    labels.push(hh+':'+mm+':'+ss);
    cpuData.push(cpu);
    memData.push(mem);
    if (labels.length > 60){ labels.shift(); cpuData.shift(); memData.shift(); }
    cpuChart.update();
    memChart.update();
  }
  async function fetchMetrics(){
    try{
      var resp = await fetch("{{ url_for('dbadmin.metrics') }}");
      var json = await resp.json();
      if (!json || !json.ok || json.cpu == null || json.mem == null) return;
      pushPoint(json.ts, json.cpu, json.mem);
    } catch(e){}
  }
  fetchMetrics();
  setInterval(fetchMetrics, 1000);
}
function resizeDbFrame() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  try {
    var doc = f.contentWindow && f.contentWindow.document;
    if (!doc) return;
    var h1 = doc.documentElement ? doc.documentElement.scrollHeight : 0;
    var h2 = doc.body ? doc.body.scrollHeight : 0;
    var h = Math.max(h1, h2);
    if (h && h > 0) {
      f.style.height = (h + 16) + 'px';
    }
  } catch (e) {
    // ignore
  }
}
function reloadDiag() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  var base = f.src.split('?')[0];
  f.src = base + '?t=' + Date.now();
}
document.addEventListener('DOMContentLoaded', function() {
  var f = document.getElementById('dbStatusFrame');
  if (f) {
    f.addEventListener('load', resizeDbFrame);
  }
  ensureChartJs(startResourceCharts);
});
</script>
<div class="mm-card">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-person-check mm-text-success"></i>
            Histórico de Conexões
        </h3>
        <span class="mm-badge mm-badge-info">Últimos logins</span>
    </div>
    <div class="mm-card-body" style="padding: 0;">
        <div class="mm-table-wrapper">
            <table class="mm-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>IP</th>
                        <th>Navegador</th>
                        <th>Data/Hora</th>
                    </tr>
                </thead>
                <tbody>
                    {% for login in logins %}
                    <tr>
                        <td>
                            <div class="mm-flex mm-items-center mm-gap-2">
                                <div class="mm-avatar mm-avatar-sm">
                                    <i class="bi bi-person"></i>
                                </div>
                                {{ login.username or '-' }}
                            </div>
                        </td>
                        <td><code class="mm-code">{{ login.ip_address or '-' }}</code></td>
                        <td>
                            <span class="mm-text-sm mm-text-muted">{{ (login.user_agent or '-')[:50] }}{% if login.user_agent and login.user_agent|length > 50 %}...{% endif %}</span>
                        </td>
                        <td>{{ login.login_at.strftime('%d/%m/%Y %H:%M') if login.login_at else '-' }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="mm-empty-cell">
                            <div class="mm-empty-state mm-py-8">
                                <i class="bi bi-person-x" style="font-size: 2rem;"></i>
                                <p>Nenhum registro de login</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% if logins_pag %}
    <div class="mm-card-footer mm-flex mm-items-center mm-justify-between">
        <div class="mm-text-sm mm-text-muted">Página {{ logins_pag.page }} de {{ logins_pag.pages or 1 }}</div>
        <div class="mm-pagination">
            <a class="mm-btn mm-btn-sm mm-btn-outline {% if not logins_pag.has_prev %}mm-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.prev_num or 1 }}">
                <i class="bi bi-chevron-left"></i> Anterior
            </a>
            <a class="mm-btn mm-btn-sm mm-btn-outline {% if not logins_pag.has_next %}mm-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.next_num or logins_pag.pages or 1 }}">
                Próximo <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.mm-page-header {
    margin-bottom: var(--mm-space-6);
}

.mm-page-title {
    font-size: var(--mm-text-2xl);
    font-weight: var(--mm-font-bold);
    color: var(--mm-text-primary);
    margin: 0 0 var(--mm-space-1) 0;
}

.mm-info-box {
    display: flex;
    align-items: center;
    gap: var(--mm-space-3);
    padding: var(--mm-space-4);
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: var(--mm-radius-lg);
    font-size: var(--mm-text-sm);
    color: var(--mm-text-secondary);
}

.mm-info-box i {
    color: var(--mm-info);
    font-size: 1.25rem;
}

.mm-card-highlight {
    border-left: 4px solid;
}

.mm-card-success {
    border-left-color: var(--mm-success);
}

.mm-stat-item {
    display: flex;
    flex-direction: column;
    gap: var(--mm-space-1);
}

.mm-stat-label {
    font-size: var(--mm-text-xs);
    color: var(--mm-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.mm-stat-value {
    font-size: var(--mm-text-base);
    font-weight: var(--mm-font-semibold);
    color: var(--mm-text-primary);
}

.mm-card-footer {
    padding: var(--mm-space-4);
    background: var(--mm-bg-secondary);
    border-top: 1px solid var(--mm-border);
}

.mm-pagination {
    display: flex;
    gap: var(--mm-space-2);
}

.mm-disabled {
    opacity: 0.5;
    pointer-events: none;
}

.mm-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--mm-space-2);
    color: var(--mm-text-muted);
    padding: var(--mm-space-8);
}

.mm-empty-state i {
    opacity: 0.5;
}

.mm-empty-cell {
    text-align: center;
    padding: 0 !important;
}

.mm-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--mm-bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--mm-text-muted);
}

.mm-avatar-sm {
    width: 28px;
    height: 28px;
    font-size: 0.875rem;
}

.mm-code {
    font-family: 'JetBrains Mono', monospace;
    font-size: var(--mm-text-xs);
    background: var(--mm-bg-secondary);
    padding: var(--mm-space-1) var(--mm-space-2);
    border-radius: var(--mm-radius-sm);
    color: var(--mm-text-primary);
}

.mm-py-8 {
    padding-top: var(--mm-space-8);
    padding-bottom: var(--mm-space-8);
}

@media (max-width: 768px) {
    .mm-grid-cols-3 {
        grid-template-columns: 1fr;
    }
    
    .mm-page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--mm-space-4);
    }
    
    .mm-page-header .mm-flex {
        flex-wrap: wrap;
    }
}
</style>

<script>
function reloadDiag() {
    const f = document.getElementById('dbStatusFrame');
    if (!f) return;
    f.src = "{{ url_for('_dbstatus') }}?ts=" + Date.now();
}
</script>
{% endblock %}
