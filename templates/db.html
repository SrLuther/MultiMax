{% extends 'base.html' %}
{% block title %}Banco de Dados — MultiMax{% endblock %}

{% block content %}
<div class="db-container">
    <!-- Hero Header -->
    <div class="db-hero">
        <div class="db-hero-content">
            <div>
                <h1 class="db-title">
                    <i class="bi bi-database db-title-icon"></i>
                    Banco de Dados
                </h1>
                <p class="db-subtitle">Painel Técnico de Desenvolvimento e Monitoramento</p>
            </div>
            <div class="db-hero-actions">
                <form method="post" action="{{ url_for('dbadmin.backup_now') }}">
                    <button type="submit" class="btn-action btn-action-primary">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <span>Criar Backup</span>
                    </button>
                </form>
                {% if is_sqlite %}
                <form method="post" action="{{ url_for('dbadmin.restaurar_snapshot') }}" onsubmit="return confirm('Restaurar o último snapshot? Esta ação sobrescreve o banco atual.')">
                    <button type="submit" class="btn-action btn-action-secondary">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        <span>Restaurar Snapshot</span>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Info Box -->
    <div class="db-info-box-modern">
        <i class="bi bi-info-circle"></i>
        <div>
            <strong>Backups Automáticos</strong>
            <p>Backups automáticos a cada 15 minutos (mínimo). Mantém no máximo 20 mais recentes. Inclui backup-24h.sqlite atualizado diariamente às 00h.</p>
        </div>
    </div>

    {% if not is_sqlite %}
    <div class="db-alert-modern db-alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        <div>
            <strong>Atenção</strong>
            <p>Backup automático está disponível apenas quando o banco é SQLite.</p>
        </div>
    </div>
    {% endif %}

    <!-- Card de Monitoramento de Atualizações Git -->
    <div class="db-card-modern db-card-highlight" id="gitUpdateCard">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-git"></i>
                Monitoramento de Atualizações Git
            </h3>
            <button type="button" class="db-btn-modern db-btn-outline" onclick="refreshGitStatus()" id="refreshGitBtn">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </button>
        </div>
        <div class="db-card-body-modern">
            <div class="db-git-info">
                <div class="db-git-repo-info">
                    <div class="db-git-repo-item">
                        <span class="db-git-label">Repositório:</span>
                        <a href="https://github.com/SrLuther/MultiMax" target="_blank" class="db-git-link">
                            https://github.com/SrLuther/MultiMax
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    <div class="db-git-repo-item">
                        <span class="db-git-label">Branch:</span>
                        <span class="db-git-value">nova-versao-deploy</span>
                    </div>
                </div>
                
                <div class="db-git-status-grid" id="gitStatusGrid">
                    <div class="db-git-status-item">
                        <div class="db-git-status-label">Versão Local Atual</div>
                        <div class="db-git-status-value" id="currentVersion">Carregando...</div>
                        <small class="db-git-status-hint">Versão aplicada no servidor</small>
                    </div>
                    <div class="db-git-status-item">
                        <div class="db-git-status-label">Commit Local</div>
                        <div class="db-git-status-value" id="currentCommit">Carregando...</div>
                        <small class="db-git-status-hint">Commit atual do sistema</small>
                    </div>
                    <div class="db-git-status-item">
                        <div class="db-git-status-label">Último Commit Remoto</div>
                        <div class="db-git-status-value" id="latestCommit">Carregando...</div>
                        <small class="db-git-status-hint">Commit mais recente no GitHub</small>
                    </div>
                    <div class="db-git-status-item">
                        <div class="db-git-status-label">Mensagem do Commit</div>
                        <div class="db-git-status-value db-git-commit-message" id="commitMessage">Carregando...</div>
                        <small class="db-git-status-hint">Descrição da última alteração</small>
                    </div>
                </div>
                
                <div class="db-git-update-status" id="updateStatus">
                    <div class="db-git-update-indicator" id="updateIndicator">
                        <i class="bi bi-hourglass-split"></i>
                        <span>Verificando atualizações...</span>
                    </div>
                </div>
                
                <div class="db-git-actions">
                    <button type="button" class="db-btn-modern db-btn-primary db-btn-lg" id="applyUpdateBtn" onclick="showUpdateConfirmation()" disabled style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-cloud-arrow-down"></i>
                            <span>Aplicar Atualização Completa</span>
                        </div>
                        <small style="font-size: 0.75rem; opacity: 0.8; font-weight: normal;">
                            Inclui rebuild do container
                        </small>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Consolidado -->
    <div class="db-card-modern db-card-highlight">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-speedometer2"></i>
                Dashboard Consolidado
            </h3>
            <button type="button" class="db-btn-modern db-btn-outline" onclick="refreshDashboard()">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </button>
        </div>
        <div class="db-card-body-modern">
            <div class="db-dashboard-grid">
                <div class="db-dashboard-score-card">
                    <div class="db-dashboard-score-value" id="healthScoreValue">{{ health_score or 0 }}</div>
                    <div class="db-dashboard-score-label">Score de Saúde</div>
                    <div class="db-dashboard-score-bar">
                        <div class="db-dashboard-score-fill" id="healthScoreBar" style="width: {{ health_score or 0 }}%"></div>
                    </div>
                </div>
                <div class="db-dashboard-stats-grid">
                    <div class="db-dashboard-stat">
                        <div class="db-dashboard-stat-icon db-dashboard-stat-alerts">
                            <i class="bi bi-bell"></i>
                        </div>
                        <div class="db-dashboard-stat-content">
                            <div class="db-dashboard-stat-value" id="activeAlertsCount">{{ active_alerts|length if active_alerts else 0 }}</div>
                            <div class="db-dashboard-stat-label">Alertas Ativos</div>
                        </div>
                    </div>
                    <div class="db-dashboard-stat">
                        <div class="db-dashboard-stat-icon db-dashboard-stat-incidents">
                            <i class="bi bi-exclamation-triangle"></i>
                        </div>
                        <div class="db-dashboard-stat-content">
                            <div class="db-dashboard-stat-value" id="openIncidentsCount">{{ incidents|selectattr('status', 'equalto', 'open')|list|length }}</div>
                            <div class="db-dashboard-stat-label">Incidentes Abertos</div>
                        </div>
                    </div>
                    {% if db_stats %}
                    <div class="db-dashboard-stat">
                        <div class="db-dashboard-stat-icon db-dashboard-stat-db">
                            <i class="bi bi-database"></i>
                        </div>
                        <div class="db-dashboard-stat-content">
                            <div class="db-dashboard-stat-value">{{ '%.1f'|format(db_stats.size_mb) if db_stats.size_mb else '-' }} MB</div>
                            <div class="db-dashboard-stat-label">Tamanho do Banco</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if disk_prediction and disk_prediction.days_remaining %}
                    <div class="db-dashboard-stat">
                        <div class="db-dashboard-stat-icon db-dashboard-stat-disk">
                            <i class="bi bi-hdd"></i>
                        </div>
                        <div class="db-dashboard-stat-content">
                            <div class="db-dashboard-stat-value">{{ disk_prediction.days_remaining }} dias</div>
                            <div class="db-dashboard-stat-label">Previsão Disco Cheio</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas Proativos -->
    {% if active_alerts %}
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-bell-fill"></i>
                Alertas Ativos
            </h3>
            <span class="db-badge-modern db-badge-warning">{{ active_alerts|length }} ativo(s)</span>
        </div>
        <div class="db-card-body-modern">
            <div class="db-alerts-list" id="alertsList">
                {% for alert in active_alerts %}
                <div class="db-alert-item db-alert-{{ alert.severity }}">
                    <div class="db-alert-icon">
                        {% if alert.severity == 'critical' %}
                        <i class="bi bi-x-circle-fill"></i>
                        {% elif alert.severity == 'warning' %}
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        {% else %}
                        <i class="bi bi-info-circle-fill"></i>
                        {% endif %}
                    </div>
                    <div class="db-alert-content">
                        <div class="db-alert-title">{{ alert.message }}</div>
                        <div class="db-alert-details">
                            {{ alert.metric_type }}: {{ alert.current_value }} (limite: {{ alert.threshold_value }})
                            <span class="db-alert-time">{{ alert.created_at.strftime('%d/%m/%Y %H:%M') if alert.created_at else '-' }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Uso de Recursos -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-cpu"></i>
                Uso de Recursos da Máquina
            </h3>
            <div class="db-card-badges">
                <span class="db-badge-modern db-badge-info" id="serverClock">Servidor — --:--:--</span>
                <span class="db-badge-modern db-badge-primary">Atualiza a cada 1s</span>
            </div>
        </div>
        <div class="db-card-body-modern">
            <div class="db-charts-grid">
                <div class="db-chart-card">
                    <div class="db-chart-header">
                        <div class="db-chart-label">
                            <i class="bi bi-cpu-fill"></i>
                            CPU (%)
                        </div>
                    </div>
                    <div class="db-chart-wrapper">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
                <div class="db-chart-card">
                    <div class="db-chart-header">
                        <div class="db-chart-label">
                            <i class="bi bi-memory"></i>
                            Memória (%)
                        </div>
                    </div>
                    <div class="db-chart-wrapper">
                        <canvas id="memChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="db-card-footer-modern">
            <i class="bi bi-server"></i>
            <span>Origem: host local do MultiMax</span>
        </div>
    </div>

    <!-- Health Checks -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-heart-pulse"></i>
                Monitoramento de Serviços
            </h3>
            <button type="button" class="db-btn-modern db-btn-outline" onclick="refreshHealthChecks()">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </button>
        </div>
        <div class="db-card-body-modern">
            <div class="db-health-grid" id="healthChecksGrid">
                <div class="db-logs-loading">Carregando monitoramento...</div>
            </div>
        </div>
        <div class="db-card-footer-modern">
            <i class="bi bi-clock"></i>
            <span>Última verificação: <span id="lastHealthCheck">Carregando...</span></span>
        </div>
    </div>

    <!-- Logs em Tempo Real -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-journal-text"></i>
                Logs em Tempo Real
            </h3>
            <div class="db-logs-controls">
                <select id="logTypeFilter" class="db-select-modern" onchange="updateLogs()">
                    <option value="all">Todos os tipos</option>
                    <option value="system">Sistema</option>
                    <option value="app">Aplicação</option>
                </select>
                <select id="logLevelFilter" class="db-select-modern" onchange="updateLogs()">
                    <option value="all">Todos os níveis</option>
                    <option value="ERROR">Erro</option>
                    <option value="WARNING">Aviso</option>
                    <option value="INFO">Info</option>
                </select>
                <button type="button" class="db-btn-modern db-btn-outline" id="pauseLogsBtn" onclick="toggleLogsPause()">
                    <i class="bi bi-pause-fill"></i>
                    Pausar
                </button>
                <button type="button" class="db-btn-modern db-btn-outline" onclick="clearLogs()">
                    <i class="bi bi-trash"></i>
                    Limpar
                </button>
            </div>
        </div>
        <div class="db-card-body-modern">
            <div class="db-logs-container" id="logsContainer">
                <div class="db-logs-loading">Carregando logs...</div>
            </div>
        </div>
    </div>

    <!-- Histórico de Incidentes -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-exclamation-triangle"></i>
                Histórico de Incidentes
            </h3>
            <div class="db-incidents-controls">
                <select id="incidentServiceFilter" class="db-select-modern" onchange="updateIncidents()">
                    <option value="all">Todos os serviços</option>
                    <option value="database">Banco de Dados</option>
                    <option value="backend">Backend</option>
                    <option value="nginx">Nginx</option>
                    <option value="cpu">CPU</option>
                    <option value="memory">Memória</option>
                    <option value="disk">Disco</option>
                </select>
                <select id="incidentStatusFilter" class="db-select-modern" onchange="updateIncidents()">
                    <option value="all">Todos os status</option>
                    <option value="open">Abertos</option>
                    <option value="resolved">Resolvidos</option>
                </select>
            </div>
        </div>
        <div class="db-card-body-modern">
            <div class="db-table-wrapper">
                <table class="db-table-modern">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Serviço</th>
                            <th>Tipo</th>
                            <th>Mensagem</th>
                            <th>Severidade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="incidentsTableBody">
                        {% for incident in incidents %}
                        <tr class="db-table-row">
                            <td class="db-table-date">
                                <i class="bi bi-calendar3"></i>
                                {{ incident.created_at.strftime('%d/%m/%Y %H:%M:%S') if incident.created_at else '-' }}
                            </td>
                            <td><span class="db-badge-modern db-badge-info">{{ incident.service }}</span></td>
                            <td><code class="db-code-modern">{{ incident.error_type }}</code></td>
                            <td class="db-incident-message">{{ incident.message[:100] }}{% if incident.message|length > 100 %}...{% endif %}</td>
                            <td>
                                <span class="db-badge-modern {% if incident.severity == 'error' %}db-badge-danger{% elif incident.severity == 'warning' %}db-badge-warning{% else %}db-badge-info{% endif %}">
                                    {{ incident.severity }}
                                </span>
                            </td>
                            <td>
                                <span class="db-badge-modern {% if incident.status == 'open' %}db-badge-danger{% elif incident.status == 'resolved' %}db-badge-success{% else %}db-badge-info{% endif %}">
                                    {{ incident.status }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Análise de Tendências -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-graph-up"></i>
                Análise de Tendências
            </h3>
            <div class="db-trends-controls">
                <select id="trendMetricType" class="db-select-modern" onchange="updateTrends()">
                    <option value="cpu">CPU</option>
                    <option value="memory">Memória</option>
                    <option value="disk">Disco</option>
                    <option value="database_response_time">Tempo de Resposta DB</option>
                </select>
                <select id="trendHours" class="db-select-modern" onchange="updateTrends()">
                    <option value="6">Últimas 6 horas</option>
                    <option value="24" selected>Últimas 24 horas</option>
                    <option value="168">Última semana</option>
                </select>
            </div>
        </div>
        <div class="db-card-body-modern">
            <div class="db-trends-chart-wrapper">
                <canvas id="trendsChart"></canvas>
            </div>
            <div class="db-trends-stats" id="trendsStats">
                <!-- Preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- Monitoramento de Queries -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-code-square"></i>
                Queries Lentas do Banco
            </h3>
            <button type="button" class="db-btn-modern db-btn-outline" onclick="updateSlowQueries()">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </button>
        </div>
        <div class="db-card-body-modern">
            <div class="db-table-wrapper">
                <table class="db-table-modern">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Tempo (ms)</th>
                            <th>Endpoint</th>
                            <th>Query</th>
                        </tr>
                    </thead>
                    <tbody id="slowQueriesTableBody">
                        <tr><td colspan="4" class="text-center">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Manutenção e Otimização -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-tools"></i>
                Manutenção e Otimização
            </h3>
        </div>
        <div class="db-card-body-modern">
            <div class="db-maintenance-grid">
                <div class="db-maintenance-action">
                    <div class="db-maintenance-icon db-maintenance-cleanup">
                        <i class="bi bi-broom"></i>
                    </div>
                    <div class="db-maintenance-content">
                        <h4>Limpeza de Logs</h4>
                        <p>Remove logs antigos (mais de 30 dias) para liberar espaço</p>
                        <button type="button" class="db-btn-modern db-btn-outline" onclick="runMaintenanceCleanup()">
                            <i class="bi bi-play-fill"></i>
                            Executar Limpeza
                        </button>
                    </div>
                </div>
                <div class="db-maintenance-action">
                    <div class="db-maintenance-icon db-maintenance-optimize">
                        <i class="bi bi-lightning-fill"></i>
                    </div>
                    <div class="db-maintenance-content">
                        <h4>Otimizar Banco</h4>
                        <p>Executa VACUUM e ANALYZE para otimizar o banco de dados</p>
                        <button type="button" class="db-btn-modern db-btn-outline" onclick="runMaintenanceOptimize()">
                            <i class="bi bi-play-fill"></i>
                            Otimizar Agora
                        </button>
                    </div>
                </div>
                <div class="db-maintenance-action">
                    <div class="db-maintenance-icon db-maintenance-verify">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <div class="db-maintenance-content">
                        <h4>Verificar Backups</h4>
                        <p>Verifica integridade de todos os backups</p>
                        <button type="button" class="db-btn-modern db-btn-outline" onclick="verifyAllBackups()">
                            <i class="bi bi-play-fill"></i>
                            Verificar Backups
                        </button>
                    </div>
                </div>
            </div>
            <div class="db-maintenance-history">
                <h4>Histórico de Manutenção</h4>
                <div class="db-table-wrapper">
                    <table class="db-table-modern">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th>Duração</th>
                                <th>Itens Processados</th>
                            </tr>
                        </thead>
                        <tbody id="maintenanceHistoryBody">
                            <tr><td colspan="5" class="text-center">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Diagnóstico Completo -->
    <div class="db-card-modern" id="problems_and_diagnostics">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-activity"></i>
                Diagnóstico Completo
            </h3>
            <button type="button" class="db-btn-modern db-btn-outline" onclick="reloadDiag()">
                <i class="bi bi-arrow-repeat"></i>
                Recarregar
            </button>
        </div>
        <div class="db-card-body-modern db-iframe-wrapper">
            <iframe id="dbStatusFrame" src="{{ url_for('_dbstatus') }}" class="db-iframe-modern"></iframe>
        </div>
    </div>

    <!-- Backup Diário -->
    {% if daily_backup %}
    <div class="db-card-modern db-card-highlight db-card-success">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-calendar-check"></i>
                Backup Diário (24h)
            </h3>
            <span class="db-badge-modern db-badge-success">
                <i class="bi bi-clock-history"></i>
                Atualizado diariamente às 00h
            </span>
        </div>
        <div class="db-card-body-modern">
            <div class="db-stats-grid">
                <div class="db-stat-item-modern">
                    <div class="db-stat-icon-modern db-stat-icon-file">
                        <i class="bi bi-file-earmark-zip"></i>
                    </div>
                    <div class="db-stat-content-modern">
                        <div class="db-stat-label-modern">Arquivo</div>
                        <div class="db-stat-value-modern">{{ daily_backup.name }}</div>
                    </div>
                </div>
                <div class="db-stat-item-modern">
                    <div class="db-stat-icon-modern db-stat-icon-size">
                        <i class="bi bi-hdd"></i>
                    </div>
                    <div class="db-stat-content-modern">
                        <div class="db-stat-label-modern">Tamanho</div>
                        <div class="db-stat-value-modern">{{ '%.2f'|format((daily_backup.size or 0)/1024/1024) }} MB</div>
                    </div>
                </div>
                <div class="db-stat-item-modern">
                    <div class="db-stat-icon-modern db-stat-icon-time">
                        <i class="bi bi-clock"></i>
                    </div>
                    <div class="db-stat-content-modern">
                        <div class="db-stat-label-modern">Última atualização</div>
                        <div class="db-stat-value-modern">{{ daily_backup.mtime_str }}</div>
                    </div>
                </div>
            </div>
            <div class="db-download-action">
                <a class="db-btn-modern db-btn-success" href="{{ url_for('dbadmin.download', name=daily_backup.name) }}">
                    <i class="bi bi-download"></i>
                    Baixar Backup 24h
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Backups Recentes -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-archive"></i>
                Backups Recentes
            </h3>
            <a class="db-btn-modern db-btn-outline" href="{{ url_for('dbadmin.index') }}">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </a>
        </div>
        <div class="db-card-body-modern">
            {% if backups %}
            <div class="db-table-wrapper">
                <table class="db-table-modern">
                    <thead>
                        <tr>
                            <th>Arquivo</th>
                            <th class="text-right">Tamanho</th>
                            <th>Modificado</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for it in backups %}
                        <tr class="db-table-row">
                            <td>
                                <div class="db-file-info">
                                    <div class="db-file-icon">
                                        <i class="bi bi-file-earmark-zip"></i>
                                    </div>
                                    <div class="db-file-name">{{ it.name }}</div>
                                </div>
                            </td>
                            <td class="text-right">
                                <span class="db-badge-modern db-badge-info">{{ '%.2f'|format((it.size or 0)/1024/1024) }} MB</span>
                            </td>
                            <td class="db-table-date">
                                <i class="bi bi-calendar3"></i>
                                {{ it.mtime_str }}
                            </td>
                            <td>
                                <div class="db-actions-modern">
                                    <a class="db-btn-action-small db-btn-view" href="{{ url_for('dbadmin.download', name=it.name) }}" title="Baixar">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% if is_sqlite %}
                                    <form method="post" action="{{ url_for('dbadmin.restaurar', name=it.name) }}" onsubmit="return confirm('Restaurar este backup? Esta ação sobrescreve o banco atual.')" style="display: inline;">
                                        <button class="db-btn-action-small db-btn-restore" type="submit" title="Restaurar">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <form method="post" action="{{ url_for('dbadmin.excluir', name=it.name) }}" onsubmit="return confirm('Excluir backup {{ it.name }}?')" style="display: inline;">
                                        <button class="db-btn-action-small db-btn-delete" type="submit" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="db-pagination-modern">
                <span class="db-pagination-info">Página {{ page }} de {{ total_pages }}</span>
                <div class="db-pagination-btns">
                    <a class="db-btn-pagination {% if page <= 1 %}db-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?page={{ page-1 if page>1 else 1 }}">
                        <i class="bi bi-chevron-left"></i>
                        Anterior
                    </a>
                    <a class="db-btn-pagination {% if page >= total_pages %}db-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?page={{ page+1 if page<total_pages else total_pages }}">
                        Próximo
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
            {% else %}
            <div class="db-empty-state-large">
                <i class="bi bi-archive"></i>
                <h3>Nenhum backup disponível</h3>
                <p>Nenhum backup foi criado ainda. Use o botão "Criar Backup" para criar o primeiro backup.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Histórico de Conexões -->
    <div class="db-card-modern">
        <div class="db-card-header-modern">
            <h3 class="db-card-title">
                <i class="bi bi-person-check"></i>
                Histórico de Conexões
            </h3>
            <span class="db-badge-modern db-badge-info">Últimos logins</span>
        </div>
        <div class="db-card-body-modern">
            {% if logins %}
            <div class="db-table-wrapper">
                <table class="db-table-modern">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>IP</th>
                            <th>Navegador</th>
                            <th>Data/Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for login in logins %}
                        <tr class="db-table-row">
                            <td>
                                <div class="db-user-info">
                                    <div class="db-user-avatar">
                                        {{ (login.username or '?')[:2].upper() }}
                                    </div>
                                    <div class="db-user-name">{{ login.username or '-' }}</div>
                                </div>
                            </td>
                            <td>
                                <code class="db-code-modern">{{ login.ip_address or '-' }}</code>
                            </td>
                            <td class="db-user-agent">
                                <span class="db-text-truncate">{{ (login.user_agent or '-')[:50] }}{% if login.user_agent and login.user_agent|length > 50 %}...{% endif %}</span>
                            </td>
                            <td class="db-table-date">
                                <i class="bi bi-calendar3"></i>
                                {{ login.login_at.strftime('%d/%m/%Y %H:%M') if login.login_at else '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if logins_pag %}
            <div class="db-pagination-modern">
                <span class="db-pagination-info">Página {{ logins_pag.page }} de {{ logins_pag.pages or 1 }}</span>
                <div class="db-pagination-btns">
                    <a class="db-btn-pagination {% if not logins_pag.has_prev %}db-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.prev_num or 1 }}">
                        <i class="bi bi-chevron-left"></i>
                        Anterior
                    </a>
                    <a class="db-btn-pagination {% if not logins_pag.has_next %}db-disabled{% endif %}" href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.next_num or logins_pag.pages or 1 }}">
                        Próximo
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
            {% endif %}
            {% else %}
            <div class="db-empty-state-large">
                <i class="bi bi-person-x"></i>
                <h3>Nenhum registro de login</h3>
                <p>Nenhum registro de login foi encontrado ainda.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
var __mmChartsLoaded = false;
function ensureChartJs(cb){
  if (window.Chart) { __mmChartsLoaded = true; cb(); return; }
  if (__mmChartsLoaded) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
  s.onload = function(){ __mmChartsLoaded = true; cb(); };
  document.head.appendChild(s);
}
function startResourceCharts(){
  var cpuCtx = document.getElementById('cpuChart');
  var memCtx = document.getElementById('memChart');
  if (!cpuCtx || !memCtx) return;
  var labels = [];
  var cpuData = [];
  var memData = [];
  var cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'CPU %', data: cpuData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', tension: 0.25, fill: true }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        animation: false, 
        plugins: {
            legend: { display: false }
        },
        scales: { 
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        } 
    }
  });
  var memChart = new Chart(memCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'Memória %', data: memData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.15)', tension: 0.25, fill: true }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        animation: false,
        plugins: {
            legend: { display: false }
        },
        scales: { 
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        } 
    }
  });
  function pushPoint(ts, cpu, mem){
    var t = new Date(ts);
    var hh = String(t.getHours()).padStart(2,'0');
    var mm = String(t.getMinutes()).padStart(2,'0');
    var ss = String(t.getSeconds()).padStart(2,'0');
    labels.push(hh+':'+mm+':'+ss);
    cpuData.push(cpu);
    memData.push(mem);
    if (labels.length > 60){ labels.shift(); cpuData.shift(); memData.shift(); }
    cpuChart.update('none');
    memChart.update('none');
  }
  function updateServerClock(ts){
    var el = document.getElementById('serverClock');
    if (!el) return;
    var t = new Date(ts);
    var hh = String(t.getHours()).padStart(2,'0');
    var mm = String(t.getMinutes()).padStart(2,'0');
    var ss = String(t.getSeconds()).padStart(2,'0');
    el.textContent = 'Servidor — ' + hh + ':' + mm + ':' + ss;
  }
  async function fetchMetrics(){
    try{
      var resp = await fetch("{{ url_for('dbadmin.metrics') }}");
      var json = await resp.json();
      if (!json || !json.ok || json.cpu == null || json.mem == null) return;
      pushPoint(json.ts, json.cpu, json.mem);
      updateServerClock(json.ts);
    } catch(e){}
  }
  fetchMetrics();
  setInterval(fetchMetrics, 1000);
}
function resizeDbFrame() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  try {
    var doc = f.contentWindow && f.contentWindow.document;
    if (!doc) return;
    var h1 = doc.documentElement ? doc.documentElement.scrollHeight : 0;
    var h2 = doc.body ? doc.body.scrollHeight : 0;
    var h = Math.max(h1, h2);
    if (h && h > 0) {
      f.style.height = (h + 16) + 'px';
    }
  } catch (e) {
    // ignore
  }
}
function reloadDiag() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  var base = f.src.split('?')[0];
  f.src = base + '?t=' + Date.now();
}
// Health Checks
var healthCheckInterval = null;
var logsPaused = false;
var logsInterval = null;
var incidentsInterval = null;

function getStatusIcon(status) {
  if (status === 'ok') return '<i class="bi bi-check-circle-fill" style="color: #10b981;"></i>';
  if (status === 'warning') return '<i class="bi bi-exclamation-triangle-fill" style="color: #f59e0b;"></i>';
  return '<i class="bi bi-x-circle-fill" style="color: #ef4444;"></i>';
}

function getStatusBadgeClass(status) {
  if (status === 'ok') return 'db-badge-success';
  if (status === 'warning') return 'db-badge-warning';
  return 'db-badge-danger';
}

function formatTimestamp(isoString) {
  if (!isoString) return '-';
  var d = new Date(isoString);
  return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function getServiceName(service) {
  var names = {
    'database': 'Banco de Dados',
    'backend': 'Backend',
    'nginx': 'Nginx',
    'port': 'Porta 5000',
    'cpu': 'CPU',
    'memory': 'Memória',
    'disk': 'Disco'
  };
  return names[service] || service;
}

async function refreshHealthChecks() {
  try {
    var resp = await fetch("{{ url_for('dbadmin.health') }}");
    var json = await resp.json();
    if (!json || !json.ok || !json.health) return;
    
    var grid = document.getElementById('healthChecksGrid');
    if (!grid) return;
    
    var html = '';
    var services = ['database', 'backend', 'nginx', 'port', 'cpu', 'memory', 'disk'];
    
    services.forEach(function(service) {
      var health = json.health[service];
      if (!health) return;
      
      html += '<div class="db-health-item">';
      html += '<div class="db-health-header">';
      html += '<div class="db-health-icon">' + getStatusIcon(health.status) + '</div>';
      html += '<div class="db-health-title">' + getServiceName(service) + '</div>';
      html += '<span class="db-badge-modern ' + getStatusBadgeClass(health.status) + '">' + health.status.toUpperCase() + '</span>';
      html += '</div>';
      html += '<div class="db-health-message">' + (health.message || '-') + '</div>';
      if (health.response_time_ms !== undefined && health.response_time_ms !== null) {
        html += '<div class="db-health-detail">Tempo de resposta: ' + health.response_time_ms + 'ms</div>';
      }
      if (health.usage_percent !== undefined && health.usage_percent !== null) {
        html += '<div class="db-health-detail">Uso: ' + health.usage_percent + '%</div>';
      }
      if (health.available_gb !== undefined && health.available_gb !== null) {
        html += '<div class="db-health-detail">Disponível: ' + health.available_gb + ' GB</div>';
      }
      html += '<div class="db-health-time">Verificado: ' + formatTimestamp(health.checked_at) + '</div>';
      html += '</div>';
    });
    
    grid.innerHTML = html;
    document.getElementById('lastHealthCheck').textContent = formatTimestamp(new Date().toISOString());
  } catch(e) {
    console.error('Erro ao atualizar health checks:', e);
  }
}

// Logs em Tempo Real
async function updateLogs() {
  if (logsPaused) return;
  
  try {
    var type = document.getElementById('logTypeFilter').value;
    var level = document.getElementById('logLevelFilter').value;
    var url = "{{ url_for('dbadmin.logs') }}?type=" + type + "&level=" + level + "&limit=100";
    
    var resp = await fetch(url);
    var json = await resp.json();
    if (!json || !json.ok || !json.logs) return;
    
    var container = document.getElementById('logsContainer');
    if (!container) return;
    
    var html = '';
    json.logs.forEach(function(log) {
      var levelClass = 'db-log-info';
      if (log.level === 'ERROR') levelClass = 'db-log-error';
      else if (log.level === 'WARNING') levelClass = 'db-log-warning';
      
      html += '<div class="db-log-entry ' + levelClass + '">';
      html += '<div class="db-log-time">' + formatTimestamp(log.timestamp) + '</div>';
      html += '<div class="db-log-level">' + log.level + '</div>';
      html += '<div class="db-log-origin">' + (log.origin || '-') + '</div>';
      html += '<div class="db-log-message">' + (log.message || '-') + '</div>';
      html += '</div>';
    });
    
    container.innerHTML = html;
    
    // Auto-scroll se não estiver pausado
    if (!logsPaused) {
      container.scrollTop = container.scrollHeight;
    }
  } catch(e) {
    console.error('Erro ao atualizar logs:', e);
  }
}

function toggleLogsPause() {
  logsPaused = !logsPaused;
  var btn = document.getElementById('pauseLogsBtn');
  if (btn) {
    if (logsPaused) {
      btn.innerHTML = '<i class="bi bi-play-fill"></i> Continuar';
      btn.classList.remove('db-btn-outline');
      btn.classList.add('db-btn-primary');
    } else {
      btn.innerHTML = '<i class="bi bi-pause-fill"></i> Pausar';
      btn.classList.remove('db-btn-primary');
      btn.classList.add('db-btn-outline');
      updateLogs();
    }
  }
}

function clearLogs() {
  var container = document.getElementById('logsContainer');
  if (container) {
    container.innerHTML = '<div class="db-logs-loading">Logs limpos</div>';
  }
}

// Incidentes
async function updateIncidents() {
  try {
    var service = document.getElementById('incidentServiceFilter').value;
    var status = document.getElementById('incidentStatusFilter').value;
    var url = "{{ url_for('dbadmin.incidents') }}?service=" + service + "&status=" + status + "&limit=50";
    
    var resp = await fetch(url);
    var json = await resp.json();
    if (!json || !json.ok || !json.incidents) return;
    
    var tbody = document.getElementById('incidentsTableBody');
    if (!tbody) return;
    
    var html = '';
    json.incidents.forEach(function(inc) {
      var severityClass = 'db-badge-info';
      if (inc.severity === 'error') severityClass = 'db-badge-danger';
      else if (inc.severity === 'warning') severityClass = 'db-badge-warning';
      
      var statusClass = 'db-badge-info';
      if (inc.status === 'open') statusClass = 'db-badge-danger';
      else if (inc.status === 'resolved') statusClass = 'db-badge-success';
      
      html += '<tr class="db-table-row">';
      html += '<td class="db-table-date"><i class="bi bi-calendar3"></i> ' + formatTimestamp(inc.created_at) + '</td>';
      html += '<td><span class="db-badge-modern db-badge-info">' + inc.service + '</span></td>';
      html += '<td><code class="db-code-modern">' + inc.error_type + '</code></td>';
      html += '<td class="db-incident-message">' + (inc.message.length > 100 ? inc.message.substring(0, 100) + '...' : inc.message) + '</td>';
      html += '<td><span class="db-badge-modern ' + severityClass + '">' + inc.severity + '</span></td>';
      html += '<td><span class="db-badge-modern ' + statusClass + '">' + inc.status + '</span></td>';
      html += '</tr>';
    });
    
    tbody.innerHTML = html;
  } catch(e) {
    console.error('Erro ao atualizar incidentes:', e);
  }
}

// Dashboard
async function refreshDashboard() {
  try {
    var resp = await fetch("{{ url_for('dbadmin.dashboard') }}");
    var json = await resp.json();
    if (!json || !json.ok) return;
    
    // Atualizar score
    var scoreEl = document.getElementById('healthScoreValue');
    var scoreBar = document.getElementById('healthScoreBar');
    if (scoreEl && scoreBar && json.health_score !== undefined) {
      scoreEl.textContent = json.health_score.toFixed(1);
      scoreBar.style.width = json.health_score + '%';
    }
    
    // Atualizar contadores
    if (document.getElementById('activeAlertsCount') && json.active_alerts !== undefined) {
      document.getElementById('activeAlertsCount').textContent = json.active_alerts;
    }
    if (document.getElementById('openIncidentsCount') && json.open_incidents !== undefined) {
      document.getElementById('openIncidentsCount').textContent = json.open_incidents;
    }
  } catch(e) {
    console.error('Erro ao atualizar dashboard:', e);
  }
}

// Tendências
var trendsChart = null;
async function updateTrends() {
  try {
    var metricType = document.getElementById('trendMetricType').value;
    var hours = parseInt(document.getElementById('trendHours').value);
    var url = "{{ url_for('dbadmin.metrics_trends') }}?type=" + metricType + "&hours=" + hours;
    
    var resp = await fetch(url);
    var json = await resp.json();
    if (!json || !json.ok || !json.trends) return;
    
    var trends = json.trends;
    var statsEl = document.getElementById('trendsStats');
    if (statsEl) {
      var html = '<div class="db-trend-stats-item"><strong>Média:</strong> ' + trends.average + '</div>';
      html += '<div class="db-trend-stats-item"><strong>Mín:</strong> ' + trends.min + '</div>';
      html += '<div class="db-trend-stats-item"><strong>Máx:</strong> ' + trends.max + '</div>';
      html += '<div class="db-trend-stats-item"><strong>Tendência:</strong> ' + (trends.trend === 'increasing' ? '↑ Crescendo' : trends.trend === 'decreasing' ? '↓ Diminuindo' : '→ Estável') + '</div>';
      statsEl.innerHTML = html;
    }
    
    // Gráfico
    var ctx = document.getElementById('trendsChart');
    if (!ctx) return;
    
    ensureChartJs(function() {
      if (trendsChart) {
        trendsChart.destroy();
      }
      trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: trends.timestamps.map(function(ts) {
            var d = new Date(ts);
            return d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
          }),
          datasets: [{
            label: metricType.toUpperCase(),
            data: trends.values,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    });
  } catch(e) {
    console.error('Erro ao atualizar tendências:', e);
  }
}

// Queries lentas
async function updateSlowQueries() {
  try {
    var resp = await fetch("{{ url_for('dbadmin.slow_queries') }}");
    var json = await resp.json();
    if (!json || !json.ok || !json.queries) return;
    
    var tbody = document.getElementById('slowQueriesTableBody');
    if (!tbody) return;
    
    var html = '';
    json.queries.forEach(function(q) {
      html += '<tr class="db-table-row">';
      html += '<td class="db-table-date">' + formatTimestamp(q.timestamp) + '</td>';
      html += '<td><span class="db-badge-modern db-badge-warning">' + q.execution_time_ms.toFixed(2) + ' ms</span></td>';
      html += '<td><code class="db-code-modern">' + (q.endpoint || '-') + '</code></td>';
      html += '<td><code class="db-code-modern" style="font-size: 0.75rem;">' + q.query + '</code></td>';
      html += '</tr>';
    });
    
    if (html === '') {
      html = '<tr><td colspan="4" class="text-center">Nenhuma query lenta encontrada</td></tr>';
    }
    
    tbody.innerHTML = html;
  } catch(e) {
    console.error('Erro ao atualizar queries:', e);
  }
}

// Manutenção
async function runMaintenanceCleanup() {
  if (!confirm('Executar limpeza de logs antigos?')) return;
  try {
    var resp = await fetch("{{ url_for('dbadmin.maintenance_cleanup') }}", { method: 'POST' });
    var json = await resp.json();
    if (json && json.ok) {
      alert('Limpeza concluída: ' + json.result.deleted + ' itens removidos');
      updateSlowQueries();
    } else {
      alert('Erro: ' + (json.error || 'Erro desconhecido'));
    }
  } catch(e) {
    alert('Erro ao executar limpeza: ' + e.message);
  }
}

async function runMaintenanceOptimize() {
  if (!confirm('Otimizar banco de dados? Isso pode levar alguns segundos.')) return;
  try {
    var resp = await fetch("{{ url_for('dbadmin.maintenance_optimize') }}", { method: 'POST' });
    var json = await resp.json();
    if (json && json.ok) {
      alert('Otimização concluída em ' + json.result.duration.toFixed(2) + ' segundos');
    } else {
      alert('Erro: ' + (json.error || 'Erro desconhecido'));
    }
  } catch(e) {
    alert('Erro ao otimizar: ' + e.message);
  }
}

async function verifyAllBackups() {
  if (!confirm('Verificar integridade de todos os backups?')) return;
  try {
    var resp = await fetch("{{ url_for('dbadmin.verify_backups') }}", { method: 'POST' });
    var json = await resp.json();
    if (json && json.ok) {
      var msg = 'Verificação concluída:\n';
      json.results.forEach(function(r) {
        msg += r.filename + ': ' + r.status + '\n';
      });
      alert(msg);
    } else {
      alert('Erro: ' + (json.error || 'Erro desconhecido'));
    }
  } catch(e) {
    alert('Erro ao verificar backups: ' + e.message);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  var f = document.getElementById('dbStatusFrame');
  if (f) {
    f.addEventListener('load', resizeDbFrame);
  }
  ensureChartJs(startResourceCharts);
  
  // Inicializar health checks
  refreshHealthChecks();
  healthCheckInterval = setInterval(refreshHealthChecks, 10000); // A cada 10 segundos
  
  // Inicializar logs
  updateLogs();
  logsInterval = setInterval(updateLogs, 3000); // A cada 3 segundos
  
  // Inicializar incidentes
  updateIncidents();
  incidentsInterval = setInterval(updateIncidents, 30000); // A cada 30 segundos
  
  // Inicializar dashboard
  refreshDashboard();
  setInterval(refreshDashboard, 60000); // A cada 1 minuto
  
  // Inicializar tendências
  updateTrends();
  
  // Inicializar queries lentas
  updateSlowQueries();
  
  // Iniciar monitoramento Git
  if (document.getElementById('gitUpdateCard')) {
    refreshGitStatus();
    gitStatusInterval = setInterval(refreshGitStatus, 30000);
  }
});

// Git Update Monitoring
let gitStatusInterval = null;
let updateCountdownInterval = null;
let updateCountdown = 10;

function refreshGitStatus() {
    const btn = document.getElementById('refreshGitBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Atualizando...';
    }
    
    fetch('{{ url_for("dbadmin.git_status") }}')
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || `HTTP ${response.status}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.ok) {
                updateGitStatusDisplay(data);
            } else {
                const errorMsg = data.error || 'Erro ao buscar status do Git';
                console.error('Erro na resposta:', errorMsg);
                showGitError(errorMsg);
            }
        })
        .catch(error => {
            console.error('Erro ao buscar status Git:', error);
            showGitError('Erro de conexão: ' + error.message);
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Atualizar';
            }
        });
}

function updateGitStatusDisplay(data) {
    // Atualizar valores - usar campos retornados pela rota
    document.getElementById('currentVersion').textContent = data.current_version || 'N/A';
    document.getElementById('currentCommit').textContent = data.current_commit || data.current_commit_hash || 'N/A';
    document.getElementById('latestCommit').textContent = data.latest_commit || data.latest_commit_hash || data.remote_commit_hash || 'N/A';
    document.getElementById('commitMessage').textContent = data.commit_message || data.remote_commit_msg || 'N/A';
    
    // Atualizar indicador de status
    const indicator = document.getElementById('updateIndicator');
    const applyBtn = document.getElementById('applyUpdateBtn');
    
    if (data.update_available) {
        indicator.className = 'db-git-update-indicator update-available';
        indicator.innerHTML = '<i class="bi bi-exclamation-circle-fill"></i><span><strong>Atualização disponível!</strong> Há uma nova versão no repositório remoto.</span>';
        if (applyBtn) {
            applyBtn.disabled = false;
        }
    } else {
        indicator.className = 'db-git-update-indicator up-to-date';
        indicator.innerHTML = '<i class="bi bi-check-circle-fill"></i><span>Sistema está atualizado. Você está na versão mais recente.</span>';
        if (applyBtn) {
            applyBtn.disabled = true;
        }
    }
}

function showGitError(message) {
    const indicator = document.getElementById('updateIndicator');
    if (indicator) {
        indicator.className = 'db-git-update-indicator error';
        indicator.innerHTML = `<i class="bi bi-x-circle-fill"></i><span>${message}</span>`;
    }
    
    // Atualizar campos com mensagem de erro
    const fields = ['currentVersion', 'currentCommit', 'latestCommit', 'commitMessage'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.textContent = 'Erro ao carregar';
            field.style.color = '#dc2626';
        }
    });
    
    const applyBtn = document.getElementById('applyUpdateBtn');
    if (applyBtn) {
        applyBtn.disabled = true;
    }
}

function showUpdateConfirmation() {
    // Criar modal
    const overlay = document.createElement('div');
    overlay.className = 'db-git-modal-overlay';
    overlay.id = 'updateModalOverlay';
    
    const modal = document.createElement('div');
    modal.className = 'db-git-modal';
    
    modal.innerHTML = `
        <div class="db-git-modal-header">
            <i class="bi bi-exclamation-triangle-fill" style="color: #f59e0b; font-size: 2rem;"></i>
            <h3 class="db-git-modal-title">Confirmar Atualização do Sistema</h3>
        </div>
        <div class="db-git-modal-body">
            <div class="db-git-modal-message">
                <p style="font-size: 1.1rem; margin-bottom: 1rem;"><strong>O sistema aplicará a atualização completa.</strong></p>
                <p style="margin-bottom: 0.75rem;">Esta operação inclui:</p>
                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: #4b5563;">
                    <li>Atualização do código do GitHub</li>
                    <li>Rebuild completo do container Docker (sem cache)</li>
                    <li>Reinicialização do sistema</li>
                </ul>
                <p style="margin-bottom: 1.5rem; color: #dc2626; font-weight: 600;">
                    ⚠️ A página ficará temporariamente indisponível. Aguarde até 5 minutos e depois atualize a página.
                </p>
            </div>
            <div class="db-git-countdown-container">
                <div class="db-git-countdown">
                    <div class="db-git-countdown-value" id="countdownValue" style="font-size: 3rem; font-weight: 700; color: #dc2626;">10</div>
                    <div class="db-git-countdown-label">segundos</div>
                </div>
            </div>
        </div>
        <div class="db-git-modal-actions">
            <button type="button" class="db-git-modal-btn db-git-modal-btn-cancel" onclick="closeUpdateModal()">Cancelar</button>
            <button type="button" class="db-git-modal-btn db-git-modal-btn-confirm" id="confirmUpdateBtn" onclick="applyUpdate()" disabled>
                <i class="bi bi-cloud-arrow-down"></i>
                Aplicar Atualização
            </button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Iniciar contagem regressiva
    updateCountdown = 10;
    const countdownValue = document.getElementById('countdownValue');
    const confirmBtn = document.getElementById('confirmUpdateBtn');
    
    updateCountdownInterval = setInterval(() => {
        updateCountdown--;
        if (countdownValue) {
            countdownValue.textContent = updateCountdown;
            // Mudar cor quando próximo de zero
            if (updateCountdown <= 3) {
                countdownValue.style.color = '#dc2626';
                countdownValue.style.animation = 'pulse 0.5s infinite';
            }
        }
        
        if (updateCountdown <= 0) {
            clearInterval(updateCountdownInterval);
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            }
            // Auto-fechar após 10 segundos se não houver ação
            setTimeout(() => {
                if (document.getElementById('updateModalOverlay')) {
                    closeUpdateModal();
                }
            }, 10000);
        }
    }, 1000);
}

function closeUpdateModal() {
    const overlay = document.getElementById('updateModalOverlay');
    if (overlay) {
        overlay.remove();
    }
    if (updateCountdownInterval) {
        clearInterval(updateCountdownInterval);
    }
    updateCountdown = 10;
}

function applyUpdate() {
    const confirmBtn = document.getElementById('confirmUpdateBtn');
    const countdownValue = document.getElementById('countdownValue');
    
    if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Aplicando...';
    }
    
    if (countdownValue) {
        countdownValue.textContent = '0';
        countdownValue.style.color = '#16a34a';
    }
    
    // Função para atualizar etapas visuais
    function updateStep(stepNum, status) {
        const stepEl = document.getElementById(`step${stepNum}`);
        if (stepEl) {
            if (status === 'processing') {
                stepEl.innerHTML = stepEl.innerHTML.replace(/[✓⏳]/g, '⏳');
                stepEl.style.opacity = '1';
                stepEl.style.fontWeight = '600';
            } else if (status === 'completed') {
                stepEl.innerHTML = stepEl.innerHTML.replace(/[✓⏳]/g, '✓');
                stepEl.style.opacity = '1';
                stepEl.style.color = '#059669';
            }
        }
    }
    
    // Mostrar mensagem de processamento com etapas
    const modalBody = document.querySelector('.db-git-modal-body');
    if (modalBody) {
        const processingMsg = document.createElement('div');
        processingMsg.id = 'processingMsg';
        processingMsg.className = 'db-git-processing-msg';
        processingMsg.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite;"></i>
                    <span><strong>Aplicando atualização completa...</strong></span>
                </div>
                <div id="updateSteps" style="margin-left: 2rem; font-size: 0.9rem; color: #6b7280;">
                    <div id="step1">✓ Atualizando código do GitHub...</div>
                    <div id="step2" style="opacity: 0.5;">⏳ Parando containers...</div>
                    <div id="step3" style="opacity: 0.5;">⏳ Rebuild do container (pode demorar alguns minutos)...</div>
                    <div id="step4" style="opacity: 0.5;">⏳ Iniciando containers...</div>
                </div>
            </div>
        `;
        modalBody.appendChild(processingMsg);
        
        // Simular progresso das etapas (o backend não retorna progresso em tempo real)
        let stepTimeout = 2000; // 2 segundos entre etapas
        updateStep(1, 'processing');
        setTimeout(() => {
            updateStep(1, 'completed');
            updateStep(2, 'processing');
            setTimeout(() => {
                updateStep(2, 'completed');
                updateStep(3, 'processing');
                setTimeout(() => {
                    updateStep(3, 'completed');
                    updateStep(4, 'processing');
                }, stepTimeout * 2); // Build demora mais
            }, stepTimeout);
        }, stepTimeout);
    }
    
    fetch('{{ url_for("dbadmin.git_update") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            // Marcar todas as etapas como concluídas
            for (let i = 1; i <= 4; i++) {
                updateStep(i, 'completed');
            }
            
            // Mostrar mensagem de sucesso antes de fechar
            const modalBody = document.querySelector('.db-git-modal-body');
            if (modalBody) {
                const processingMsg = document.getElementById('processingMsg');
                if (processingMsg) {
                    processingMsg.className = 'db-git-success-msg';
                    processingMsg.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="bi bi-check-circle-fill"></i>
                            <div>
                                <strong>Atualização completa aplicada com sucesso!</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">O sistema será reiniciado. Aguarde até 5 minutos.</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Fechar modal após 3 segundos
            setTimeout(() => {
                closeUpdateModal();
                // Mostrar notificação final
                const notification = document.createElement('div');
                notification.className = 'db-git-notification';
                notification.innerHTML = `
                    <div class="db-git-notification-content">
                        <i class="bi bi-info-circle-fill"></i>
                        <div>
                            <strong>Atualização em andamento</strong>
                            <p>A página ficará temporariamente indisponível. Aguarde até 5 minutos e depois atualize a página manualmente.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Remover notificação após 10 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 10000);
            }, 3000);
        } else {
            // Mostrar erro
            const modalBody = document.querySelector('.db-git-modal-body');
            if (modalBody) {
                const processingMsg = document.getElementById('processingMsg');
                if (processingMsg) {
                    processingMsg.className = 'db-git-error-msg';
                    processingMsg.innerHTML = `<i class="bi bi-x-circle-fill"></i> <span>Erro: ${data.error || 'Erro desconhecido'}</span>`;
                }
            }
            
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Aplicar Atualização';
            }
        }
    })
    .catch(error => {
        console.error('Erro ao aplicar atualização:', error);
        const modalBody = document.querySelector('.db-git-modal-body');
        if (modalBody) {
            const processingMsg = document.getElementById('processingMsg');
            if (processingMsg) {
                processingMsg.className = 'db-git-error-msg';
                processingMsg.innerHTML = '<i class="bi bi-x-circle-fill"></i> <span>Erro de conexão. Verifique se o sistema está acessível.</span>';
            }
        }
        
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="bi bi-cloud-arrow-down"></i> Aplicar Atualização';
        }
    });
}

// Limpar intervalo ao sair da página
window.addEventListener('beforeunload', function() {
    if (gitStatusInterval) {
        clearInterval(gitStatusInterval);
    }
    if (updateCountdownInterval) {
        clearInterval(updateCountdownInterval);
    }
});
</script>

<style>
/* Container */
.db-container {
    padding: 2rem;
    max-width: 1600px;
    margin: 0 auto;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Hero Header */
.db-hero {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    border-radius: 20px;
    padding: 3rem 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
    position: relative;
    overflow: hidden;
}

.db-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: rotate 20s linear infinite;
}

@keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.db-hero-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.db-title {
    font-size: 3rem;
    font-weight: 800;
    color: white;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.db-title-icon {
    font-size: 3.5rem;
    animation: bounce 2s ease-in-out infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.db-subtitle {
    font-size: 1.25rem;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 0.5rem;
}

.db-hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn-action-primary {
    background: white;
    color: #3b82f6;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-action-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.btn-action-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
}

.btn-action-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

/* Info Box */
.db-info-box-modern {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
    border-left: 4px solid #3b82f6;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.db-info-box-modern i {
    font-size: 1.5rem;
    color: #3b82f6;
    flex-shrink: 0;
    margin-top: 0.125rem;
}

.db-info-box-modern strong {
    display: block;
    font-size: 1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.db-info-box-modern p {
    margin: 0;
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.6;
}

/* Alert */
.db-alert-modern {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.25rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.db-alert-warning {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.05));
    border-left: 4px solid #f59e0b;
    color: #92400e;
}

.db-alert-modern i {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.db-alert-modern strong {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.db-alert-modern p {
    margin: 0;
    font-size: 0.875rem;
}

/* Cards */
.db-card-modern {
    background: white;
    border-radius: 16px;
    padding: 1.75rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
    margin-bottom: 2rem;
}

.db-card-highlight {
    border-left: 4px solid;
}

.db-card-success {
    border-left-color: #10b981;
}

.db-card-header-modern {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f3f4f6;
    flex-wrap: wrap;
    gap: 1rem;
}

.db-card-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
}

.db-card-title i {
    color: #667eea;
}

.db-card-badges {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.db-card-body-modern {
    padding: 0;
}

.db-card-footer-modern {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-top: 1rem;
    margin-top: 1rem;
    border-top: 2px solid #f3f4f6;
    font-size: 0.875rem;
    color: #6b7280;
}

.db-card-footer-modern i {
    color: #667eea;
}

/* Charts */
.db-charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.db-chart-card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.db-chart-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.db-chart-header {
    margin-bottom: 1rem;
}

.db-chart-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.db-chart-label i {
    color: #667eea;
    font-size: 1.125rem;
}

.db-chart-wrapper {
    height: 120px;
    max-height: 120px;
    min-height: 120px;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}

.db-chart-wrapper canvas {
    max-height: 120px !important;
    height: 120px !important;
    width: 100% !important;
    display: block;
}

/* Iframe */
.db-iframe-wrapper {
    padding: 0;
    border-radius: 12px;
    overflow: hidden;
}

.db-iframe-modern {
    width: 100%;
    border: none;
    border-radius: 0 0 12px 12px;
    min-height: 400px;
}

/* Stats Grid */
.db-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.db-stat-item-modern {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.db-stat-item-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.db-stat-icon-modern {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.db-stat-icon-file {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.db-stat-icon-size {
    background: linear-gradient(135deg, #10b981, #059669);
}

.db-stat-icon-time {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.db-stat-content-modern {
    flex: 1;
}

.db-stat-label-modern {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.db-stat-value-modern {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1f2937;
}

.db-download-action {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
}

/* Tables */
.db-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.db-table-modern {
    width: 100%;
    border-collapse: collapse;
}

.db-table-modern th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e5e7eb;
    background: #f9fafb;
}

.db-table-row {
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s ease;
}

.db-table-row:hover {
    background: #f9fafb;
}

.db-table-modern td {
    padding: 1rem;
    color: #1f2937;
}

.db-file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.db-file-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1));
    color: #3b82f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.125rem;
    flex-shrink: 0;
}

.db-file-name {
    font-weight: 600;
    color: #1f2937;
}

.db-table-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.875rem;
}

.db-user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.db-user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 700;
    flex-shrink: 0;
}

.db-user-name {
    font-weight: 600;
    color: #1f2937;
}

.db-code-modern {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.75rem;
    background: #f3f4f6;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    color: #1f2937;
    border: 1px solid #e5e7eb;
}

.db-user-agent {
    color: #6b7280;
    font-size: 0.875rem;
    max-width: 300px;
}

.db-text-truncate {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Badges */
.db-badge-modern {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.db-badge-primary {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.db-badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
}

.db-badge-info {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

/* Buttons */
.db-btn-modern {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    font-size: 0.875rem;
}

.db-btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.db-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.db-btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.db-btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.db-btn-outline {
    background: white;
    color: #374151;
    border: 2px solid #e5e7eb;
}

.db-btn-outline:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
}

.db-btn-action-small {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    color: #374151;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
    cursor: pointer;
}

.db-btn-action-small:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.db-btn-view:hover {
    background: #3b82f6;
    color: white;
}

.db-btn-restore:hover {
    background: #f59e0b;
    color: white;
}

.db-btn-delete:hover {
    background: #ef4444;
    color: white;
}

/* Actions */
.db-actions-modern {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
}

/* Pagination */
.db-pagination-modern {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 2px solid #f3f4f6;
}

.db-pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
}

.db-pagination-btns {
    display: flex;
    gap: 0.5rem;
}

.db-btn-pagination {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: white;
    color: #374151;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 600;
}

.db-btn-pagination:hover:not(.db-disabled) {
    background: #f3f4f6;
    border-color: #667eea;
    color: #667eea;
}

.db-disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

/* Empty States */
.db-empty-state-large {
    text-align: center;
    padding: 4rem 2rem;
}

.db-empty-state-large i {
    font-size: 4rem;
    color: #667eea;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.db-empty-state-large h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0 0 0.5rem 0;
}

.db-empty-state-large p {
    font-size: 1rem;
    color: #6b7280;
    margin: 0;
}

/* Utilities */
.text-center {
    text-align: center;
}

.text-right {
    text-align: right;
}

/* Responsive */
@media (max-width: 1024px) {
    .db-charts-grid,
    .db-stats-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .db-container {
        padding: 1rem;
    }

    .db-hero {
        padding: 2rem 1.5rem;
    }

    .db-title {
        font-size: 2rem;
    }

    .db-hero-actions {
        width: 100%;
    }

    .db-hero-actions .btn-action {
        flex: 1;
        justify-content: center;
    }

    .db-card-header-modern {
        flex-direction: column;
        align-items: flex-start;
    }

    .db-table-wrapper {
        overflow-x: scroll;
    }

    .db-pagination-modern {
        flex-direction: column;
        gap: 1rem;
    }
}

/* Dark Mode */
[data-theme="dark"] .db-card-modern,
[data-theme="dark"] .db-stat-item-modern,
[data-theme="dark"] .db-chart-card {
    background: #1f2937;
    border-color: #374151;
}

[data-theme="dark"] .db-card-title,
[data-theme="dark"] .db-stat-value-modern,
[data-theme="dark"] .db-file-name,
[data-theme="dark"] .db-user-name {
    color: #f9fafb;
}

[data-theme="dark"] .db-card-footer-modern,
[data-theme="dark"] .db-stat-label-modern,
[data-theme="dark"] .db-table-date,
[data-theme="dark"] .db-user-agent {
    color: #9ca3af;
}

[data-theme="dark"] .db-table-modern th {
    background: #374151;
    color: #e5e7eb;
}

[data-theme="dark"] .db-table-modern td {
    color: #f3f4f6;
}

[data-theme="dark"] .db-table-modern td .mm-text-muted,
[data-theme="dark"] .db-table-modern td .db-table-date,
[data-theme="dark"] .db-table-modern td .db-user-agent {
    color: #d1d5db !important;
}

[data-theme="dark"] .db-table-row:hover {
    background: #374151;
}

[data-theme="dark"] .db-code-modern {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

/* Health Checks */
.db-health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.db-health-item {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.25rem;
    border: 2px solid #e5e7eb;
    transition: all 0.3s ease;
}

.db-health-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.db-health-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.db-health-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.db-health-title {
    font-weight: 600;
    color: #1f2937;
    flex: 1;
}

.db-health-message {
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.db-health-detail {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.db-health-time {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.db-badge-danger {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}

.db-badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: #d97706;
}

/* Logs */
.db-logs-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.db-select-modern {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    background: white;
    color: #374151;
    cursor: pointer;
    transition: all 0.3s ease;
}

.db-select-modern:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.db-logs-container {
    background: #1f2937;
    border-radius: 8px;
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    line-height: 1.6;
}

.db-logs-loading {
    color: #9ca3af;
    text-align: center;
    padding: 2rem;
}

.db-log-entry {
    padding: 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 4px;
    border-left: 3px solid;
    background: rgba(255, 255, 255, 0.05);
    display: grid;
    grid-template-columns: 140px 80px 120px 1fr;
    gap: 1rem;
    align-items: start;
}

.db-log-entry.db-log-error {
    border-left-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.db-log-entry.db-log-warning {
    border-left-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
}

.db-log-entry.db-log-info {
    border-left-color: #3b82f6;
}

.db-log-time {
    color: #9ca3af;
    white-space: nowrap;
}

.db-log-level {
    font-weight: 600;
    white-space: nowrap;
}

.db-log-entry.db-log-error .db-log-level {
    color: #fca5a5;
}

.db-log-entry.db-log-warning .db-log-level {
    color: #fcd34d;
}

.db-log-entry.db-log-info .db-log-level {
    color: #93c5fd;
}

.db-log-origin {
    color: #d1d5db;
    white-space: nowrap;
}

.db-log-message {
    color: #e5e7eb;
    word-break: break-word;
}

/* Incidentes */
.db-incidents-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.db-incident-message {
    max-width: 400px;
    word-break: break-word;
    font-size: 0.875rem;
}

/* Dark Mode - Health Checks */
[data-theme="dark"] .db-health-item {
    background: #1f2937;
    border-color: #374151;
}

[data-theme="dark"] .db-health-title {
    color: #f9fafb;
}

[data-theme="dark"] .db-health-message {
    color: #e5e7eb;
}

[data-theme="dark"] .db-health-detail {
    color: #9ca3af;
}

[data-theme="dark"] .db-health-time {
    color: #6b7280;
    border-top-color: #374151;
}

[data-theme="dark"] .db-select-modern {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .db-incident-message {
    color: #e5e7eb;
}

/* Dashboard Consolidado */
.db-card-highlight {
    border: 2px solid #667eea;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(102, 126, 234, 0.02) 100%);
}

.db-dashboard-grid {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 2rem;
    align-items: start;
}

.db-dashboard-score-card {
    text-align: center;
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    color: white;
}

.db-dashboard-score-value {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.db-dashboard-score-label {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-bottom: 1rem;
}

.db-dashboard-score-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    overflow: hidden;
}

.db-dashboard-score-fill {
    height: 100%;
    background: white;
    transition: width 0.5s ease;
}

.db-dashboard-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.db-dashboard-stat {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
}

.db-dashboard-stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.db-dashboard-stat-icon.db-dashboard-stat-alerts {
    background: rgba(245, 158, 11, 0.1);
    color: #d97706;
}

.db-dashboard-stat-icon.db-dashboard-stat-incidents {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}

.db-dashboard-stat-icon.db-dashboard-stat-db {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.db-dashboard-stat-icon.db-dashboard-stat-disk {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
}

.db-dashboard-stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
}

.db-dashboard-stat-label {
    font-size: 0.875rem;
    color: #6b7280;
}

/* Alertas */
.db-alerts-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.db-alert-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    border: 2px solid;
    background: #f9fafb;
}

.db-alert-item.db-alert-critical {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.05);
}

.db-alert-item.db-alert-warning {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.05);
}

.db-alert-item.db-alert-info {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.05);
}

.db-alert-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.db-alert-item.db-alert-critical .db-alert-icon {
    color: #ef4444;
}

.db-alert-item.db-alert-warning .db-alert-icon {
    color: #f59e0b;
}

.db-alert-item.db-alert-info .db-alert-icon {
    color: #3b82f6;
}

.db-alert-content {
    flex: 1;
}

.db-alert-title {
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.db-alert-details {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    gap: 1rem;
    align-items: center;
}

.db-alert-time {
    color: #9ca3af;
    font-size: 0.75rem;
}

/* Tendências */
.db-trends-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.db-trends-chart-wrapper {
    height: 300px;
    margin-bottom: 1rem;
}

.db-trends-stats {
    display: flex;
    gap: 2rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
}

.db-trend-stats-item {
    font-size: 0.875rem;
    color: #374151;
}

.db-trend-stats-item strong {
    color: #1f2937;
    margin-right: 0.5rem;
}

/* Manutenção */
.db-maintenance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.db-maintenance-action {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
}

.db-maintenance-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    flex-shrink: 0;
}

.db-maintenance-icon.db-maintenance-cleanup {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
}

.db-maintenance-icon.db-maintenance-optimize {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.db-maintenance-icon.db-maintenance-verify {
    background: rgba(245, 158, 11, 0.1);
    color: #d97706;
}

.db-maintenance-content {
    flex: 1;
}

.db-maintenance-content h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.db-maintenance-content p {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 1rem;
}

.db-maintenance-history {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e5e7eb;
}

.db-maintenance-history h4 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1rem;
}

/* Dark Mode - Dashboard */
[data-theme="dark"] .db-card-highlight {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(102, 126, 234, 0.1) 100%);
    border-color: #667eea;
}

/* Git Update Card Styles */
#gitUpdateCard {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

.db-git-info {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.db-git-repo-info {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
    padding: 1rem;
    background: rgba(59, 130, 246, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.db-git-repo-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.db-git-label {
    font-weight: 600;
    color: #4b5563;
    font-size: 0.875rem;
}

.db-git-value {
    font-weight: 500;
    color: #1f2937;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.db-git-link {
    color: #2563eb;
    text-decoration: none;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: color 0.2s;
}

.db-git-link:hover {
    color: #1d4ed8;
    text-decoration: underline;
}

.db-git-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.db-git-status-item {
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.db-git-status-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.db-git-status-value {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    word-break: break-all;
    margin-bottom: 0.25rem;
}

.db-git-status-hint {
    font-size: 0.7rem;
    color: #9ca3af;
    font-style: italic;
    display: block;
    margin-top: 0.25rem;
}

.db-git-status-hint {
    font-size: 0.7rem;
    color: #9ca3af;
    font-style: italic;
    display: block;
    margin-top: 0.25rem;
}

.db-git-commit-message {
    font-size: 0.875rem;
    font-weight: 400;
    color: #4b5563;
    font-style: italic;
}

.db-git-update-status {
    padding: 1rem;
    border-radius: 8px;
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.db-git-update-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #6b7280;
    font-size: 0.875rem;
}

.db-git-update-indicator i {
    animation: spin 1s linear infinite;
}

.db-git-update-indicator.update-available {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.db-git-update-indicator.update-available i {
    animation: none;
}

.db-git-update-indicator.up-to-date {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.db-git-update-indicator.error {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.db-git-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
}

.db-btn-lg {
    padding: 1rem 2rem;
    font-size: 1.1rem;
    min-width: 250px;
}

/* Modal de Confirmação */
.db-git-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 1rem;
}

.db-git-modal {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.db-git-modal-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.db-git-modal-header i {
    font-size: 1.5rem;
    color: #f59e0b;
}

.db-git-modal-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.db-git-modal-body {
    margin-bottom: 1.5rem;
}

.db-git-modal-body p {
    color: #4b5563;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.db-git-countdown-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    padding: 2rem;
    background: rgba(59, 130, 246, 0.05);
    border-radius: 12px;
    border: 2px solid rgba(59, 130, 246, 0.2);
}

.db-git-countdown {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-align: center;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.db-git-processing-msg,
.db-git-success-msg,
.db-git-error-msg {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    font-size: 0.95rem;
}

.db-git-processing-msg {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.db-git-success-msg {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.db-git-error-msg {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.db-git-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    z-index: 10001;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.db-git-notification-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.db-git-notification-content i {
    font-size: 1.5rem;
    color: #2563eb;
    flex-shrink: 0;
}

.db-git-notification-content strong {
    display: block;
    margin-bottom: 0.5rem;
    color: #1f2937;
}

.db-git-notification-content p {
    margin: 0;
    color: #6b7280;
    font-size: 0.9rem;
    line-height: 1.5;
}

.db-git-countdown-value {
    font-size: 3rem;
    font-weight: 800;
    color: #dc2626;
    line-height: 1;
}

.db-git-countdown-label {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
}

.db-git-modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.db-git-modal-btn {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.db-git-modal-btn-cancel {
    background: #f3f4f6;
    color: #374151;
}

.db-git-modal-btn-cancel:hover {
    background: #e5e7eb;
}

.db-git-modal-btn-confirm {
    background: #dc2626;
    color: white;
}

.db-git-modal-btn-confirm:hover {
    background: #b91c1c;
}

.db-git-modal-btn-confirm:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

[data-theme="dark"] .db-dashboard-stat {
    background: #1f2937;
    border-color: #374151;
}

[data-theme="dark"] .db-dashboard-stat-value {
    color: #f9fafb;
}

[data-theme="dark"] .db-dashboard-stat-label {
    color: #9ca3af;
}

[data-theme="dark"] .db-alert-item {
    background: #1f2937;
}

[data-theme="dark"] .db-alert-title {
    color: #f9fafb;
}

[data-theme="dark"] .db-alert-details {
    color: #9ca3af;
}

[data-theme="dark"] .db-trends-stats {
    background: #1f2937;
}

[data-theme="dark"] .db-trend-stats-item {
    color: #e5e7eb;
}

[data-theme="dark"] .db-trend-stats-item strong {
    color: #f9fafb;
}

[data-theme="dark"] .db-maintenance-action {
    background: #1f2937;
    border-color: #374151;
}

[data-theme="dark"] .db-maintenance-content h4 {
    color: #f9fafb;
}

[data-theme="dark"] .db-maintenance-content p {
    color: #9ca3af;
}

[data-theme="dark"] .db-maintenance-history {
    border-top-color: #374151;
}

[data-theme="dark"] .db-maintenance-history h4 {
    color: #f9fafb;
}
</style>
{% endblock %}
