{% extends 'base.html' %}
{% block title %}Banco de Dados — MultiMax{% endblock %}

{% block content %}
<div class="db-container">
    <!-- Hero Header -->
    <div class="db-hero">
        <div class="hero-content">
            <div class="hero-text">
                <h1 class="hero-title">
                    <span class="gradient-text">Banco de Dados</span>
                </h1>
                <p class="hero-subtitle">Gerencie backups, monitore recursos e acompanhe a saúde do sistema</p>
            </div>
            <div class="hero-actions">
                <form method="post" action="{{ url_for('dbadmin.backup_now') }}" class="hero-form">
                    <button type="submit" class="btn-hero">
                        <i class="bi bi-cloud-arrow-up"></i>
                        <span>Criar Backup</span>
                    </button>
                </form>
                {% if is_sqlite %}
                <form method="post" action="{{ url_for('dbadmin.restaurar_snapshot') }}" 
                      onsubmit="return confirm('Restaurar o último snapshot? Esta ação sobrescreve o banco atual.')" 
                      class="hero-form">
                    <button type="submit" class="btn-hero btn-hero-outline">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        <span>Restaurar Snapshot</span>
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="info-alert">
        <div class="alert-icon">
            <i class="bi bi-info-circle"></i>
        </div>
        <div class="alert-content">
            <strong>Backups Automáticos</strong>
            <p>Backups automáticos a cada 15 minutos (mínimo). Mantém no máximo 20 mais recentes. Inclui backup-24h.sqlite atualizado diariamente às 00h.</p>
        </div>
    </div>

    {% if not is_sqlite %}
    <div class="warning-alert">
        <div class="alert-icon">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="alert-content">
            <strong>Atenção</strong>
            <p>Backup automático está disponível apenas quando o banco é SQLite.</p>
        </div>
    </div>
    {% endif %}

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-primary">
            <div class="kpi-icon">
                <i class="bi bi-database"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label">Total de Backups</div>
                <div class="kpi-value">{{ backups|length if backups else 0 }}</div>
            </div>
            <div class="kpi-decoration"></div>
        </div>
        
        <div class="kpi-card kpi-success">
            <div class="kpi-icon">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label">Backup Diário</div>
                <div class="kpi-value">{{ 'Ativo' if daily_backup else 'Inativo' }}</div>
            </div>
            <div class="kpi-decoration"></div>
        </div>
        
        <div class="kpi-card kpi-info">
            <div class="kpi-icon">
                <i class="bi bi-person-check"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label">Últimos Logins</div>
                <div class="kpi-value">{{ logins|length if logins else 0 }}</div>
            </div>
            <div class="kpi-decoration"></div>
        </div>
        
        <div class="kpi-card kpi-warning">
            <div class="kpi-icon">
                <i class="bi bi-cpu"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label">Monitoramento</div>
                <div class="kpi-value" id="serverClock">--:--:--</div>
            </div>
            <div class="kpi-decoration"></div>
        </div>
    </div>

    <!-- Backup Diário Card -->
    {% if daily_backup %}
    <div class="daily-backup-card">
        <div class="card-header">
            <div class="card-title">
                <div class="title-icon success">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div>
                    <h3>Backup Diário (24h)</h3>
                    <p class="card-subtitle">Atualizado diariamente às 00h</p>
                </div>
            </div>
            <span class="status-badge success">
                <i class="bi bi-check-circle"></i>
                Ativo
            </span>
        </div>
        <div class="card-body">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Arquivo</div>
                    <div class="stat-value">
                        <i class="bi bi-file-earmark-zip"></i>
                        {{ daily_backup.name }}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Tamanho</div>
                    <div class="stat-value">
                        <i class="bi bi-hdd"></i>
                        {{ '%.2f'|format((daily_backup.size or 0)/1024/1024) }} MB
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Última Atualização</div>
                    <div class="stat-value">
                        <i class="bi bi-clock-history"></i>
                        {{ daily_backup.mtime_str }}
                    </div>
                </div>
            </div>
            <div class="card-actions">
                <a class="btn-action btn-success" href="{{ url_for('dbadmin.download', name=daily_backup.name) }}">
                    <i class="bi bi-download"></i>
                    Baixar Backup 24h
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recursos da Máquina Card -->
    <div class="resources-card">
        <div class="card-header">
            <div class="card-title">
                <div class="title-icon primary">
                    <i class="bi bi-cpu"></i>
                </div>
                <div>
                    <h3>Uso de Recursos da Máquina</h3>
                    <p class="card-subtitle">Monitoramento em tempo real</p>
                </div>
            </div>
            <span class="update-badge">
                <i class="bi bi-arrow-repeat"></i>
                Atualiza a cada 1s
            </span>
        </div>
        <div class="card-body">
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-label">
                            <i class="bi bi-cpu-fill"></i>
                            CPU (%)
                        </div>
                    </div>
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-label">
                            <i class="bi bi-memory"></i>
                            Memória (%)
                        </div>
                    </div>
                    <canvas id="memChart"></canvas>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <i class="bi bi-info-circle"></i>
            <span>Origem: host local do MultiMax</span>
        </div>
    </div>

    <!-- Diagnóstico Card -->
    <div class="diagnostics-card">
        <div class="card-header">
            <div class="card-title">
                <div class="title-icon info">
                    <i class="bi bi-activity"></i>
                </div>
                <div>
                    <h3>Diagnóstico Completo</h3>
                    <p class="card-subtitle">Status do banco de dados e sistema</p>
                </div>
            </div>
            <button type="button" class="btn-action btn-outline" onclick="reloadDiag()">
                <i class="bi bi-arrow-repeat"></i>
                Recarregar
            </button>
        </div>
        <div class="card-body">
            <div class="iframe-wrapper">
                <iframe id="dbStatusFrame" src="{{ url_for('_dbstatus') }}" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- Backups Recentes Card -->
    <div class="backups-card">
        <div class="card-header">
            <div class="card-title">
                <div class="title-icon warning">
                    <i class="bi bi-archive"></i>
                </div>
                <div>
                    <h3>Backups Recentes</h3>
                    <p class="card-subtitle">Histórico de backups do sistema</p>
                </div>
            </div>
            <a class="btn-action btn-outline" href="{{ url_for('dbadmin.index') }}">
                <i class="bi bi-arrow-repeat"></i>
                Atualizar
            </a>
        </div>
        <div class="card-body">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Arquivo</th>
                            <th class="text-center">Tamanho</th>
                            <th>Modificado</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for it in backups %}
                        <tr>
                            <td>
                                <div class="file-info">
                                    <div class="file-icon">
                                        <i class="bi bi-file-earmark-zip"></i>
                                    </div>
                                    <div class="file-details">
                                        <strong>{{ it.name }}</strong>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge badge-secondary">{{ '%.2f'|format((it.size or 0)/1024/1024) }} MB</span>
                            </td>
                            <td>
                                <span class="text-muted">{{ it.mtime_str }}</span>
                            </td>
                            <td class="text-end">
                                <div class="actions-group">
                                    <a class="action-btn action-outline" href="{{ url_for('dbadmin.download', name=it.name) }}" title="Baixar">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    {% if is_sqlite %}
                                    <form method="post" action="{{ url_for('dbadmin.restaurar', name=it.name) }}" 
                                          onsubmit="return confirm('Restaurar este backup? Esta ação sobrescreve o banco atual.')" 
                                          class="inline-form">
                                        <button class="action-btn action-primary" type="submit" title="Restaurar">
                                            <i class="bi bi-arrow-counterclockwise"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    <form method="post" action="{{ url_for('dbadmin.excluir', name=it.name) }}" 
                                          onsubmit="return confirm('Excluir backup {{ it.name }}?')" 
                                          class="inline-form">
                                        <button class="action-btn action-danger" type="submit" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="empty-cell">
                                <div class="empty-state">
                                    <i class="bi bi-archive"></i>
                                    <span>Nenhum backup disponível</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if total_pages > 1 %}
        <div class="card-footer">
            <div class="pagination-info">Página {{ page }} de {{ total_pages }}</div>
            <div class="pagination">
                <a href="{{ url_for('dbadmin.index') }}?page={{ page-1 if page>1 else 1 }}" 
                   class="pagination-btn {% if page <= 1 %}disabled{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                    <span>Anterior</span>
                </a>
                <a href="{{ url_for('dbadmin.index') }}?page={{ page+1 if page<total_pages else total_pages }}" 
                   class="pagination-btn {% if page >= total_pages %}disabled{% endif %}">
                    <span>Próxima</span>
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Histórico de Conexões Card -->
    <div class="logins-card">
        <div class="card-header">
            <div class="card-title">
                <div class="title-icon success">
                    <i class="bi bi-person-check"></i>
                </div>
                <div>
                    <h3>Histórico de Conexões</h3>
                    <p class="card-subtitle">Últimos acessos ao sistema</p>
                </div>
            </div>
            <span class="status-badge info">
                <i class="bi bi-clock-history"></i>
                Últimos logins
            </span>
        </div>
        <div class="card-body">
            <div class="table-wrapper">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>IP</th>
                            <th>Navegador</th>
                            <th>Data/Hora</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for login in logins %}
                        <tr>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <strong>{{ login.username or '-' }}</strong>
                                </div>
                            </td>
                            <td>
                                <code class="ip-code">{{ login.ip_address or '-' }}</code>
                            </td>
                            <td>
                                <span class="text-muted">{{ (login.user_agent or '-')[:50] }}{% if login.user_agent and login.user_agent|length > 50 %}...{% endif %}</span>
                            </td>
                            <td>
                                <span class="text-muted">{{ login.login_at.strftime('%d/%m/%Y %H:%M') if login.login_at else '-' }}</span>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="empty-cell">
                                <div class="empty-state">
                                    <i class="bi bi-person-x"></i>
                                    <span>Nenhum registro de login</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if logins_pag and logins_pag.pages > 1 %}
        <div class="card-footer">
            <div class="pagination-info">Página {{ logins_pag.page }} de {{ logins_pag.pages or 1 }}</div>
            <div class="pagination">
                <a href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.prev_num or 1 }}" 
                   class="pagination-btn {% if not logins_pag.has_prev %}disabled{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                    <span>Anterior</span>
                </a>
                <a href="{{ url_for('dbadmin.index') }}?login_page={{ logins_pag.next_num or logins_pag.pages or 1 }}" 
                   class="pagination-btn {% if not logins_pag.has_next %}disabled{% endif %}">
                    <span>Próxima</span>
                    <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
:root {
    --db-primary: #667eea;
    --db-secondary: #764ba2;
    --db-success: #10b981;
    --db-warning: #f59e0b;
    --db-danger: #ef4444;
    --db-info: #3b82f6;
    --db-bg: #f8fafc;
    --db-card-bg: #ffffff;
    --db-text: #1e293b;
    --db-text-muted: #64748b;
    --db-border: #e2e8f0;
    --db-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --db-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

[data-theme="dark"] {
    --db-bg: #0f172a;
    --db-card-bg: #1e293b;
    --db-text: #f1f5f9;
    --db-text-muted: #94a3b8;
    --db-border: #334155;
}

.db-container {
    padding: 2rem;
    background: var(--db-bg);
    min-height: 100vh;
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Hero */
.db-hero {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 24px;
    padding: 3rem 2.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--db-shadow-lg);
    position: relative;
    overflow: hidden;
}

.db-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 15s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.hero-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.hero-title {
    font-size: 3rem;
    font-weight: 800;
    margin: 0;
    color: white;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.gradient-text {
    background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.25rem;
    color: rgba(255,255,255,0.9);
    margin-top: 0.5rem;
}

.hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.hero-form {
    margin: 0;
}

.btn-hero {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 2rem;
    background: white;
    color: var(--db-primary);
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border: none;
    cursor: pointer;
}

.btn-hero:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    color: var(--db-secondary);
}

.btn-hero-outline {
    background: transparent;
    color: white;
    border: 2px solid white;
    box-shadow: none;
}

.btn-hero-outline:hover {
    background: white;
    color: var(--db-primary);
}

/* Alerts */
.info-alert,
.warning-alert {
    display: flex;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    align-items: flex-start;
}

.info-alert {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.warning-alert {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.info-alert .alert-icon {
    background: rgba(59, 130, 246, 0.15);
    color: var(--db-info);
}

.warning-alert .alert-icon {
    background: rgba(245, 158, 11, 0.15);
    color: var(--db-warning);
}

.alert-content {
    flex: 1;
}

.alert-content strong {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: var(--db-text);
    margin-bottom: 0.5rem;
}

.alert-content p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--db-text-muted);
    line-height: 1.6;
}

/* KPI Cards */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.kpi-card {
    position: relative;
    padding: 2rem;
    background: var(--db-card-bg);
    border-radius: 20px;
    box-shadow: var(--db-shadow);
    overflow: hidden;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--db-shadow-lg);
}

.kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.kpi-primary::before { background: linear-gradient(90deg, #667eea, #764ba2); }
.kpi-warning::before { background: linear-gradient(90deg, #f59e0b, #f97316); }
.kpi-success::before { background: linear-gradient(90deg, #10b981, #059669); }
.kpi-info::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }

.kpi-icon {
    width: 64px;
    height: 64px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: white;
    flex-shrink: 0;
}

.kpi-primary .kpi-icon { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.kpi-warning .kpi-icon { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); }
.kpi-success .kpi-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.kpi-info .kpi-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }

.kpi-label {
    font-size: 0.875rem;
    color: var(--db-text-muted);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.kpi-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--db-text);
    line-height: 1;
}

.kpi-decoration {
    position: absolute;
    bottom: -20px;
    right: -20px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    opacity: 0.1;
    background: var(--db-primary);
}

/* Cards */
.daily-backup-card,
.resources-card,
.diagnostics-card,
.backups-card,
.logins-card {
    background: var(--db-card-bg);
    border-radius: 20px;
    box-shadow: var(--db-shadow);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--db-border);
    background: var(--db-bg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.card-title {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.title-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
}

.title-icon.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.title-icon.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.title-icon.info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.title-icon.warning { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); }

.card-title h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    color: var(--db-text);
}

.card-subtitle {
    font-size: 0.875rem;
    color: var(--db-text-muted);
    margin: 0.25rem 0 0 0;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-badge.success {
    background: rgba(16, 185, 129, 0.15);
    color: var(--db-success);
}

.status-badge.info {
    background: rgba(59, 130, 246, 0.15);
    color: var(--db-info);
}

.update-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--db-bg);
    color: var(--db-text-muted);
    border-radius: 8px;
    font-size: 0.875rem;
}

.card-body {
    padding: 1.5rem;
}

.card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--db-border);
    background: var(--db-bg);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    font-size: 0.875rem;
    color: var(--db-text-muted);
}

.card-footer i {
    margin-right: 0.5rem;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--db-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.stat-value {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--db-text);
}

.stat-value i {
    color: var(--db-primary);
}

.card-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

/* Charts */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.chart-container {
    position: relative;
    height: 200px;
    max-height: 200px;
    min-height: 200px;
}

.chart-header {
    margin-bottom: 0.75rem;
}

.chart-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--db-text);
}

.chart-label i {
    color: var(--db-primary);
}

.chart-container canvas {
    max-height: 180px !important;
    height: 180px !important;
    width: 100% !important;
}

/* Diagnostics */
.iframe-wrapper {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--db-border);
}

.iframe-wrapper iframe {
    width: 100%;
    min-height: 400px;
    border: none;
    display: block;
}

/* Tables */
.table-wrapper {
    overflow-x: auto;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
}

.modern-table thead {
    background: var(--db-bg);
}

.modern-table th {
    padding: 1rem;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--db-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modern-table tbody tr {
    border-bottom: 1px solid var(--db-border);
    transition: background 0.2s ease;
}

.modern-table tbody tr:hover {
    background: var(--db-bg);
}

.modern-table td {
    padding: 1rem;
    color: var(--db-text);
    font-size: 0.875rem;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.file-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: rgba(245, 158, 11, 0.15);
    color: var(--db-warning);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(102, 126, 234, 0.15);
    color: var(--db-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.ip-code {
    font-family: 'Courier New', monospace;
    font-size: 0.8125rem;
    background: var(--db-bg);
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    color: var(--db-text);
}

.badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-secondary {
    background: var(--db-bg);
    color: var(--db-text-muted);
}

.actions-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    justify-content: flex-end;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    font-size: 0.875rem;
}

.action-primary {
    background: rgba(102, 126, 234, 0.1);
    color: var(--db-primary);
}

.action-primary:hover {
    background: var(--db-primary);
    color: white;
}

.action-outline {
    background: transparent;
    color: var(--db-text);
    border: 2px solid var(--db-border);
}

.action-outline:hover {
    background: var(--db-bg);
    border-color: var(--db-primary);
}

.action-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--db-danger);
}

.action-danger:hover {
    background: var(--db-danger);
    color: white;
}

.action-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--db-success);
}

.action-success:hover {
    background: var(--db-success);
    color: white;
}

.btn-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid;
    text-decoration: none;
}

.btn-outline {
    background: transparent;
    color: var(--db-text);
    border-color: var(--db-border);
}

.btn-outline:hover {
    background: var(--db-bg);
    border-color: var(--db-primary);
}

.btn-success {
    background: var(--db-success);
    color: white;
    border-color: transparent;
}

.btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
}

.inline-form {
    display: inline-flex;
}

.empty-cell {
    text-align: center;
    padding: 3rem !important;
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    color: var(--db-text-muted);
}

.empty-state i {
    font-size: 2rem;
    opacity: 0.5;
}

/* Pagination */
.pagination-info {
    color: var(--db-text-muted);
    font-size: 0.875rem;
}

.pagination {
    display: flex;
    gap: 0.5rem;
}

.pagination-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    background: var(--db-card-bg);
    color: var(--db-text);
    border: 2px solid var(--db-border);
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.pagination-btn:hover:not(.disabled) {
    background: var(--db-primary);
    color: white;
    border-color: var(--db-primary);
}

.pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.text-center { text-align: center; }
.text-end { text-align: right; }
.text-muted { color: var(--db-text-muted); }

/* Responsive */
@media (max-width: 768px) {
    .db-container {
        padding: 1rem;
    }

    .hero-content {
        flex-direction: column;
        text-align: center;
    }

    .hero-title {
        font-size: 2rem;
    }

    .kpi-grid {
        grid-template-columns: 1fr;
    }

    .charts-grid {
        grid-template-columns: 1fr;
    }

    .chart-container {
        height: 180px;
        max-height: 180px;
        min-height: 180px;
    }

    .chart-container canvas {
        max-height: 160px !important;
        height: 160px !important;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }

    .card-footer {
        flex-direction: column;
        align-items: stretch;
    }

    .pagination {
        width: 100%;
        justify-content: space-between;
    }

    .pagination-btn {
        flex: 1;
    }
}
</style>

<script>
var __mmChartsLoaded = false;
function ensureChartJs(cb){
  if (window.Chart) { __mmChartsLoaded = true; cb(); return; }
  if (__mmChartsLoaded) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
  s.onload = function(){ __mmChartsLoaded = true; cb(); };
  document.head.appendChild(s);
}
function startResourceCharts(){
  var cpuCtx = document.getElementById('cpuChart');
  var memCtx = document.getElementById('memChart');
  if (!cpuCtx || !memCtx) return;
  var labels = [];
  var cpuData = [];
  var memData = [];
  var cpuChart = new Chart(cpuCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'CPU %', data: cpuData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', tension: 0.25, fill: true }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        animation: false, 
        plugins: {
            legend: { display: false }
        },
        scales: { 
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        } 
    }
  });
  var memChart = new Chart(memCtx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: 'Memória %', data: memData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.15)', tension: 0.25, fill: true }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: true,
        aspectRatio: 2.5,
        animation: false, 
        plugins: {
            legend: { display: false }
        },
        scales: { 
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } },
            x: { grid: { display: false } }
        } 
    }
  });
  function pushPoint(ts, cpu, mem){
    var t = new Date(ts);
    var hh = String(t.getHours()).padStart(2,'0');
    var mm = String(t.getMinutes()).padStart(2,'0');
    var ss = String(t.getSeconds()).padStart(2,'0');
    labels.push(hh+':'+mm+':'+ss);
    cpuData.push(cpu);
    memData.push(mem);
    if (labels.length > 60){ labels.shift(); cpuData.shift(); memData.shift(); }
    cpuChart.update('none');
    memChart.update('none');
  }
  function updateServerClock(ts){
    var el = document.getElementById('serverClock');
    if (!el) return;
    var t = new Date(ts);
    var hh = String(t.getHours()).padStart(2,'0');
    var mm = String(t.getMinutes()).padStart(2,'0');
    var ss = String(t.getSeconds()).padStart(2,'0');
    el.textContent = hh + ':' + mm + ':' + ss;
  }
  async function fetchMetrics(){
    try{
      var resp = await fetch("{{ url_for('dbadmin.metrics') }}");
      var json = await resp.json();
      if (!json || !json.ok || json.cpu == null || json.mem == null) return;
      pushPoint(json.ts, json.cpu, json.mem);
      updateServerClock(json.ts);
    } catch(e){}
  }
  fetchMetrics();
  setInterval(fetchMetrics, 1000);
}
function resizeDbFrame() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  try {
    var doc = f.contentWindow && f.contentWindow.document;
    if (!doc) return;
    var h1 = doc.documentElement ? doc.documentElement.scrollHeight : 0;
    var h2 = doc.body ? doc.body.scrollHeight : 0;
    var h = Math.max(h1, h2);
    if (h && h > 0) {
      f.style.height = (h + 16) + 'px';
    }
  } catch (e) {
    // ignore
  }
}
function reloadDiag() {
  var f = document.getElementById('dbStatusFrame');
  if (!f) return;
  var base = f.src.split('?')[0];
  f.src = base + '?t=' + Date.now();
  setTimeout(resizeDbFrame, 500);
}
document.addEventListener('DOMContentLoaded', function() {
  var f = document.getElementById('dbStatusFrame');
  if (f) {
    f.addEventListener('load', resizeDbFrame);
  }
  ensureChartJs(startResourceCharts);
});
</script>
{% endblock %}
