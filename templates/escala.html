{% extends 'base.html' %}
{% block title %}MultiMax{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Rodízio de Equipes</h3>
  <div></div>
</div>

{% if current_user.nivel in ('operador','admin') %}
<div class="card mb-3">
  <div class="card-header">Configurar semana atual</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('colaboradores.rodizio_atualizar') }}" class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Equipe Abertura (esta semana)</label>
        <select name="abertura_equipe" class="form-select">
          <option value="1" {% if ref_open == '1' %}selected{% endif %}>Equipe 1</option>
          <option value="2" {% if ref_open == '2' %}selected{% endif %}>Equipe 2</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Equipe Fechamento (esta semana)</label>
        <select name="fechamento_equipe" class="form-select">
          {% set other = '2' if ref_open == '1' else '1' %}
          <option value="1" {% if other == '1' %}selected{% endif %}>Equipe 1</option>
          <option value="2" {% if other == '2' %}selected{% endif %}>Equipe 2</option>
        </select>
      </div>
      <div class="col-md-6 d-flex align-items-end justify-content-end">
        <button class="btn btn-primary" type="submit">Atualizar Semana</button>
      </div>
    </form>
  </div>
</div>
<div class="card mb-3">
  <div class="card-header">Gerar Rodízio (5 semanas)</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('colaboradores.rodizio_gerar') }}" class="row g-2">
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="limparCheck" name="limpar">
          <label class="form-check-label" for="limparCheck">Limpar escalas existentes no período</label>
        </div>
      </div>
      <div class="col-md-6 d-flex align-items-end justify-content-end">
        <button class="btn btn-success" type="submit">Gerar Rodízio</button>
      </div>
    </form>
  </div>
</div>
<div class="card mb-3">
  <div class="card-header">Configurar Domingos</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('colaboradores.domingo_configurar') }}" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Equipe de Domingo (5h–13h)</label>
        <select name="domingo_team" class="form-select">
          <option value="1" {% if domingo_team == '1' %}selected{% endif %}>Equipe 1</option>
          <option value="2" {% if domingo_team == '2' %}selected{% endif %}>Equipe 2</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Domingo de referência</label>
        <input type="date" class="form-control" name="domingo_data" value="{{ domingo_ref_date }}">
      </div>
      <div class="col-md-4 d-flex align-items-end justify-content-end">
        <button class="btn btn-primary" type="submit">Salvar Configuração</button>
      </div>
    </form>
  </div>
</div>
<div class="card mb-3">
  <div class="card-header">Registrar Crédito de Folga</div>
  <div class="card-body">
    <form method="post" action="{{ url_for('colaboradores.folga_credito_registrar') }}" class="row g-2">
      <div class="col-md-4">
        <label class="form-label">Colaborador</label>
        <select name="collaborator_id" class="form-select" required>
          {% for c in colaboradores %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Data</label>
        <input type="date" class="form-control" name="date" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dias (+)</label>
        <input type="number" class="form-control" name="amount" min="1" value="1" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Observação</label>
        <input type="text" class="form-control" name="notes" placeholder="Motivo">
      </div>
      <div class="col-12 d-flex align-items-end justify-content-end">
        <button class="btn btn-success" type="submit">Registrar Crédito</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<div class="table-responsive-sm">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>Semana</th>
        <th>Período</th>
        <th>Abertura</th>
        <th>Fechamento</th>
      </tr>
    </thead>
    <tbody>
      {% for w in weeks %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ w.start.strftime('%d/%m') }} - {{ w.end.strftime('%d/%m') }}</td>
        <td><span class="badge text-bg-primary">{{ w.open }}</span></td>
        <td><span class="badge text-bg-info">{{ w.close }}</span></td>
      </tr>
      {% endfor %}
      {% if weeks|length == 0 %}
      <tr><td colspan="4" class="text-center text-muted">Sem dados de rodízio</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="card mt-3">
  <div class="card-header">Calendário do Sistema</div>
  <div class="card-body">
    <div id="calendar" style="min-height: 600px"></div>
    <script id="events-data" type="application/json">{{ events|tojson|safe }}</script>
    <style>
      .fc-daygrid-event.dot-event { background: transparent !important; border: 0 !important; padding: 2px !important; }
      .fc-daygrid-event.dot-event .fc-event-main { padding: 0 !important; }
      .fc-daygrid-event.dot-event .fc-event-main > * { margin: 0 !important; }
      .fc .fc-toolbar-title { font-weight: 700; font-size: 1.25rem; }
      .fc .fc-button { border-radius: 16px; background: #f4f4f5; color: #111; border: 0; }
      .fc .fc-button:hover { background: #e9e9ea; }
      .fc .fc-button:focus { box-shadow: none; }
      .fc-daygrid-day.fc-day-today .fc-daygrid-day-number { background: #ff3b30; color: #fff; border-radius: 12px; padding: 2px 6px; }
      .fc .fc-timegrid-now-indicator-line { border-color: #ff3b30; }
      .fc .fc-timegrid-now-indicator-arrow { border-top-color: #ff3b30; }
      .fc-list-day { background: transparent !important; }
      .fc-list-day-cushion { padding: 8px 12px; }
      .fc-list-day .fc-list-day-text { font-size: 1rem; font-weight: 600; color: #111; }
      .fc-list-day .fc-list-day-side-text { color: #6c757d; }
      .fc-list-event-time { width: 80px; font-weight: 600; color: #111; }
      .fc-list-event-title a { color: #111; }
      .fc-list-event:hover { background: #f7f7f8; }
      .fc .fc-col-header-cell-cushion { font-weight: 600; }
    </style>
  </div>
  <div class="card-footer">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <span style="display:inline-flex;align-items:center;gap:.5rem"><span style="width:12px;height:12px;border-radius:50%;background:#0d6efd;display:inline-block"></span>Equipe Abertura</span>
      <span style="display:inline-flex;align-items:center;gap:.5rem"><span style="width:12px;height:12px;border-radius:50%;background:#0b5ed7;display:inline-block"></span>Equipe Fechamento</span>
      <span style="display:inline-flex;align-items:center;gap:.5rem"><span style="width:12px;height:12px;border-radius:50%;background:#fd7e14;display:inline-block"></span>Domingo (5h–13h)</span>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
  (function(){
    var l = {
      code: 'pt-br',
      week: { dow: 0, doy: 4 },
      buttonText: { prev: 'Anterior', next: 'Próximo', today: 'Hoje', year: 'Ano', month: 'Mês', week: 'Semana', day: 'Dia', list: 'Lista' },
      weekText: 'Sm',
      allDayText: 'dia inteiro',
      moreLinkText: 'mais',
      noEventsText: 'Sem eventos para mostrar'
    };
    try {
      if (window.FullCalendar && Array.isArray(FullCalendar.globalLocales)) {
        FullCalendar.globalLocales.push(l);
      } else {
        window.FullCalendar = window.FullCalendar || {};
        FullCalendar.globalLocales = FullCalendar.globalLocales || [];
        FullCalendar.globalLocales.push(l);
      }
    } catch(e) {}
  })();
</script>
<script>
  (function(){
    var el = document.getElementById('calendar');
    var events = JSON.parse((document.getElementById('events-data')?.textContent) || '[]');
    events = (events || []).map(function(e){ return {
      title: e.title,
      start: e.start,
      end: e.end || null,
      color: e.color || '#0d6efd',
      url: e.url || null,
      kind: e.kind || null,
      team: e.team || null,
      classNames: (e.kind === 'rodizio-open' || e.kind === 'rodizio-close' || e.kind === 'rodizio-sunday') ? ['dot-event'] : [],
    }; });
    var hasPtBr = (window.FullCalendar && Array.isArray(FullCalendar.globalLocales) && FullCalendar.globalLocales.some(function(l){ return l.code === 'pt-br'; }));
    var calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: hasPtBr ? 'pt-br' : 'en',
      height: 'auto',
      firstDay: 0,
      nowIndicator: true,
      slotMinTime: '05:00:00',
      slotMaxTime: '20:00:00',
      scrollTime: '06:00:00',
      dayHeaders: true,
      dayHeaderFormat: { weekday: 'short' },
      views: {
        dayGridMonth: { dayHeaderFormat: { weekday: 'short' } },
        timeGridWeek: { dayHeaderFormat: { weekday: 'short' } },
        timeGridDay: { dayHeaderFormat: { weekday: 'short' } }
      },
      dayMaxEvents: 2,
      moreLinkClick: 'popover',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'viewsMenu'
      },
      customButtons: {
        viewsMenu: {
          text: 'Visualizações ▾',
          click: function(){
            var menu = el.querySelector('#fc-views-menu');
            if(menu){ menu.classList.toggle('show'); }
          }
        }
      },
      buttonText: {
        today: 'Hoje',
        month: 'Mês',
        week: 'Semana',
        day: 'Dia',
        list: 'Lista',
        listDay: 'Dia (lista)',
        listMonth: 'Mês (lista)'
      },
      events: events,
      eventContent: function(arg){
        var kind = arg.event && arg.event.extendedProps && arg.event.extendedProps.kind;
        if (kind === 'rodizio-open' || kind === 'rodizio-close' || kind === 'rodizio-sunday') {
          var bg = arg.event.backgroundColor || arg.event.borderColor || (arg.backgroundColor || null) || '#0d6efd';
          var num = (arg.event && arg.event.extendedProps && arg.event.extendedProps.team) || null;
          if (!num) {
            try {
              var m = (arg.event.title || '').match(/'(\d)'/);
              if (m) num = m[1];
            } catch (e) {}
          }
          var dot = document.createElement('span');
          dot.style.display = 'inline-flex';
          dot.style.width = '24px';
          dot.style.height = '24px';
          dot.style.borderRadius = '50%';
          dot.style.backgroundColor = bg;
          dot.style.justifyContent = 'center';
          dot.style.alignItems = 'center';
          dot.style.color = '#fff';
          dot.style.fontSize = '13px';
          dot.style.fontWeight = '600';
          dot.style.border = '2px solid #fff';
          dot.style.boxShadow = '0 0 0 1px rgba(0,0,0,0.1)';
          dot.textContent = num ? String(num) : '';
          return { domNodes: [dot] };
        }
        return null;
      },
      eventDidMount: function(info){
        var kind = info.event && info.event.extendedProps && info.event.extendedProps.kind;
        if (kind === 'rodizio-open' || kind === 'rodizio-close' || kind === 'rodizio-sunday') {
          info.el.style.background = 'transparent';
          info.el.style.border = '0';
          info.el.style.padding = '2px';
          info.el.style.display = 'inline-flex';
          info.el.style.justifyContent = 'center';
          info.el.style.alignItems = 'center';
          info.el.style.width = 'auto';
        }
      },
      dateClick: function(info){
        calendar.changeView('timeGridDay', info.dateStr);
      },
      eventClick: function(info){
        if(info.event && info.event.url){
          info.jsEvent.preventDefault();
          window.location.href = info.event.url;
        }
      }
    });
    calendar.render();
    (function(){
      var btn = el.querySelector('.fc-viewsMenu-button');
      if(!btn) return;
      var parent = btn.parentElement;
      if(parent) parent.style.position = 'relative';
      if(el.querySelector('#fc-views-menu')) return;
      var menu = document.createElement('div');
      menu.id = 'fc-views-menu';
      menu.className = 'dropdown-menu';
      menu.style.minWidth = '180px';
      menu.style.position = 'absolute';
      menu.style.right = '0';
      menu.style.top = 'calc(100% + 4px)';
      menu.innerHTML = [
        {label: 'Mês', view: 'dayGridMonth'},
        {label: 'Semana', view: 'timeGridWeek'},
        {label: 'Dia', view: 'timeGridDay'},
        {label: 'Lista (Dia)', view: 'listDay'},
        {label: 'Lista (Mês)', view: 'listMonth'},
      ].map(function(it){ return '<button type="button" class="dropdown-item" data-view="'+it.view+'">'+it.label+'</button>'; }).join('');
      parent.appendChild(menu);
      menu.querySelectorAll('[data-view]').forEach(function(item){
        item.addEventListener('click', function(ev){
          var v = ev.currentTarget.getAttribute('data-view');
          if(v){ calendar.changeView(v); }
          menu.classList.remove('show');
        });
      });
      document.addEventListener('click', function(e){
        if(!parent.contains(e.target)){
          menu.classList.remove('show');
        }
      });
    })();
  })();
</script>
{% endblock %}
