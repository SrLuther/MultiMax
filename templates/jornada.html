{% extends 'base.html' %}
{% block title %}Registro de Jornada — MultiMax{% endblock %}
{% block breadcrumb %}
<span class="mm-breadcrumb-separator">/</span>
<span>Registro de Jornada</span>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="mm-page-header mm-flex mm-items-center mm-justify-between mm-mb-6">
    <div>
        <h1 class="mm-page-title">
            <i class="bi bi-clock-history mm-text-primary"></i>
            Registro de Jornada
        </h1>
        <p class="mm-text-muted">Gestão completa de horas trabalhadas, folgas, férias e atestados</p>
    </div>
    <div class="mm-flex mm-gap-2">
        {% if current_user.nivel in ('admin', 'DEV') %}
        <button type="button" class="mm-btn mm-btn-primary" id="btnOpenModal" aria-haspopup="dialog">
            <i class="bi bi-plus-circle"></i>
            Novo Registro
        </button>
        <a class="mm-btn mm-btn-outline" href="{{ url_for('jornada.relatorio', collaborator_id=(q_colab if q_colab else None), inicio=data_inicio, fim=data_fim) }}">
            <i class="bi bi-file-earmark-text"></i>
            Relatório
        </a>
        {% endif %}
    </div>
</div>

<!-- Tabs Navigation -->
<div class="mm-tabs mm-mb-4" role="tablist">
    <button class="mm-tab active" data-tab="resumo" role="tab" aria-selected="true" aria-controls="tab-resumo">
        <i class="bi bi-graph-up"></i>
        Resumo
    </button>
    <button class="mm-tab" data-tab="registros" role="tab" aria-selected="false" aria-controls="tab-registros">
        <i class="bi bi-table"></i>
        Registros
    </button>
    <button class="mm-tab" data-tab="folgas" role="tab" aria-selected="false" aria-controls="tab-folgas">
        <i class="bi bi-calendar-minus"></i>
        Folgas
    </button>
    <button class="mm-tab" data-tab="ferias" role="tab" aria-selected="false" aria-controls="tab-ferias">
        <i class="bi bi-sun"></i>
        Férias
    </button>
    <button class="mm-tab" data-tab="atestados" role="tab" aria-selected="false" aria-controls="tab-atestados">
        <i class="bi bi-file-medical"></i>
        Atestados
    </button>
</div>

<!-- Tab: Resumo -->
<div id="tab-resumo" class="mm-tab-content active" role="tabpanel" aria-labelledby="tab-resumo">
    <div class="mm-card mm-mb-4">
        <div class="mm-card-header">
            <h3 class="mm-card-title">
                <i class="bi bi-people"></i>
                Resumo por Colaborador
            </h3>
            <form class="mm-flex mm-gap-2" method="get" action="{{ url_for('jornada.index') }}">
                <input type="hidden" name="cs_page" value="1">
                <select name="cs_collaborator_id" class="mm-input mm-select" style="min-width: 220px;">
                    <option value="">— Todos os colaboradores —</option>
                    {% for c in colaboradores %}
                    <option value="{{ c.id }}" {% if cs_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="mm-btn mm-btn-outline">
                    <i class="bi bi-search"></i>
                    Filtrar
                </button>
            </form>
        </div>
        <div class="mm-card-body">
            {% if cs_item %}
            <div class="mm-stats-card">
                <div class="mm-stats-header">
                    <h4>{{ cs_item.name }}</h4>
                </div>
                <div class="mm-stats-grid">
                    <div class="mm-stat-item">
                        <div class="mm-stat-label">Horas Residuais</div>
                        <div class="mm-stat-value mm-text-primary">{{ '%.2f'|format(cs_item.residual_hours or 0) }}h</div>
                    </div>
                    <div class="mm-stat-item">
                        <div class="mm-stat-label">Saldo de Folgas</div>
                        <div class="mm-stat-value mm-text-success">{{ cs_item.saldo_days or 0 }} dias</div>
                    </div>
                    <div class="mm-stat-item">
                        <div class="mm-stat-label">Folgas Usadas</div>
                        <div class="mm-stat-value mm-text-warning">{{ cs_item.assigned_days or 0 }} dias</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="mm-stats-grid-all">
                {% for s in cards_stats %}
                <div class="mm-stat-card">
                    <div class="mm-stat-card-title">{{ s.name }}</div>
                    <div class="mm-stat-card-body">
                        <div class="mm-stat-mini">
                            <span class="mm-text-muted">Horas:</span>
                            <strong>{{ '%.2f'|format(s.residual_hours or 0) }}h</strong>
                        </div>
                        <div class="mm-stat-mini">
                            <span class="mm-text-muted">Folgas:</span>
                            <strong>{{ s.saldo_days or 0 }} dias</strong>
                        </div>
                        <div class="mm-stat-mini">
                            <span class="mm-text-muted">Usadas:</span>
                            <strong>{{ s.assigned_days or 0 }} dias</strong>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if cs_total_pages > 1 %}
            <div class="mm-pagination mm-mt-4">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if cs_page <= 1 %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?cs_page={{ cs_page-1 if cs_page>1 else 1 }}&cs_collaborator_id={{ cs_collab_id or '' }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <span class="mm-text-sm mm-text-muted">Página {{ cs_page }} de {{ cs_total_pages }}</span>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if cs_page >= cs_total_pages %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?cs_page={{ cs_page+1 if cs_page<cs_total_pages else cs_total_pages }}&cs_collaborator_id={{ cs_collab_id or '' }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tab: Registros -->
<div id="tab-registros" class="mm-tab-content" role="tabpanel" aria-labelledby="tab-registros">
    <div class="mm-card">
        <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
            <h3 class="mm-card-title">
                <i class="bi bi-list-check"></i>
                Registros de Jornada
            </h3>
            <span class="mm-badge">{{ total }} registros</span>
        </div>
        <div class="mm-card-body">
            <!-- Filtros -->
            <form class="mm-filter-form mm-mb-4" method="get" action="{{ url_for('jornada.index') }}">
                <div class="mm-filter-grid">
                    <div>
                        <label class="mm-label">Colaborador</label>
                        <select name="colaborador" class="mm-input">
                            <option value="">— Todos —</option>
                            {% for c in colaboradores %}
                            <option value="{{ c.id }}" {% if q_colab == c.id|string %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="mm-label">Tipo</label>
                        <select name="tipo" class="mm-input">
                            <option value="">— Todos —</option>
                            <option value="horas" {% if tipo == 'horas' %}selected{% endif %}>Horas</option>
                            <option value="dias" {% if tipo == 'dias' %}selected{% endif %}>Dias</option>
                        </select>
                    </div>
                    <div>
                        <label class="mm-label">Data Início</label>
                        <input type="date" name="inicio" value="{{ data_inicio or '' }}" class="mm-input">
                    </div>
                    <div>
                        <label class="mm-label">Data Fim</label>
                        <input type="date" name="fim" value="{{ data_fim or '' }}" class="mm-input">
                    </div>
                    <div>
                        <label class="mm-label">Ordenação</label>
                        <select name="sort" class="mm-input">
                            <option value="data desc" {% if sort == 'data desc' %}selected{% endif %}>Data ↓</option>
                            <option value="data asc" {% if sort == 'data asc' %}selected{% endif %}>Data ↑</option>
                            <option value="colaborador asc" {% if sort == 'colaborador asc' %}selected{% endif %}>Colaborador ↑</option>
                            <option value="colaborador desc" {% if sort == 'colaborador desc' %}selected{% endif %}>Colaborador ↓</option>
                        </select>
                    </div>
                    <div class="mm-flex mm-items-end">
                        <button type="submit" class="mm-btn mm-btn-primary">
                            <i class="bi bi-search"></i>
                            Buscar
                        </button>
                    </div>
                </div>
            </form>
            
            {% if q_colab %}
            <div class="mm-summary-box mm-mb-4">
                <h4 class="mm-summary-title">Resumo do Período</h4>
                <div class="mm-summary-grid">
                    <div>
                        <span class="mm-text-muted">Colaborador:</span>
                        <strong>{{ resumo_colab_nome }}</strong>
                    </div>
                    <div>
                        <span class="mm-text-muted">Total de Horas:</span>
                        <strong>{{ '%.2f'|format(resumo_horas or 0) }}h</strong>
                    </div>
                    <div>
                        <span class="mm-text-muted">Total de Dias:</span>
                        <strong>{{ '%.0f'|format(resumo_dias or 0) }} dias</strong>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Tabela de Registros -->
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Observações</th>
                            {% if current_user.nivel in ('admin', 'DEV') %}
                            <th class="text-end">Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for w, c in registros %}
                        <tr>
                            <td><strong>{{ c.name }}</strong></td>
                            <td>
                                <span class="mm-badge {% if w.tipo_registro == 'horas' %}mm-badge-primary{% else %}mm-badge-success{% endif %}">
                                    {{ 'Horas' if w.tipo_registro == 'horas' else 'Dias' }}
                                </span>
                            </td>
                            <td>
                                {% if w.tipo_registro == 'horas' %}
                                    {{ '%.2f'|format(w.valor or 0) }}h
                                {% else %}
                                    {{ '%.0f'|format(w.valor or 0) }} dia(s)
                                {% endif %}
                            </td>
                            <td>{{ w.data.strftime('%d/%m/%Y') }}</td>
                            <td>{{ w.observacao or '-' }}</td>
                            {% if current_user.nivel in ('admin', 'DEV') %}
                            <td class="text-end">
                                <div class="mm-flex mm-gap-2 mm-justify-end">
                                    <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" 
                                            data-edit-id="{{ w.id }}" 
                                            data-edit-colab="{{ c.id }}" 
                                            data-edit-tipo="{{ w.tipo_registro }}" 
                                            data-edit-valor="{{ '%.2f'|format(w.valor or 0) }}" 
                                            data-edit-data="{{ w.data.strftime('%Y-%m-%d') }}" 
                                            data-edit-obs="{{ w.observacao or '' }}"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form method="post" action="{{ url_for('jornada.delete', worklog_id=w.id) }}" 
                                          onsubmit="return confirm('Excluir este registro?')" 
                                          style="display:inline;">
                                        <button class="mm-btn mm-btn-sm mm-btn-danger" type="submit" title="Excluir">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 6 if current_user.nivel in ('admin', 'DEV') else 5 }}" class="mm-empty-cell">
                                <div class="mm-empty-state">
                                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <p>Nenhum registro encontrado</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginação -->
            {% if total_pages > 1 %}
            <div class="mm-pagination mm-mt-4">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if page <= 1 %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?page={{ page-1 if page>1 else 1 }}&colaborador={{ q_colab }}&tipo={{ tipo }}&inicio={{ data_inicio }}&fim={{ data_fim }}&sort={{ sort }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <span class="mm-text-sm mm-text-muted">Página {{ page }} de {{ total_pages }}</span>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if page >= total_pages %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?page={{ page+1 if page<total_pages else total_pages }}&colaborador={{ q_colab }}&tipo={{ tipo }}&inicio={{ data_inicio }}&fim={{ data_fim }}&sort={{ sort }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tab: Folgas -->
<div id="tab-folgas" class="mm-tab-content" role="tabpanel" aria-labelledby="tab-folgas">
    <div class="mm-card">
        <div class="mm-card-header">
            <h3 class="mm-card-title">
                <i class="bi bi-calendar-minus"></i>
                Uso de Folgas
            </h3>
        </div>
        <div class="mm-card-body">
            <form method="get" action="{{ url_for('jornada.index') }}" class="mm-filter-form mm-mb-4">
                <input type="hidden" name="la_page" value="1">
                <div class="mm-flex mm-gap-2">
                    <select name="la_collaborator_id" class="mm-input" style="min-width: 220px;">
                        <option value="">— Filtrar colaborador —</option>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}" {% if la_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="mm-btn mm-btn-outline">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </form>
            
            <form method="post" action="{{ url_for('usuarios.gestao_colabs_folga_uso_adicionar') }}" class="mm-form-row mm-mb-6">
                <div class="mm-form-group">
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" class="mm-input" required>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data</label>
                    <input type="date" name="date" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Dias</label>
                    <input type="number" name="days" id="diasInput" class="mm-input" min="1" value="1" required>
                    <input type="hidden" name="days_used" id="days_used_hidden">
                </div>
                <div class="mm-form-group" style="flex: 2;">
                    <label class="mm-label">Observações</label>
                    <input type="text" name="notes" class="mm-input" placeholder="Observações (opcional)">
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Ação</label>
                    <div class="mm-flex mm-gap-3">
                        <label class="mm-flex mm-items-center mm-gap-2">
                            <input type="radio" name="acao" value="uso" id="acaoUso" checked>
                            <span>Registrar uso</span>
                        </label>
                        <label class="mm-flex mm-items-center mm-gap-2">
                            <input type="radio" name="acao" value="conversao" id="acaoConv">
                            <span>Converter em R$</span>
                        </label>
                    </div>
                </div>
                <div class="mm-form-group" id="convRate" hidden>
                    <label class="mm-label">Valor por dia (R$)</label>
                    <input type="number" step="0.01" name="rate_per_day" id="rateInput" class="mm-input" value="65">
                </div>
                <div class="mm-form-group" id="convAmount" hidden>
                    <label class="mm-label">Total a pagar (R$)</label>
                    <input type="number" step="0.01" name="amount_paid" id="amountInput" class="mm-input" value="65.00">
                </div>
                <div class="mm-form-group" style="align-self: end;">
                    <button class="mm-btn mm-btn-primary" type="submit">
                        <i class="bi bi-plus-lg"></i>
                        Salvar
                    </button>
                </div>
            </form>
            
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Colaborador</th>
                            <th class="text-center">Dias Usados</th>
                            <th>Observações</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for la in leave_assignments_page %}
                        {% set col = colaboradores|selectattr('id', 'equalto', la.collaborator_id)|list|first %}
                        <tr>
                            <td>{{ la.date.strftime('%d/%m/%Y') }}</td>
                            <td>{{ col.name if col else ('ID ' ~ la.collaborator_id) }}</td>
                            <td class="text-center">
                                <span class="mm-badge mm-badge-danger">-{{ la.days_used }}</span>
                            </td>
                            <td>{{ la.notes or '-' }}</td>
                            <td class="text-end">
                                <form method="post" action="{{ url_for('usuarios.gestao_colabs_folga_uso_excluir', id=la.id) }}" 
                                      class="mm-inline-form" onsubmit="return confirm('Excluir uso de folga?')">
                                    <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="mm-empty-cell">
                                <div class="mm-empty-state">
                                    <i class="bi bi-calendar-x" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <p>Sem uso de folgas registrado</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if la_total_pages > 1 %}
            <div class="mm-pagination mm-mt-4">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if la_page <= 1 %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?la_page={{ la_page-1 if la_page>1 else 1 }}&la_collaborator_id={{ la_collab_id or '' }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <span class="mm-text-sm mm-text-muted">Página {{ la_page }} de {{ la_total_pages }}</span>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if la_page >= la_total_pages %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?la_page={{ la_page+1 if la_page<la_total_pages else la_total_pages }}&la_collaborator_id={{ la_collab_id or '' }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tab: Férias -->
<div id="tab-ferias" class="mm-tab-content" role="tabpanel" aria-labelledby="tab-ferias">
    <div class="mm-card">
        <div class="mm-card-header">
            <h3 class="mm-card-title">
                <i class="bi bi-sun"></i>
                Gestão de Férias
            </h3>
        </div>
        <div class="mm-card-body">
            <form method="get" action="{{ url_for('jornada.index') }}" class="mm-filter-form mm-mb-4">
                <input type="hidden" name="ferias_page" value="1">
                <div class="mm-flex mm-gap-2">
                    <select name="ferias_collaborator_id" class="mm-input" style="min-width: 220px;">
                        <option value="">— Filtrar colaborador —</option>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}" {% if ferias_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="mm-btn mm-btn-outline">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </form>
            
            <form method="post" action="{{ url_for('usuarios.gestao_ferias_adicionar') }}" class="mm-form-row mm-mb-6">
                <div class="mm-form-group">
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" class="mm-input" required>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Início</label>
                    <input type="date" name="data_inicio" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Fim</label>
                    <input type="date" name="data_fim" class="mm-input" required>
                </div>
                <div class="mm-form-group" style="flex: 2;">
                    <label class="mm-label">Observação</label>
                    <input type="text" name="observacao" class="mm-input" placeholder="Observação (opcional)">
                </div>
                <div class="mm-form-group" style="align-self: end;">
                    <button class="mm-btn mm-btn-primary" type="submit">
                        <i class="bi bi-plus-lg"></i>
                        Registrar Férias
                    </button>
                </div>
            </form>
            
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Data Início</th>
                            <th>Data Fim</th>
                            <th class="text-center">Dias</th>
                            <th>Observação</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for f in ferias_page_items %}
                        {% set col = colaboradores|selectattr('id', 'equalto', f.collaborator_id)|list|first %}
                        <tr>
                            <td>{{ col.name if col else ('ID ' ~ f.collaborator_id) }}</td>
                            <td>{{ f.data_inicio.strftime('%d/%m/%Y') }}</td>
                            <td>{{ f.data_fim.strftime('%d/%m/%Y') }}</td>
                            <td class="text-center">
                                <span class="mm-badge mm-badge-warning">{{ (f.data_fim - f.data_inicio).days + 1 }} dias</span>
                            </td>
                            <td>{{ f.observacao or '-' }}</td>
                            <td class="text-end">
                                <form method="post" action="{{ url_for('usuarios.gestao_ferias_excluir', id=f.id) }}" 
                                      class="mm-inline-form" onsubmit="return confirm('Excluir férias?')">
                                    <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="mm-empty-cell">
                                <div class="mm-empty-state">
                                    <i class="bi bi-sun" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <p>Nenhuma férias registrada</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if ferias_total_pages > 1 %}
            <div class="mm-pagination mm-mt-4">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if ferias_page <= 1 %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?ferias_page={{ ferias_page-1 if ferias_page>1 else 1 }}&ferias_collaborator_id={{ ferias_collab_id or '' }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <span class="mm-text-sm mm-text-muted">Página {{ ferias_page }} de {{ ferias_total_pages }}</span>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if ferias_page >= ferias_total_pages %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?ferias_page={{ ferias_page+1 if ferias_page<ferias_total_pages else ferias_total_pages }}&ferias_collaborator_id={{ ferias_collab_id or '' }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Tab: Atestados -->
<div id="tab-atestados" class="mm-tab-content" role="tabpanel" aria-labelledby="tab-atestados">
    <div class="mm-card">
        <div class="mm-card-header">
            <h3 class="mm-card-title">
                <i class="bi bi-file-medical"></i>
                Atestados Médicos
            </h3>
        </div>
        <div class="mm-card-body">
            <form method="get" action="{{ url_for('jornada.index') }}" class="mm-filter-form mm-mb-4">
                <input type="hidden" name="at_page" value="1">
                <div class="mm-flex mm-gap-2">
                    <select name="at_collaborator_id" class="mm-input" style="min-width: 220px;">
                        <option value="">— Filtrar colaborador —</option>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}" {% if at_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="mm-btn mm-btn-outline">
                        <i class="bi bi-search"></i> Filtrar
                    </button>
                </div>
            </form>
            
            <form method="post" action="{{ url_for('usuarios.gestao_atestado_adicionar') }}" 
                  enctype="multipart/form-data" class="mm-form-row mm-mb-6" style="flex-wrap: wrap;">
                <div class="mm-form-group">
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" class="mm-input" required>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Início</label>
                    <input type="date" name="data_inicio" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Fim</label>
                    <input type="date" name="data_fim" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">CID (opcional)</label>
                    <input type="text" name="cid" class="mm-input" placeholder="Ex: J00">
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Médico (opcional)</label>
                    <input type="text" name="medico" class="mm-input" placeholder="Nome do médico">
                </div>
                <div class="mm-form-group" style="flex: 2;">
                    <label class="mm-label">Motivo</label>
                    <input type="text" name="motivo" class="mm-input" placeholder="Motivo do afastamento">
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Foto do Atestado</label>
                    <input type="file" name="foto_atestado" class="mm-input" accept="image/*">
                </div>
                <div class="mm-form-group" style="align-self: end;">
                    <button class="mm-btn mm-btn-primary" type="submit">
                        <i class="bi bi-plus-lg"></i>
                        Registrar Atestado
                    </button>
                </div>
            </form>
            
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Período</th>
                            <th class="text-center">Dias</th>
                            <th>Motivo</th>
                            <th>CID</th>
                            <th>Foto</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in atestados_page %}
                        {% set col = colaboradores|selectattr('id', 'equalto', a.collaborator_id)|list|first %}
                        <tr>
                            <td>{{ col.name if col else ('ID ' ~ a.collaborator_id) }}</td>
                            <td>{{ a.data_inicio.strftime('%d/%m') }} - {{ a.data_fim.strftime('%d/%m/%Y') }}</td>
                            <td class="text-center">
                                <span class="mm-badge mm-badge-info">{{ a.dias }} dias</span>
                            </td>
                            <td>{{ a.motivo or '-' }}</td>
                            <td>{{ a.cid or '-' }}</td>
                            <td>
                                {% if a.foto_atestado %}
                                <a href="{{ url_for('static', filename='uploads/atestados/' ~ a.foto_atestado) }}" 
                                   target="_blank" class="mm-btn mm-btn-outline mm-btn-sm">
                                    <i class="bi bi-image"></i> Ver
                                </a>
                                {% else %}
                                <span class="mm-text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <form method="post" action="{{ url_for('usuarios.gestao_atestado_excluir', id=a.id) }}" 
                                      class="mm-inline-form" onsubmit="return confirm('Excluir atestado?')">
                                    <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="mm-empty-cell">
                                <div class="mm-empty-state">
                                    <i class="bi bi-file-medical" style="font-size: 3rem; opacity: 0.3;"></i>
                                    <p>Nenhum atestado registrado</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if at_total_pages > 1 %}
            <div class="mm-pagination mm-mt-4">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if at_page <= 1 %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?at_page={{ at_page-1 if at_page>1 else 1 }}&at_collaborator_id={{ at_collab_id or '' }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <span class="mm-text-sm mm-text-muted">Página {{ at_page }} de {{ at_total_pages }}</span>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if at_page >= at_total_pages %}mm-disabled{% endif %}" 
                   href="{{ url_for('jornada.index') }}?at_page={{ at_page+1 if at_page<at_total_pages else at_total_pages }}&at_collaborator_id={{ at_collab_id or '' }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para criar/editar registro -->
<div id="modalOverlay" class="mm-modal-overlay" hidden></div>
<div id="modalDialog" class="mm-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="mm-modal-header">
        <h3 id="modalTitle" class="mm-card-title">
            <i class="bi bi-pencil-square mm-text-primary"></i>
            <span id="modalTitleText">Novo Registro</span>
        </h3>
        <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" id="btnCloseModal" aria-label="Fechar">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="mm-modal-body">
        <form id="jornadaForm" method="post">
            <input type="hidden" name="_edit_id" id="_edit_id">
            <input type="hidden" name="hours" id="hoursHidden">
            <input type="hidden" name="amount_days" id="amountDaysHidden">
            <input type="hidden" name="days_used" id="daysUsedHidden">
            <input type="hidden" name="origin" id="originHidden" value="manual">
            <input type="hidden" name="reason" id="reasonHidden">
            <input type="hidden" name="notes" id="notesHidden">
            <input type="hidden" name="tipo" id="tipoHidden">
            
            <div class="mm-grid mm-grid-cols-2 mm-gap-4">
                <div>
                    <label class="mm-label">Ação</label>
                    <select id="acaoSelect" name="acao_unificada" class="mm-input">
                        <option value="horas" selected>Horas Extra</option>
                        <option value="folga_credito">Folga (Crédito)</option>
                        <option value="folga_uso">Folga (Uso)</option>
                    </select>
                    <div id="acaoHelp" class="mm-text-sm mm-text-muted mm-mt-1"></div>
                </div>
                <div>
                    <label class="mm-label">Data</label>
                    <input type="date" name="date" id="dataInput" class="mm-input" required>
                    <input type="hidden" name="data" id="dataHidden">
                    <div class="mm-text-sm mm-text-muted mm-mt-1" id="dateFeedback"></div>
                </div>
                <div>
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" id="colabSelect" class="mm-input" required>
                        <option value="">Selecione...</option>
                        {% for col in colaboradores %}
                        <option value="{{ col.id }}">{{ col.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="mm-label" id="valorLabel">Horas</label>
                    <input type="number" step="0.25" min="0" max="24" id="valorInput" class="mm-input" placeholder="Ex.: 2.5" required>
                    <input type="hidden" name="valor" id="valorHidden">
                    <div class="mm-text-sm mm-mt-1" id="valorFeedback"></div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="mm-label">Observações</label>
                    <input type="text" name="observacao" id="obsInput" class="mm-input" placeholder="Observações (opcional)">
                </div>
            </div>
            
            <div id="opSummary" class="mm-summary-box mm-mt-3" aria-live="polite"></div>
            
            <div class="mm-flex mm-justify-end mm-gap-2 mm-mt-4">
                <button type="button" class="mm-btn mm-btn-outline" onclick="closeModal()">
                    Cancelar
                </button>
                <button type="submit" class="mm-btn mm-btn-primary" id="btnSubmit">
                    <span id="submitLabel">Salvar</span>
                    <span id="submitLoading" hidden>
                        <i class="bi bi-arrow-repeat bi-spin"></i>
                    </span>
                </button>
            </div>
        </form>
        <div id="editHistory" class="mm-mt-4" hidden></div>
    </div>
</div>

<style>
/* Tabs */
.mm-tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--mm-border);
    margin-bottom: 1.5rem;
    overflow-x: auto;
}

.mm-tab {
    padding: 0.75rem 1.5rem;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--mm-text-muted);
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    white-space: nowrap;
}

.mm-tab:hover {
    color: var(--mm-text);
    background: var(--mm-bg-secondary);
}

.mm-tab.active {
    color: var(--mm-primary);
    border-bottom-color: var(--mm-primary);
}

.mm-tab-content {
    display: none;
}

.mm-tab-content.active {
    display: block;
}

/* Stats Cards */
.mm-stats-card {
    background: var(--mm-bg-card);
    border: 1px solid var(--mm-border);
    border-radius: var(--mm-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.mm-stats-header h4 {
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    font-weight: 600;
}

.mm-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
}

.mm-stat-item {
    text-align: center;
}

.mm-stat-label {
    font-size: 0.875rem;
    color: var(--mm-text-muted);
    margin-bottom: 0.5rem;
}

.mm-stat-value {
    font-size: 1.75rem;
    font-weight: 700;
}

.mm-stats-grid-all {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.mm-stat-card {
    background: var(--mm-bg-card);
    border: 1px solid var(--mm-border);
    border-radius: var(--mm-radius);
    padding: 1rem;
}

.mm-stat-card-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--mm-border);
}

.mm-stat-card-body {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.mm-stat-mini {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
}

/* Filter Form */
.mm-filter-form {
    background: var(--mm-bg-secondary);
    padding: 1rem;
    border-radius: var(--mm-radius);
}

.mm-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    align-items: end;
}

/* Summary Box */
.mm-summary-box {
    background: var(--mm-bg-secondary);
    border: 1px dashed var(--mm-border);
    border-radius: var(--mm-radius);
    padding: 1rem;
}

.mm-summary-title {
    font-weight: 600;
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.mm-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

/* Modal */
.mm-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.mm-modal-overlay:not([hidden]) {
    opacity: 1;
}

.mm-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(720px, 92vw);
    max-height: 90vh;
    background: var(--mm-bg-card);
    border: 1px solid var(--mm-border);
    border-radius: var(--mm-radius-lg);
    z-index: 1001;
    display: flex;
    flex-direction: column;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.mm-modal:not([hidden]) {
    opacity: 1;
}

.mm-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem;
    border-bottom: 1px solid var(--mm-border);
}

.mm-modal-body {
    padding: 1.25rem;
    overflow-y: auto;
    flex: 1;
}

.bi-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .mm-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .mm-tab {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    .mm-filter-grid {
        grid-template-columns: 1fr;
    }
    
    .mm-stats-grid-all {
        grid-template-columns: 1fr;
    }
    
    .mm-modal {
        width: 95vw;
        max-height: 95vh;
        top: 2.5vh;
        left: 2.5vw;
        transform: none;
    }
    
    .mm-page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
}
</style>

<script>
// ============================================================================
// Variáveis Globais
// ============================================================================
const overlay = document.getElementById('modalOverlay');
const dialog = document.getElementById('modalDialog');
const openBtn = document.getElementById('btnOpenModal');
const closeBtn = document.getElementById('btnCloseModal');
const form = document.getElementById('jornadaForm');
const valorInput = document.getElementById('valorInput');
const valorLabel = document.getElementById('valorLabel');
const valorHidden = document.getElementById('valorHidden');
const dataInput = document.getElementById('dataInput');
const dataHidden = document.getElementById('dataHidden');
const colabSelect = document.getElementById('colabSelect');
const obsInput = document.getElementById('obsInput');
const submitLabel = document.getElementById('submitLabel');
const submitLoading = document.getElementById('submitLoading');
const acaoSelect = document.getElementById('acaoSelect');
const tipoHidden = document.getElementById('tipoHidden');
const hoursHidden = document.getElementById('hoursHidden');
const amountDaysHidden = document.getElementById('amountDaysHidden');
const daysUsedHidden = document.getElementById('daysUsedHidden');
const originHidden = document.getElementById('originHidden');
const reasonHidden = document.getElementById('reasonHidden');
const notesHidden = document.getElementById('notesHidden');
const modalTitleText = document.getElementById('modalTitleText');

// ============================================================================
// Tabs
// ============================================================================
(function() {
    const tabs = document.querySelectorAll('.mm-tab');
    const contents = document.querySelectorAll('.mm-tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');
            
            // Remover active de todas as tabs e contents
            tabs.forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            contents.forEach(c => {
                c.classList.remove('active');
            });
            
            // Adicionar active à tab e content selecionados
            tab.classList.add('active');
            tab.setAttribute('aria-selected', 'true');
            const targetContent = document.getElementById(`tab-${targetTab}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        });
    });
})();

// ============================================================================
// Modal
// ============================================================================
function openModal() {
    overlay.hidden = false;
    dialog.hidden = false;
    requestAnimationFrame(() => {
        overlay.style.opacity = '1';
        dialog.style.opacity = '1';
    });
    dialog.focus();
}

function closeModal() {
    overlay.style.opacity = '0';
    dialog.style.opacity = '0';
    setTimeout(() => {
        overlay.hidden = true;
        dialog.hidden = true;
        form.reset();
        document.getElementById('_edit_id').value = '';
    }, 300);
}

if (openBtn) {
    openBtn.addEventListener('click', () => {
        document.getElementById('_edit_id').value = '';
        modalTitleText.textContent = 'Novo Registro';
        submitLabel.textContent = 'Salvar';
        form.action = '';
        setAction();
        openModal();
    });
}

if (closeBtn) closeBtn.addEventListener('click', closeModal);
overlay.addEventListener('click', closeModal);
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !dialog.hidden) closeModal();
});

// ============================================================================
// Editar Registro
// ============================================================================
document.querySelectorAll('[data-edit-id]').forEach(btn => {
    btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-edit-id');
        const cid = btn.getAttribute('data-edit-colab');
        const tipo = btn.getAttribute('data-edit-tipo');
        const valor = btn.getAttribute('data-edit-valor');
        const data = btn.getAttribute('data-edit-data');
        const obs = btn.getAttribute('data-edit-obs') || '';
        
        document.getElementById('_edit_id').value = id;
        form.action = "{{ url_for('jornada.update', worklog_id='__ID__') }}".replace('__ID__', id);
        tipoHidden.value = tipo;
        modalTitleText.textContent = 'Editar Registro';
        submitLabel.textContent = 'Salvar Alterações';
        
        if (tipo === 'horas') {
            valorLabel.textContent = 'Horas';
            valorInput.step = '0.25';
            valorInput.min = '0';
            valorInput.max = '24';
        } else {
            valorLabel.textContent = 'Dias';
            valorInput.step = '1';
            valorInput.min = '1';
            valorInput.max = '365';
        }
        
        valorInput.value = valor;
        if (valorHidden) valorHidden.value = valor;
        dataInput.value = data;
        if (dataHidden) dataHidden.value = data;
        colabSelect.value = cid;
        obsInput.value = obs;
        
        setAction();
        openModal();
    });
});

// ============================================================================
// Set Action (Tipo de ação)
// ============================================================================
function setAction() {
    const val = (acaoSelect && acaoSelect.value) || 'horas';
    const editIdVal = document.getElementById('_edit_id').value;
    
    let label = 'Horas';
    let step = 0.25;
    let min = 0;
    let max = 24;
    let placeholder = 'Ex.: 2.5';
    let help = 'Registra horas no banco. Conversão automática 8h→1 dia e ajuste -8h aplicados.';
    
    if (val === 'folga_credito') {
        label = 'Dias (crédito)';
        step = 1;
        min = 1;
        max = 365;
        placeholder = 'Ex.: 1';
        help = 'Adiciona dias ao saldo de folgas do colaborador.';
    } else if (val === 'folga_uso') {
        label = 'Valor';
        step = 1;
        min = 1;
        max = 365;
        placeholder = 'Ex.: 1';
        help = 'Debita dias do saldo, somente se houver saldo positivo.';
    }
    
    valorLabel.textContent = label;
    valorInput.step = String(step);
    valorInput.min = String(min);
    valorInput.max = String(max);
    valorInput.placeholder = placeholder;
    
    const helpBox = document.getElementById('acaoHelp');
    if (helpBox) helpBox.textContent = help;
    
    if (!editIdVal) {
        if (val === 'horas') {
            form.action = "{{ url_for('usuarios.gestao_colabs_horas_adicionar') }}";
        } else if (val === 'folga_credito') {
            form.action = "{{ url_for('usuarios.gestao_colabs_folga_credito_adicionar') }}";
        } else if (val === 'folga_uso') {
            form.action = "{{ url_for('usuarios.gestao_colabs_folga_uso_adicionar') }}";
        }
    }
    
    renderSummary();
}

if (acaoSelect) acaoSelect.addEventListener('change', setAction);

// ============================================================================
// Validação e Submit
// ============================================================================
function parseYmd(dstr) {
    const parts = (dstr || '').split('-');
    const y = parseInt(parts[0] || '0', 10);
    const m = parseInt(parts[1] || '1', 10) - 1;
    const d = parseInt(parts[2] || '1', 10);
    return new Date(y, m, d);
}

function formatBRDate(dstr) {
    const dt = parseYmd(dstr);
    const dd = String(dt.getDate()).padStart(2, '0');
    const mm = String(dt.getMonth() + 1).padStart(2, '0');
    const yyyy = dt.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
}

function isSunday(d) {
    const t = parseYmd(d);
    return t.getDay() === 0;
}

function checkHoliday(d) {
    const dateFeedback = document.getElementById('dateFeedback');
    fetch("{{ url_for('jornada.is_holiday') }}?date=" + encodeURIComponent(d))
        .then(r => r.json())
        .then(j => {
            if (j && j.holiday) {
                dateFeedback.textContent = 'Feriado: ' + (j.name || '');
            } else if (isSunday(d)) {
                dateFeedback.textContent = 'Fim de semana';
            } else {
                dateFeedback.textContent = '';
            }
        })
        .catch(() => {
            if (isSunday(d)) {
                dateFeedback.textContent = 'Fim de semana';
            } else {
                dateFeedback.textContent = '';
            }
        });
}

if (dataInput) {
    dataInput.addEventListener('change', () => {
        const d = dataInput.value;
        if (d) checkHoliday(d);
    });
}

form.addEventListener('submit', (e) => {
    e.preventDefault();
    
    submitLoading.hidden = false;
    submitLabel.textContent = 'Salvando...';
    
    const v = parseFloat(valorInput.value || 'NaN');
    const d = dataInput.value;
    const cid = colabSelect.value;
    
    // Validação
    if (isNaN(v) || !cid || !d) {
        submitLoading.hidden = true;
        submitLabel.textContent = 'Salvar';
        alert('Preencha todos os campos obrigatórios.');
        return;
    }
    
    const today = new Date();
    const dd = new Date(d);
    if (dd > today) {
        submitLoading.hidden = true;
        submitLabel.textContent = 'Salvar';
        alert('Data futura não permitida.');
        return;
    }
    
    // Verificar se é edição
    const editIdVal = document.getElementById('_edit_id').value;
    
    if (editIdVal) {
        // Edição - usar rota de update
        const tipoVal = tipoHidden.value || 'horas';
        const obs = (obsInput.value || '').trim();
        
        tipoHidden.value = tipoVal;
        if (valorHidden) valorHidden.value = v.toString();
        if (dataHidden) dataHidden.value = d;
        
        const updateUrl = form.action || "{{ url_for('jornada.update', worklog_id='__ID__') }}".replace('__ID__', editIdVal);
        const updateForm = new FormData(form);
        updateForm.set('tipo', tipoVal);
        updateForm.set('collaborator_id', cid);
        updateForm.set('valor', v.toString());
        updateForm.set('data', d);
        updateForm.set('observacao', obs);
        
        fetch(updateUrl, { method: 'POST', body: updateForm })
            .then(() => {
                window.location.href = "{{ url_for('jornada.index') }}";
            })
            .catch(() => {
                submitLoading.hidden = true;
                submitLabel.textContent = 'Salvar';
                alert('Erro ao salvar. Tente novamente.');
            });
    } else {
        // Criação - usar rota jornada.create que salva em RegistroJornada
        const valSubmit = (acaoSelect && acaoSelect.value) || 'horas';
        const obs = (obsInput.value || '').trim();
        
        // Determinar tipo baseado na ação selecionada
        let tipo = 'horas';
        if (valSubmit === 'folga_credito' || valSubmit === 'folga_uso') {
            tipo = 'dias';
        }
        
        // Preparar dados para jornada.create
        tipoHidden.value = tipo;
        if (valorHidden) valorHidden.value = v.toString();
        if (dataHidden) dataHidden.value = d;
        
        // Usar a rota jornada.create que salva diretamente em RegistroJornada
        const createUrl = "{{ url_for('jornada.create') }}";
        const createForm = new FormData();
        createForm.append('tipo', tipo);
        createForm.append('collaborator_id', cid);
        createForm.append('valor', v.toString());
        createForm.append('data', d);
        createForm.append('observacao', obs);
        
        fetch(createUrl, { 
            method: 'POST', 
            body: createForm
        })
            .then(response => {
                if (response.redirected || response.ok) {
                    window.location.href = "{{ url_for('jornada.index') }}";
                } else {
                    return response.text().then(text => {
                        console.error('Resposta do servidor:', text);
                        throw new Error('Erro na resposta do servidor');
                    });
                }
            })
            .catch(error => {
                console.error('Erro ao salvar:', error);
                submitLoading.hidden = true;
                submitLabel.textContent = 'Salvar';
                alert('Erro ao salvar. Verifique o console do navegador (F12) para mais detalhes.');
            });
    }
});

// ============================================================================
// Summary
// ============================================================================
function renderSummary() {
    const box = document.getElementById('opSummary');
    if (!box) return;
    
    const val = (acaoSelect && acaoSelect.value) || 'horas';
    let tipo = 'Horas Extra';
    if (val === 'folga_credito') tipo = 'Folga (Crédito)';
    else if (val === 'folga_uso') tipo = 'Folga (Uso)';
    
    const vraw = valorInput.value || '';
    let valor = '—';
    if (vraw !== '' && !isNaN(parseFloat(vraw))) {
        if (val === 'horas') {
            valor = `${parseFloat(vraw)}h`;
        } else {
            valor = `${Math.max(1, Math.round(parseFloat(vraw)))} dia(s)`;
        }
    }
    
    const d = dataInput.value || '';
    const data = d ? formatBRDate(d) : '—';
    
    let colaborador = '—';
    if (colabSelect && colabSelect.value) {
        const opt = colabSelect.options[colabSelect.selectedIndex];
        colaborador = opt ? opt.text : '—';
    }
    
    box.textContent = `Operação: ${tipo} • Valor: ${valor} • Data: ${data} • Colaborador: ${colaborador}`;
}

if (valorInput) valorInput.addEventListener('input', renderSummary);
if (dataInput) dataInput.addEventListener('change', renderSummary);
if (colabSelect) colabSelect.addEventListener('change', renderSummary);

// ============================================================================
// Folgas - Conversão
// ============================================================================
(function() {
    const uso = document.getElementById('acaoUso');
    const conv = document.getElementById('acaoConv');
    const rateBox = document.getElementById('convRate');
    const amountBox = document.getElementById('convAmount');
    const dias = document.getElementById('diasInput');
    const rate = document.getElementById('rateInput');
    const amount = document.getElementById('amountInput');
    const hiddenDaysUsed = document.getElementById('days_used_hidden');
    
    function sync() {
        if (hiddenDaysUsed && dias) hiddenDaysUsed.value = dias.value || 1;
        const isConv = conv && conv.checked;
        if (rateBox) rateBox.hidden = !isConv;
        if (amountBox) amountBox.hidden = !isConv;
        if (isConv && dias && rate && amount) {
            const d = parseFloat(dias.value || '1');
            const r = parseFloat(rate.value || '0');
            amount.value = (d * r).toFixed(2);
        }
    }
    
    if (uso) uso.addEventListener('change', sync);
    if (conv) conv.addEventListener('change', sync);
    if (dias) dias.addEventListener('input', sync);
    if (rate) rate.addEventListener('input', sync);
    sync();
})();
</script>
{% endblock %}
