{% extends 'base.html' %}
{% block title %}Registro Unificado de Jornada — MultiMax{% endblock %}
{% block breadcrumb %}
<span class="mm-breadcrumb-separator">/</span>
<span>Registro de Jornada</span>
{% endblock %}
{% block content %}
<div class="mm-page-header mm-flex mm-items-center mm-justify-between mm-mb-6">
    <div>
        <h1 class="mm-page-title">Registro Unificado de Jornada</h1>
        <p class="mm-text-muted">Folgas e horas trabalhadas em um único lugar</p>
        <div class="mm-flex mm-gap-3 mm-mt-3">
            {% if current_user.nivel == 'admin' %}
            <button type="button" class="mm-btn mm-btn-primary" id="btnOpenModal" aria-haspopup="dialog">
                <i class="bi bi-pencil-square"></i>
                Atualizar
            </button>
            <form method="post" action="{{ url_for('jornada.migrar') }}" onsubmit="return confirm('Migrar registros existentes para a tabela unificada?')">
                <button type="submit" class="mm-btn mm-btn-outline mm-migrar-btn">
                    <i class="bi bi-arrow-repeat"></i>
                    Migrar Dados
                </button>
            </form>
            {% endif %}
            
            {% if current_user.nivel == 'admin' %}
            <a class="mm-btn mm-btn-outline mm-export-btn" href="{{ url_for('jornada.relatorio', collaborator_id=(q_colab if q_colab else None), inicio=data_inicio, fim=data_fim) }}">
                <i class="bi bi-journal-text"></i>
                Relatório
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="mm-subnav mm-sticky"></div>

<div class="mm-card mm-mb-6 mm-resumo-card">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title"><i class="bi bi-people me-2"></i>Resumo</h3>
    </div>
    <div class="mm-card-body">
        <form class="mm-flex mm-gap-2 mm-items-center mm-mb-3" method="get" action="{{ url_for('jornada.index') }}">
            <input type="hidden" name="cs_page" value="1">
            <label class="mm-label">Colaborador</label>
            <select name="cs_collaborator_id" class="mm-input mm-select" style="min-width: 220px;">
                <option value="">— todos —</option>
                {% for c in colaboradores %}
                <option value="{{ c.id }}" {% if cs_collab_id and cs_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mm-btn mm-btn-outline"><i class="bi bi-search"></i> Filtrar</button>
        </form>
        <div class="mm-flex mm-flex-wrap mm-gap-4">
            {% if cs_item %}
            <div class="mm-card-mini">
                <div class="mm-card-mini-title">{{ cs_item.name }}</div>
                <div class="mm-card-mini-grid">
                    <div class="mm-text-muted">Horas (residual)</div>
                    <div class="mm-text-right mm-font-bold">{{ '%.2f'|format(cs_item.residual_hours or 0) }} h</div>
                    <div class="mm-text-muted">Dias de Folga</div>
                    <div class="mm-text-right mm-font-bold">{{ cs_item.saldo_days or 0 }} dia(s)</div>
                    <div class="mm-text-muted">Folgas usadas</div>
                    <div class="mm-text-right mm-font-bold">{{ cs_item.assigned_days or 0 }} dia(s)</div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="mm-resumo-grid" aria-hidden="true">
            {% for s in cards_stats %}
            <div class="mm-card-mini">
                <div class="mm-card-mini-title">{{ s.name }}</div>
                <div class="mm-card-mini-grid">
                    <div class="mm-text-muted">Horas (residual)</div>
                    <div class="mm-text-right mm-font-bold">{{ '%.2f'|format(s.residual_hours or 0) }} h</div>
                    <div class="mm-text-muted">Dias de Folga</div>
                    <div class="mm-text-right mm-font-bold">{{ s.saldo_days or 0 }} dia(s)</div>
                    <div class="mm-text-muted">Folgas usadas</div>
                    <div class="mm-text-right mm-font-bold">{{ s.assigned_days or 0 }} dia(s)</div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="mm-flex mm-items-center mm-justify-between mm-mt-3">
            <div class="mm-text-sm mm-text-muted">Página {{ cs_page }} de {{ cs_total_pages }}</div>
            <div class="mm-pagination">
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if cs_page <= 1 %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?cs_page={{ cs_page-1 if cs_page>1 else 1 }}&cs_collaborator_id={{ cs_collab_id or '' }}">
                    <i class="bi bi-chevron-left"></i> Anterior
                </a>
                <a class="mm-btn mm-btn-sm mm-btn-outline {% if cs_page >= cs_total_pages %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?cs_page={{ cs_page+1 if cs_page<cs_total_pages else cs_total_pages }}&cs_collaborator_id={{ cs_collab_id or '' }}">
                    Próxima <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="mm-card mm-mb-6">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title"><i class="bi bi-activity me-2"></i>Gestão de Jornada</h3>
        <div class="mm-flex mm-gap-2">
            <a class="mm-btn mm-btn-sm mm-btn-outline" href="{{ url_for('jornada.index') }}">
                <i class="bi bi-x-lg"></i>
                Limpar
            </a>
            {% if current_user.nivel == 'admin' %}
            <form method="post" action="{{ url_for('jornada.delete_by_date') }}" onsubmit="return confirm('Excluir todos os registros no período informado?')" class="mm-flex mm-gap-2">
                <input type="hidden" name="colaborador" value="{{ q_colab or '' }}">
                <input type="hidden" name="tipo" value="{{ tipo or '' }}">
                <input type="hidden" name="inicio" value="{{ data_inicio or '' }}">
                <input type="hidden" name="fim" value="{{ data_fim or '' }}">
                <input type="hidden" name="sort" value="{{ sort or '' }}">
                <input type="hidden" name="cs_collaborator_id" value="{{ cs_collab_id or '' }}">
                <input type="hidden" name="cs_page" value="{{ cs_page or '' }}">
            </form>
            {% endif %}
        </div>
    </div>
    <div class="mm-card-body">
        <form class="mm-grid mm-grid-cols-3 mm-gap-4" method="get" action="{{ url_for('jornada.index') }}" style="display: grid; grid-auto-flow: column; column-gap: 1cm; align-items: end;">
            <div>
                <label class="mm-label">Colaborador</label>
                <select name="colaborador" class="mm-input mm-select">
                    <option value="">— todos —</option>
                    {% for c in colaboradores %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mm-grid mm-grid-cols-2 mm-gap-3" style="display: contents;">
                <div>
                    <label class="mm-label">Início</label>
                    <input type="date" name="inicio" value="{{ data_inicio or '' }}" class="mm-input">
                </div>
                <div>
                    <label class="mm-label">Fim</label>
                    <input type="date" name="fim" value="{{ data_fim or '' }}" class="mm-input">
                </div>
            </div>
            <div class="mm-grid mm-grid-cols-2 mm-gap-3" style="display: contents;">
                <div>
                    <label class="mm-label">Ordenação</label>
                    <select class="mm-input" name="sort">
                        <option value="data desc" {% if sort == 'data desc' %}selected{% endif %}>Data ↓</option>
                        <option value="data asc" {% if sort == 'data asc' %}selected{% endif %}>Data ↑</option>
                        <option value="colaborador desc" {% if sort == 'colaborador desc' %}selected{% endif %}>Colaborador ↓</option>
                        <option value="colaborador asc" {% if sort == 'colaborador asc' %}selected{% endif %}>Colaborador ↑</option>
                    </select>
                </div>
                <div class="mm-flex mm-items-end mm-justify-end">
                    <button class="mm-btn mm-btn-primary mm-wide-btn" type="submit"><i class="bi bi-search"></i> Buscar</button>
                </div>
            </div>
        </form>
        {% if q_colab %}
        <div class="mm-mt-4">
            <div class="mm-flex mm-items-center mm-justify-between mm-mb-3">
                <h3 class="mm-card-title"><i class="bi bi-clipboard-data me-2"></i>Resumo do Período</h3>
                {% if resumo_colab_nome %}
                <span class="mm-badge">{{ resumo_colab_nome }}</span>
                {% endif %}
            </div>
            <div class="mm-grid mm-grid-cols-2 mm-gap-6">
                <div>
                    <div class="mm-text-muted">Horas</div>
                    <div class="mm-text-xl mm-font-bold">{{ '%.2f'|format((cs_item and cs_item.residual_hours) or (resumo_horas or 0)) }} h</div>
                </div>
                <div>
                    <div class="mm-text-muted">Dias</div>
                    <div class="mm-text-xl mm-font-bold">{{ '%.0f'|format(((cs_item and cs_item.saldo_days) or (resumo_dias or 0)) | float) }} dia(s)</div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="registros" class="mm-mt-4">
            <div class="mm-flex mm-items-center mm-justify-between mm-mb-3">
                <h3 class="mm-card-title"><i class="bi bi-table me-2"></i>Registros</h3>
                <span class="mm-badge">{{ total }} registros</span>
            </div>
            <div id="folgas" class="mm-mt-6">
                <div class="mm-flex mm-items-center mm-justify-between mm-mb-3">
                    <h3 class="mm-card-title"><i class="bi bi-calendar-minus me-2"></i>Uso de Folgas</h3>
                </div>
                <form method="get" action="{{ url_for('jornada.index') }}" class="mm-flex mm-gap-2 mm-items-center mm-mb-4">
                    <input type="hidden" name="la_page" value="1">
                    <select name="la_collaborator_id" class="mm-input mm-select" style="min-width: 220px;">
                        <option value="">— filtrar colaborador —</option>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}" {% if la_collab_id and la_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="mm-btn mm-btn-outline"><i class="bi bi-search"></i> Filtrar</button>
                </form>

                <form id="formFolgaAcao" method="post" action="{{ url_for('usuarios.gestao_colabs_folga_uso_adicionar') }}" class="mm-form-row mm-mb-6">
                    <div class="mm-form-group">
                        <label class="mm-label">Colaborador</label>
                        <select name="collaborator_id" class="mm-input mm-select" required>
                            {% for c in colaboradores %}
                            <option value="{{ c.id }}">{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mm-form-group">
                        <label class="mm-label">Data</label>
                        <input type="date" name="date" class="mm-input" required>
                    </div>
                    <div class="mm-form-group">
                        <label class="mm-label">Dias</label>
                        <input type="number" name="days" id="diasInput" class="mm-input" min="1" value="1" required>
                        <input type="hidden" name="days_used" id="days_used_hidden">
                    </div>
                    <div class="mm-form-group" style="flex: 2;">
                        <label class="mm-label">Observações</label>
                        <input type="text" name="notes" class="mm-input" placeholder="Observações (opcional)">
                    </div>
                    <div class="mm-form-group">
                        <label class="mm-label">Ação</label>
                        <div class="mm-flex mm-gap-3" role="radiogroup">
                            <label class="mm-flex mm-items-center mm-gap-2"><input type="radio" name="acao" value="uso" id="acaoUso" checked> <span>Registrar uso</span></label>
                            <label class="mm-flex mm-items-center mm-gap-2"><input type="radio" name="acao" value="conversao" id="acaoConv"> <span>Converter em R$</span></label>
                        </div>
                    </div>
                    <div class="mm-form-group" id="convRate" hidden>
                        <label class="mm-label">Valor por dia (R$)</label>
                        <input type="number" step="0.01" name="rate_per_day" id="rateInput" class="mm-input" value="65">
                    </div>
                    <div class="mm-form-group" id="convAmount" hidden>
                        <label class="mm-label">Total a pagar (R$)</label>
                        <input type="number" step="0.01" name="amount_paid" id="amountInput" class="mm-input" value="65.00">
                    </div>
                    <div class="mm-form-group" style="align-self: end;">
                        <button class="mm-btn mm-btn-primary" type="submit">
                            <i class="bi bi-plus-lg"></i>
                            Salvar
                        </button>
                    </div>
                </form>

                <div class="mm-table-wrapper">
                    <table class="mm-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Colaborador</th>
                                <th style="text-align: center;">Dias Usados</th>
                                <th>Observações</th>
                                <th style="text-align: right;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for la in leave_assignments_page %}
                            {% set col = colaboradores|selectattr('id', 'equalto', la.collaborator_id)|list|first %}
                            <tr>
                                <td>{{ la.date.strftime('%d/%m/%Y') }}</td>
                                <td>{{ col and col.name or ('ID ' ~ la.collaborator_id) }}</td>
                                <td style="text-align: center;">
                                    <span class="mm-badge mm-badge-danger">-{{ la.days_used }}</span>
                                </td>
                                <td>{{ la.notes or '-' }}</td>
                                <td style="text-align: right;">
                                    <div class="mm-flex mm-gap-2" style="justify-content: flex-end;">
                                        <form method="post" action="{{ url_for('usuarios.gestao_colabs_folga_uso_excluir', id=la.id) }}" class="mm-inline-form" onsubmit="return confirm('Excluir uso de folga?')">
                                            <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="mm-empty-cell">
                                    <div class="mm-empty-inline">
                                        <i class="bi bi-calendar-x"></i>
                                        <span>Sem uso de folgas registrado</span>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mm-flex mm-items-center mm-justify-between mm-mt-3">
                    <div class="mm-text-sm mm-text-muted">Página {{ la_page }} de {{ la_total_pages }}</div>
                    <div class="mm-pagination">
                        <a class="mm-btn mm-btn-sm mm-btn-outline {% if la_page <= 1 %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?la_page={{ la_page-1 if la_page>1 else 1 }}&la_collaborator_id={{ la_collab_id or '' }}">
                            <i class="bi bi-chevron-left"></i> Anterior
                        </a>
                        <a class="mm-btn mm-btn-sm mm-btn-outline {% if la_page >= la_total_pages %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?la_page={{ la_page+1 if la_page<la_total_pages else la_total_pages }}&la_collaborator_id={{ la_collab_id or '' }}">
                            Próxima <i class="bi bi-chevron-right"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Observações</th>
                            {% if current_user.nivel == 'admin' %}
                            <th class="text-end">Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for w, c in registros %}
                        <tr>
                            <td><strong>{{ c.name }}</strong></td>
                            <td>{{ 'Horas' if w.tipo_registro == 'horas' else 'Dias' }}</td>
                            <td>{% if w.tipo_registro == 'horas' %}{{ '%.2f'|format(w.valor or 0) }} h{% else %}{{ '%.0f'|format(w.valor or 0) }} dia(s){% endif %}</td>
                            <td>{{ w.data.strftime('%d/%m/%Y') }}</td>
                            <td>{{ w.observacao or '-' }}</td>
                            {% if current_user.nivel == 'admin' %}
                            <td class="text-end">
                                <div class="mm-flex mm-gap-2 mm-justify-end">
                                    <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" data-view-id="{{ w.id }}" data-view-colab="{{ c.id }}" data-view-tipo="{{ w.tipo_registro }}" data-view-valor="{{ '%.2f'|format(w.valor or 0) }}" data-view-data="{{ w.data.strftime('%Y-%m-%d') }}" title="Detalhes">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" data-edit-id="{{ w.id }}" data-edit-colab="{{ c.id }}" data-edit-tipo="{{ w.tipo_registro }}" data-edit-valor="{{ '%.2f'|format(w.valor or 0) }}" data-edit-data="{{ w.data.strftime('%Y-%m-%d') }}" data-edit-obs="{{ w.observacao or '' }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <a class="mm-btn mm-btn-sm mm-btn-outline" href="{{ url_for('jornada.export', colaborador=c.id, inicio=w.data.strftime('%Y-%m-%d'), fim=w.data.strftime('%Y-%m-%d') ) }}" title="Exportar dia">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <form method="post" action="{{ url_for('jornada.delete', worklog_id=w.id) }}" onsubmit="return confirm('Excluir este registro?')" style="display:inline;">
                                        <button class="mm-btn mm-btn-sm mm-btn-danger" type="submit"><i class="bi bi-trash"></i></button>
                                    </form>
                                </div>
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 6 if current_user.nivel == 'admin' else 5 }}" class="mm-empty-cell">
                                <div class="mm-empty-state mm-py-8">
                                    <i class="bi bi-archive" style="font-size: 2rem;"></i>
                                    <p>Nenhum registro encontrado</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mm-flex mm-items-center mm-justify-between mm-mt-3">
                <div class="mm-text-sm mm-text-muted">Página {{ page }} de {{ total_pages }}</div>
                <div class="mm-pagination">
                    <a class="mm-btn mm-btn-sm mm-btn-outline {% if page <= 1 %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?page={{ page-1 if page>1 else 1 }}&colaborador={{ q_colab }}&tipo={{ tipo }}&inicio={{ data_inicio }}&fim={{ data_fim }}&sort={{ sort }}">
                        <i class="bi bi-chevron-left"></i> Anterior
                    </a>
                    <a class="mm-btn mm-btn-sm mm-btn-outline {% if page >= total_pages %}mm-disabled{% endif %}" href="{{ url_for('jornada.index') }}?page={{ page+1 if page<total_pages else total_pages }}&colaborador={{ q_colab }}&tipo={{ tipo }}&inicio={{ data_inicio }}&fim={{ data_fim }}&sort={{ sort }}">
                        Próximo <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% if q_colab %}{% endif %}


<div class="mm-card mm-mb-6" id="ferias">
    <div class="mm-card-header mm-flex mm-items-center mm-justify-between">
        <h3 class="mm-card-title">
            <i class="bi bi-sun mm-text-warning"></i>
            Gestão de Férias
        </h3>
        <div class="mm-flex mm-gap-2">
            <button type="button" class="mm-btn mm-btn-sm mm-btn-primary" id="btnPanelFerias">Férias</button>
            <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" id="btnPanelAtestados">Atestados</button>
        </div>
    </div>
    <div class="mm-card-body">
        <div id="panelFerias">
        <form method="get" action="{{ url_for('jornada.index') }}" class="mm-flex mm-gap-2 mm-items-center">
            <input type="hidden" name="ferias_page" value="1">
            <select name="ferias_collaborator_id" class="mm-input mm-select" style="min-width: 220px;">
                <option value="">— filtrar colaborador —</option>
                {% for c in colaboradores %}
                <option value="{{ c.id }}" {% if ferias_collab_id and ferias_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="mm-btn mm-btn-outline"><i class="bi bi-search"></i> Filtrar</button>
        </form>
        <form method="post" action="{{ url_for('usuarios.gestao_ferias_adicionar') }}" class="mm-form-row mm-mb-6">
            <div class="mm-form-group">
                <label class="mm-label">Colaborador</label>
                <select name="collaborator_id" class="mm-input mm-select" required>
                    {% for c in colaboradores %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mm-form-group">
                <label class="mm-label">Data Início</label>
                <input type="date" name="data_inicio" class="mm-input" required>
            </div>
            <div class="mm-form-group">
                <label class="mm-label">Data Fim</label>
                <input type="date" name="data_fim" class="mm-input" required>
            </div>
            <div class="mm-form-group" style="flex: 2;">
                <label class="mm-label">Observação</label>
                <input type="text" name="observacao" class="mm-input" placeholder="Observação (opcional)">
            </div>
            <div class="mm-form-group" style="align-self: end;">
                <button class="mm-btn mm-btn-primary" type="submit">
                    <i class="bi bi-plus-lg"></i>
                    Registrar Férias
                </button>
            </div>
        </form>
        
        <div class="mm-table-wrapper">
            <table class="mm-table">
                <thead>
                    <tr>
                        <th>Colaborador</th>
                        <th>Data Início</th>
                        <th>Data Fim</th>
                        <th style="text-align: center;">Dias</th>
                        <th>Observação</th>
                        <th style="text-align: right;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for f in ferias_page_items %}
                    {% set col = colaboradores|selectattr('id', 'equalto', f.collaborator_id)|list|first %}
                    <tr>
                        <td>{{ col and col.name or ('ID ' ~ f.collaborator_id) }}</td>
                        <td>{{ f.data_inicio.strftime('%d/%m/%Y') }}</td>
                        <td>{{ f.data_fim.strftime('%d/%m/%Y') }}</td>
                        <td style="text-align: center;">
                            <span class="mm-badge mm-badge-warning">{{ (f.data_fim - f.data_inicio).days + 1 }} dias</span>
                        </td>
                        <td>{{ f.observacao or '-' }}</td>
                        <td style="text-align: right;">
                            <form method="post" action="{{ url_for('usuarios.gestao_ferias_excluir', id=f.id) }}" class="mm-inline-form" onsubmit="return confirm('Excluir férias?')">
                                <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="mm-empty-cell">
                            <div class="mm-empty-inline">
                                <i class="bi bi-sun"></i>
                                <span>Nenhuma férias registrada</span>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mm-pagination">
            <div class="mm-flex mm-items-center mm-justify-between">
                <div>Pagina {{ ferias_page }} de {{ ferias_total_pages }}</div>
                <div class="mm-flex mm-gap-2">
                    {% if ferias_page > 1 %}
                    <a class="mm-btn mm-btn-outline mm-btn-sm" href="{{ url_for('jornada.index') }}?ferias_page={{ ferias_page-1 }}&ferias_collaborator_id={{ ferias_collab_id or '' }}"><i class="bi bi-chevron-left"></i> Anterior</a>
                    {% endif %}
                    {% if ferias_page < ferias_total_pages %}
                    <a class="mm-btn mm-btn-outline mm-btn-sm" href="{{ url_for('jornada.index') }}?ferias_page={{ ferias_page+1 }}&ferias_collaborator_id={{ ferias_collab_id or '' }}">Próxima <i class="bi bi-chevron-right"></i></a>
                    {% endif %}
                </div>
            </div>
        </div>
        </div>
        <div id="panelAtestados" hidden>
            <div class="mm-mb-4 mm-flex mm-items-center mm-gap-2">
                <i class="bi bi-file-medical mm-text-info"></i>
                <span class="mm-card-title">Atestados Médicos</span>
            </div>
            <form method="get" action="{{ url_for('jornada.index') }}" class="mm-flex mm-gap-2 mm-items-center">
                <input type="hidden" name="at_page" value="1">
                <select name="at_collaborator_id" class="mm-input mm-select" style="min-width: 220px;">
                    <option value="">— filtrar colaborador —</option>
                    {% for c in colaboradores %}
                    <option value="{{ c.id }}" {% if at_collab_id and at_collab_id == c.id %}selected{% endif %}>{{ c.name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" class="mm-btn mm-btn-outline"><i class="bi bi-search"></i> Filtrar</button>
            </form>
            <form method="post" action="{{ url_for('usuarios.gestao_atestado_adicionar') }}" enctype="multipart/form-data" class="mm-form-row mm-mb-6" style="flex-wrap: wrap;">
                <div class="mm-form-group">
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" class="mm-input mm-select" required>
                        {% for c in colaboradores %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Início</label>
                    <input type="date" name="data_inicio" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Data Fim</label>
                    <input type="date" name="data_fim" class="mm-input" required>
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">CID (opcional)</label>
                    <input type="text" name="cid" class="mm-input" placeholder="Ex: J00">
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Médico (opcional)</label>
                    <input type="text" name="medico" class="mm-input" placeholder="Nome do médico">
                </div>
                <div class="mm-form-group" style="flex: 2;">
                    <label class="mm-label">Motivo</label>
                    <input type="text" name="motivo" class="mm-input" placeholder="Motivo do afastamento">
                </div>
                <div class="mm-form-group">
                    <label class="mm-label">Foto do Atestado</label>
                    <input type="file" name="foto_atestado" class="mm-input" accept="image/*">
                </div>
                <div class="mm-form-group" style="align-self: end;">
                    <button class="mm-btn mm-btn-primary" type="submit">
                        <i class="bi bi-plus-lg"></i>
                        Registrar Atestado
                    </button>
                </div>
            </form>
            <div class="mm-table-wrapper">
                <table class="mm-table">
                    <thead>
                        <tr>
                            <th>Colaborador</th>
                            <th>Período</th>
                            <th style="text-align: center;">Dias</th>
                            <th>Motivo</th>
                            <th>CID</th>
                            <th>Foto</th>
                            <th style="text-align: right;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in atestados_page %}
                        {% set col = colaboradores|selectattr('id', 'equalto', a.collaborator_id)|list|first %}
                        <tr>
                            <td>{{ col and col.name or ('ID ' ~ a.collaborator_id) }}</td>
                            <td>{{ a.data_inicio.strftime('%d/%m') }} - {{ a.data_fim.strftime('%d/%m/%Y') }}</td>
                            <td style="text-align: center;">
                                <span class="mm-badge mm-badge-info">{{ a.dias }} dias</span>
                            </td>
                            <td>{{ a.motivo or '-' }}</td>
                            <td>{{ a.cid or '-' }}</td>
                            <td>
                                {% if a.foto_atestado %}
                                <a href="{{ url_for('static', filename='uploads/atestados/' ~ a.foto_atestado) }}" target="_blank" class="mm-btn mm-btn-outline mm-btn-sm">
                                    <i class="bi bi-image"></i> Ver
                                </a>
                                {% else %}
                                <span class="mm-text-muted">-</span>
                                {% endif %}
                            </td>
                            <td style="text-align: right;">
                                <form method="post" action="{{ url_for('usuarios.gestao_atestado_excluir', id=a.id) }}" class="mm-inline-form" onsubmit="return confirm('Excluir atestado?')">
                                    <button class="mm-btn mm-btn-danger mm-btn-sm" type="submit">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="mm-empty-cell">
                                <div class="mm-empty-inline">
                                    <i class="bi bi-file-medical"></i>
                                    <span>Nenhum atestado registrado</span>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="mm-pagination">
                <div class="mm-flex mm-items-center mm-justify-between">
                    <div>Pagina {{ at_page }} de {{ at_total_pages }}</div>
                    <div class="mm-flex mm-gap-2">
                        {% if at_page > 1 %}
                        <a class="mm-btn mm-btn-outline mm-btn-sm" href="{{ url_for('jornada.index') }}?at_page={{ at_page-1 }}&at_collaborator_id={{ at_collab_id or '' }}"><i class="bi bi-chevron-left"></i> Anterior</a>
                        {% endif %}
                        {% if at_page < at_total_pages %}
                        <a class="mm-btn mm-btn-outline mm-btn-sm" href="{{ url_for('jornada.index') }}?at_page={{ at_page+1 }}&at_collaborator_id={{ at_collab_id or '' }}">Próxima <i class="bi bi-chevron-right"></i></a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- removed duplicate 'Gestão de Folgas' card and its modals -->



<div id="modalOverlay" class="mm-modal-overlay" hidden></div>
<div id="modalDialog" class="mm-modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" hidden>
    <div class="mm-modal-header">
        <h3 id="modalTitle" class="mm-card-title"><i class="bi bi-pencil-square mm-text-primary"></i> Atualizar</h3>
        <button type="button" class="mm-btn mm-btn-sm mm-btn-outline" id="btnCloseModal" aria-label="Fechar">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="mm-modal-body">
        <form id="jornadaForm" method="post" action="{{ url_for('usuarios.gestao_colabs_horas_adicionar') }}">
            <input type="hidden" name="_edit_id" id="_edit_id">
            <input type="hidden" name="hours" id="hoursHidden">
            <input type="hidden" name="amount_days" id="amountDaysHidden">
            <input type="hidden" name="days_used" id="daysUsedHidden">
            <input type="hidden" name="origin" id="originHidden" value="manual">
            <input type="hidden" name="reason" id="reasonHidden">
            <input type="hidden" name="notes" id="notesHidden">
            <input type="hidden" name="tipo" id="tipoHidden">
            <div class="mm-grid mm-grid-cols-2 mm-gap-4">
                <div>
                    <label class="mm-label">Ação</label>
                    <select id="acaoSelect" name="acao_unificada" class="mm-input">
                        <option value="horas" selected>Horas Extra</option>
                        <option value="folga_credito">Folga (Crédito)</option>
                        <option value="folga_uso">Folga (Uso)</option>
                    </select>
                    <div id="acaoHelp" class="mm-text-sm mm-text-muted mm-mt-1"></div>
                </div>
                <div>
                    <label class="mm-label">Data</label>
                    <input type="date" name="date" id="dataInput" class="mm-input" required>
                    <div class="mm-text-sm mm-text-muted mm-mt-1" id="dateFeedback"></div>
                </div>
                <div>
                    <label class="mm-label">Colaborador</label>
                    <select name="collaborator_id" id="colabSelect" class="mm-input" required>
                        <option value="">Selecione...</option>
                        {% for col in colaboradores %}
                        <option value="{{ col.id }}">{{ col.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="mm-label" id="valorLabel">Horas</label>
                    <input type="number" step="0.25" min="0" max="24" id="valorInput" class="mm-input" placeholder="Ex.: 2.5" required>
                    <div class="mm-text-sm mm-mt-1" id="valorFeedback"></div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label class="mm-label">Observações</label>
                    <input type="text" name="observacao" id="obsInput" class="mm-input" placeholder="Observações (opcional)">
                </div>
            </div>
            <div id="opSummary" class="mm-summary-box mm-mt-3" aria-live="polite"></div>
            <div class="mm-flex mm-justify-end mm-gap-2 mm-mt-4">
                <button type="submit" class="mm-btn mm-btn-primary" id="btnSubmit">
                    <span id="submitLabel">Atualizar</span>
                    <span id="submitLoading" hidden><i class="bi bi-arrow-repeat"></i></span>
                </button>
            </div>
        </form>
        <div id="editHistory" class="mm-mt-4" hidden></div>
    </div>
</div>

<style>
.mm-subnav { position: sticky; top: 0; background: var(--mm-bg); border-bottom: 1px solid var(--mm-border); padding: 0.5rem 0; z-index: 50; }
.mm-subnav .mm-btn { white-space: nowrap; }
.mm-modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.35); z-index: 1000; opacity:0; transition: opacity 300ms ease; }
.mm-modal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: min(720px, 92vw); background: var(--mm-bg-card); border: 1px solid var(--mm-border); border-radius: var(--mm-radius-lg); z-index: 1001; opacity:0; transition: opacity 300ms ease; max-height: 80vh; display:flex; flex-direction:column; }
.mm-modal-header { display:flex; align-items:center; justify-content:space-between; padding: var(--mm-space-4); border-bottom: 1px solid var(--mm-border); }
.mm-modal-body { padding: var(--mm-space-4); overflow:auto; }
.mm-dropdown { position: absolute; background: var(--mm-bg); border: 1px solid var(--mm-border); border-radius: var(--mm-radius); margin-top: 4px; max-height: 180px; overflow:auto; width: 100%; }
.mm-dropdown-item { padding: 8px 12px; cursor: pointer; }
.mm-dropdown-item:hover { background: var(--mm-bg-secondary); }
.mm-summary-box { border: 1px dashed var(--mm-border); border-radius: var(--mm-radius); padding: 10px; font-size: var(--mm-text-sm); color: var(--mm-text-muted); }
@media (max-width: 768px) { .mm-modal { top: 6%; } }
</style>

<style>
.mm-card-mini { width: 220px; min-width: 220px; min-height: 120px; height: auto; background: var(--mm-bg-card); border: 1px solid var(--mm-border); border-radius: var(--mm-radius); padding: var(--mm-space-3); display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; gap: var(--mm-space-2); }
.mm-card-mini-title { font-weight: 600; margin-bottom: 4px; }
.mm-card-mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; align-items: center; width: 100%; }
.mm-resumo-grid { display: none; }
@media (max-width: 768px) { .mm-card-mini { width: 100%; min-width: unset; } }
@media (max-width: 768px) {
  .mm-page-header .mm-flex.mm-gap-3 { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: auto; gap: var(--mm-space-2); }
  #btnOpenModal, .mm-migrar-btn, .mm-export-btn { order: initial; width: 100%; }
  .mm-page-header .mm-flex.mm-gap-3 form { width: 100%; }
  .mm-wide-btn { width: 100%; }
}
@media (max-width: 768px) {
  .mm-card .mm-card-header { flex-direction: column; align-items: stretch; gap: var(--mm-space-2); }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: var(--mm-space-2); align-items: stretch; justify-items: center; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 a.mm-btn,
  .mm-card .mm-card-header .mm-flex.mm-gap-2 button.mm-btn { width: auto; padding: 0.25rem 0.6rem; min-height: 2rem; display: flex; align-items: center; justify-content: center; gap: var(--mm-space-1); justify-self: center; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 a.mm-btn { width: auto; padding: 0.25rem 0.6rem; min-height: 2rem; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 a.mm-btn { display: flex; align-items: center; justify-content: center; gap: var(--mm-space-1); }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 a.mm-btn i,
  .mm-card .mm-card-header .mm-flex.mm-gap-2 button.mm-btn i,
  .mm-card .mm-card-body .mm-grid .mm-flex.mm-items-end .mm-btn i { display: inline-flex; align-items: center; justify-content: center; line-height: 1; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 input.mm-input { height: 2.25rem; width: 100%; padding: 0.35rem 0.75rem; font-size: var(--mm-text-sm); box-sizing: border-box; }
  .mm-card .mm-card-body .mm-grid .mm-flex.mm-items-end .mm-btn { width: 100%; padding: 0.35rem 0.75rem; font-size: var(--mm-text-sm); }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 form { display: contents; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 input[name="del_inicio"] { grid-row: 1; grid-column: 1; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 input[name="del_fim"] { grid-row: 1; grid-column: 2; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 a.mm-btn { grid-row: 2; grid-column: 1; }
  .mm-card .mm-card-header .mm-flex.mm-gap-2 button[type="submit"] { grid-row: 2; grid-column: 2; }
}
@media (max-width: 768px) {
  .mm-resumo-card .mm-card-body form { flex-direction: column; align-items: stretch; gap: var(--mm-space-2); }
  .mm-resumo-card .mm-card-body form .mm-label { display: block; }
  .mm-resumo-card .mm-card-body form .mm-input, .mm-resumo-card .mm-card-body form .mm-select, .mm-resumo-card .mm-card-body form button { width: 100%; }
  .mm-resumo-card .mm-card-body form button { align-self: stretch; }
  .mm-resumo-card .mm-flex.mm-items-center.mm-justify-between.mm-mt-3 { flex-direction: column; gap: var(--mm-space-2); align-items: stretch; }
  .mm-resumo-card .mm-pagination { display: flex; gap: var(--mm-space-2); }
  .mm-resumo-card .mm-pagination a { width: 100%; }
}
/* desktop layout */
@media (min-width: 1024px) {
  .mm-resumo-card .mm-flex.mm-flex-wrap.mm-gap-4 { display: none; }
  .mm-resumo-card .mm-resumo-grid { display: grid; grid-template-columns: repeat(4, minmax(220px, 1fr)); gap: var(--mm-space-4); }
}
</style>

<script>
const overlay = document.getElementById('modalOverlay');
const dialog = document.getElementById('modalDialog');
const openBtn = document.getElementById('btnOpenModal');
const closeBtn = document.getElementById('btnCloseModal');
const form = document.getElementById('jornadaForm');
const valorInput = document.getElementById('valorInput');
const valorFeedback = document.getElementById('valorFeedback');
const valorLabel = document.getElementById('valorLabel');
const dateInput = document.getElementById('dataInput');
const dateFeedback = document.getElementById('dateFeedback');
const colabSelect = document.getElementById('colabSelect');
const submitLabel = document.getElementById('submitLabel');
const submitLoading = document.getElementById('submitLoading');
const acaoSelect = document.getElementById('acaoSelect');
const hoursHidden = document.getElementById('hoursHidden');
const amountDaysHidden = document.getElementById('amountDaysHidden');
const daysUsedHidden = document.getElementById('daysUsedHidden');
const originHidden = document.getElementById('originHidden');
const reasonHidden = document.getElementById('reasonHidden');
const notesHidden = document.getElementById('notesHidden');
const obsInput = document.getElementById('obsInput');


const autoObs = { last: '', edited: false };
if (obsInput) {
  obsInput.addEventListener('input', ()=>{ autoObs.edited = true; });
}
function parseYmd(dstr){ const parts = (dstr || '').split('-'); const y = parseInt(parts[0]||'0',10); const m = parseInt(parts[1]||'1',10)-1; const d = parseInt(parts[2]||'1',10); return new Date(y, m, d); }
function formatBRDate(dstr){ const dt = parseYmd(dstr); const dd = String(dt.getDate()).padStart(2,'0'); const mm = String(dt.getMonth()+1).padStart(2,'0'); const yyyy = dt.getFullYear(); return `${dd}/${mm}/${yyyy}`; }
function setAutoObs(text){ if (!obsInput) return; const val = text || ''; const cur = (obsInput.value || '').trim(); if (!autoObs.edited || cur === '' || cur === autoObs.last){ obsInput.value = val; autoObs.last = val; autoObs.edited = false; } }

function openModal() {
  overlay.hidden = false; dialog.hidden = false;
  requestAnimationFrame(()=>{ overlay.style.opacity = '1'; dialog.style.opacity = '1'; });
  dialog.focus();
}
function closeModal() {
  overlay.style.opacity = '0'; dialog.style.opacity = '0';
  setTimeout(()=>{ overlay.hidden = true; dialog.hidden = true; }, 300);
}
if (openBtn) openBtn.addEventListener('click', ()=>{ document.getElementById('_edit_id').value=''; submitLabel.textContent='Atualizar'; setAction(); openModal(); });
if (closeBtn) closeBtn.addEventListener('click', closeModal);
overlay.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !dialog.hidden) closeModal(); });

valorInput.addEventListener('input', ()=>{ const v = valorInput.value; const ok = v !== '' && !isNaN(parseFloat(v)); valorFeedback.textContent = ok ? '' : 'Valor inválido'; });

// seleção direta via select

function isWeekend(d) { const t = parseYmd(d); const k = t.getDay(); return k === 0 || k === 6; }
function isSunday(d) { const t = parseYmd(d); return t.getDay() === 0; }
function checkHoliday(d) {
  fetch("{{ url_for('jornada.is_holiday') }}?date=" + encodeURIComponent(d))
    .then(r=>r.json())
    .then(j=>{
      if (j && j.holiday) { dateFeedback.textContent = 'Feriado: ' + (j.name || ''); setAutoObs(((j.name || 'Feriado') + ' ' + formatBRDate(d))); }
      else if (isSunday(d)) { dateFeedback.textContent = 'Fim de semana'; setAutoObs(('Domingo ' + formatBRDate(d))); }
      else { dateFeedback.textContent = ''; }
    })
    .catch(()=>{ if (isSunday(d)) { dateFeedback.textContent = 'Fim de semana'; setAutoObs(('Domingo ' + formatBRDate(d))); } else { dateFeedback.textContent = isWeekend(d) ? 'Fim de semana' : ''; } });
}
dateInput.addEventListener('change', ()=>{ const d = dateInput.value; if (!d) return; checkHoliday(d); });

document.querySelectorAll('[data-edit-id]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-edit-id');
    const cid = btn.getAttribute('data-edit-colab');
    const tipo = btn.getAttribute('data-edit-tipo');
    const valor = btn.getAttribute('data-edit-valor');
    const data = btn.getAttribute('data-edit-data');
    document.getElementById('_edit_id').value = id;
    form.action = "{{ url_for('jornada.update', worklog_id='__ID__') }}".replace('__ID__', id);
    tipoHidden.value = tipo;
    if (tipo === 'horas') { valorLabel.textContent='Horas'; valorInput.step='0.25'; valorInput.min='0'; valorInput.max='24'; }
    else { valorLabel.textContent='Dias'; valorInput.step='1'; valorInput.min='1'; valorInput.max='365'; }
    valorInput.value = valor;
    dateInput.value = data;
    colabSelect.value = cid;
    valorFeedback.textContent = '';
    const obsField = document.getElementById('obsInput');
    obsField.value = btn.getAttribute('data-edit-obs') || '';
    submitLabel.textContent='Salvar Alterações';
    const histBox = document.getElementById('editHistory');
    fetch("{{ url_for('jornada.history', worklog_id='__ID__') }}".replace('__ID__', id))
      .then(r=>r.json()).then(j=>{
        histBox.hidden = false; histBox.innerHTML = '';
        const title = document.createElement('div'); title.className='mm-text-muted mm-mb-2'; title.textContent='Histórico de alterações'; histBox.appendChild(title);
        if (!j || !j.items || j.items.length === 0) { const p = document.createElement('div'); p.className='mm-text-sm'; p.textContent='Sem alterações.'; histBox.appendChild(p); return; }
        const list = document.createElement('div'); list.className='mm-flex mm-flex-col mm-gap-1';
        j.items.forEach(it=>{ const row = document.createElement('div'); row.className='mm-text-sm'; row.textContent = `${it.changed_at}: ${it.old_tipo} ${it.old_valor} -> ${it.new_tipo} ${it.new_valor}`; list.appendChild(row); });
        histBox.appendChild(list);
      }).catch(()=>{ histBox.hidden = true; });
    openModal();
    setAction();
  });
});

    document.querySelectorAll('[data-view-id]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-view-id');
    const cid = btn.getAttribute('data-view-colab');
    const tipo = btn.getAttribute('data-view-tipo');
    const valor = btn.getAttribute('data-view-valor');
    const data = btn.getAttribute('data-view-data');
    document.getElementById('_edit_id').value = '';
    form.action = '';
    tipoHidden.value = tipo;
    if (tipo === 'horas') { valorLabel.textContent='Horas'; valorInput.step='0.25'; valorInput.min='0'; valorInput.max='24'; }
    else { valorLabel.textContent='Dias'; valorInput.step='1'; valorInput.min='1'; valorInput.max='365'; }
    valorInput.value = valor;
    dateInput.value = data;
    colabSelect.value = cid;
    valorFeedback.textContent = '';
    submitLabel.textContent='Salvar';
    document.getElementById('btnSubmit').style.display = 'none';
    const histBox = document.getElementById('editHistory');
    fetch("{{ url_for('jornada.history', worklog_id='__ID__') }}".replace('__ID__', id))
      .then(r=>r.json()).then(j=>{
        histBox.hidden = false; histBox.innerHTML = '';
        const title = document.createElement('div'); title.className='mm-text-muted mm-mb-2'; title.textContent='Histórico de alterações'; histBox.appendChild(title);
        if (!j || !j.items || j.items.length === 0) { const p = document.createElement('div'); p.className='mm-text-sm'; p.textContent='Sem alterações.'; histBox.appendChild(p); return; }
        const list = document.createElement('div'); list.className='mm-flex mm-flex-col mm-gap-1';
        j.items.forEach(it=>{ const row = document.createElement('div'); row.className='mm-text-sm'; row.textContent = `${it.changed_at}: ${it.old_tipo} ${it.old_valor} -> ${it.new_tipo} ${it.new_valor}`; list.appendChild(row); });
        histBox.appendChild(list);
      }).catch(()=>{ histBox.hidden = true; });
    openModal();
    setAction();
    setTimeout(()=>{ document.getElementById('btnSubmit').style.display = ''; }, 350);
  });
});

form.addEventListener('submit', (e)=>{
  submitLoading.hidden = false; submitLabel.textContent = 'Salvando...';
  const v = parseFloat(valorInput.value || 'NaN');
  const d = dateInput.value;
  const cid = colabSelect.value;
  let ok = true;
  if (isNaN(v)) ok = false;
  if (!cid) ok = false;
  if (!d) ok = false;
  if (d) { const today = new Date(); const dd = new Date(d); if (dd > today) ok = false; }
  if (!ok) { e.preventDefault(); submitLoading.hidden = true; submitLabel.textContent = 'Atualizar'; return; }
  notesHidden.value = (obsInput.value || '').trim();
  reasonHidden.value = notesHidden.value;
  hoursHidden.value = '';
  amountDaysHidden.value = '';
  daysUsedHidden.value = '';
  e.preventDefault();
  const valSubmit = (acaoSelect && acaoSelect.value) || 'horas';
  let actionUrl = '';
  if (valSubmit === 'horas') {
    actionUrl = "{{ url_for('usuarios.gestao_colabs_horas_adicionar') }}";
    hoursHidden.value = v.toString();
  } else if (valSubmit === 'folga_credito') {
    actionUrl = "{{ url_for('usuarios.gestao_colabs_folga_credito_adicionar') }}";
    amountDaysHidden.value = Math.max(1, Math.round(v)).toString();
    originHidden.value = 'manual';
  } else if (valSubmit === 'folga_uso') {
    actionUrl = "{{ url_for('usuarios.gestao_colabs_folga_uso_adicionar') }}";
    daysUsedHidden.value = Math.max(1, Math.round(v)).toString();
  }
  const body = new URLSearchParams(new FormData(form));
  fetch(actionUrl, { method: 'POST', body })
    .then(()=>{ submitLoading.hidden = true; submitLabel.textContent = 'Atualizar'; closeModal(); window.location.href = "{{ url_for('jornada.index') }}"; })
    .catch(()=>{ submitLoading.hidden = true; submitLabel.textContent = 'Atualizar'; closeModal(); window.location.href = "{{ url_for('jornada.index') }}"; });
});

function setAction(){
  let help = '';
  const val = (acaoSelect && acaoSelect.value) || 'horas';
  let label = 'Horas'; let step = 0.25; let min = 0; let max = 24; let placeholder = 'Ex.: 2.5';
  if (val === 'folga_credito') { label = 'Dias (crédito)'; step = 1; min = 1; max = 365; placeholder = 'Ex.: 1'; help = 'Adiciona dias ao saldo de folgas do colaborador.'; }
  if (val === 'folga_uso') { label = 'Valor'; step = 1; min = 1; max = 365; placeholder = 'Ex.: 1'; help = 'Debita dias do saldo, somente se houver saldo positivo.'; }
  if (val === 'horas') { help = 'Registra horas no banco. Conversão automática 8h→1 dia e ajuste -8h aplicados.'; }
  valorLabel.textContent = label;
  valorInput.step = String(step);
  valorInput.min = String(min);
  valorInput.max = String(max);
  valorInput.placeholder = placeholder;
  const editIdVal = (document.getElementById('_edit_id') && document.getElementById('_edit_id').value) || '';
  if (!editIdVal) { submitLabel.textContent = 'Atualizar'; }
  const helpBox = document.getElementById('acaoHelp'); if (helpBox) helpBox.textContent = help;
  valorFeedback.textContent = '';
  if (val === 'horas') {
    form.action = "{{ url_for('usuarios.gestao_colabs_horas_adicionar') }}";
  } else if (val === 'folga_credito') {
    form.action = "{{ url_for('usuarios.gestao_colabs_folga_credito_adicionar') }}";
  } else if (val === 'folga_uso') {
    form.action = "{{ url_for('usuarios.gestao_colabs_folga_uso_adicionar') }}";
  }
  renderSummary();
}
if (acaoSelect) acaoSelect.addEventListener('change', setAction);

function renderSummary(){
  const box = document.getElementById('opSummary');
  if (!box) return;
  const val = (acaoSelect && acaoSelect.value) || 'horas';
  let tipo = 'Folga (Uso)';
  if (val === 'horas') tipo = 'Horas Extra';
  else if (val === 'folga_credito') tipo = 'Folga (Crédito)';
  const vraw = valorInput.value || '';
  let valor = '—';
  if (vraw !== '' && !isNaN(parseFloat(vraw))) {
    if (val === 'horas') valor = `${parseFloat(vraw)} h`;
    else valor = `${Math.max(1, Math.round(parseFloat(vraw)))} dia(s)`;
  }
  const d = dateInput.value || '';
  const data = d ? formatBRDate(d) : '—';
  let colaborador = '—';
  if (colabSelect && colabSelect.value) {
    const opt = colabSelect.options[colabSelect.selectedIndex];
    colaborador = opt ? opt.text : '—';
  }
  box.textContent = `Operação: ${tipo} • Valor: ${valor} • Data: ${data} • Colaborador: ${colaborador}`;
}

valorInput.addEventListener('input', renderSummary);
dateInput.addEventListener('change', renderSummary);
colabSelect.addEventListener('change', renderSummary);

// toggle Férias/Atestados panels
(function(){
  const btnF = document.getElementById('btnPanelFerias');
  const btnA = document.getElementById('btnPanelAtestados');
  const btnL = document.getElementById('btnPanelFolgas');
  const pF = document.getElementById('panelFerias');
  const pA = document.getElementById('panelAtestados');
  const folCard = document.getElementById('folgas');
  if (btnF && btnA && pF && pA) {
    function setBtnPrimary(btn){ btn.classList.add('mm-btn-primary'); btn.classList.remove('mm-btn-outline'); }
    function setBtnOutline(btn){ btn.classList.add('mm-btn-outline'); btn.classList.remove('mm-btn-primary'); }
    function activateFerias(){ if(folCard){ folCard.style.display='none'; } pF.hidden=false; pA.hidden=true; setBtnPrimary(btnF); setBtnOutline(btnA); if(btnL){ setBtnOutline(btnL); } }
    function activateAtest(){ if(folCard){ folCard.style.display='none'; } pF.hidden=true; pA.hidden=false; setBtnPrimary(btnA); setBtnOutline(btnF); if(btnL){ setBtnOutline(btnL); } }
    function activateFolgas(){ if(folCard){ folCard.style.display=''; } pF.hidden=true; pA.hidden=true; if(btnL){ setBtnPrimary(btnL); } setBtnOutline(btnF); setBtnOutline(btnA); }
    btnF.addEventListener('click', activateFerias);
    btnA.addEventListener('click', activateAtest);
    if(btnL) btnL.addEventListener('click', activateFolgas);
    if(folCard){ folCard.style.display='none'; }
    activateFerias();
  }
})();

// Folgas form: toggle conversão campos e cálculo
(function(){
  const uso = document.getElementById('acaoUso');
  const conv = document.getElementById('acaoConv');
  const rateBox = document.getElementById('convRate');
  const amountBox = document.getElementById('convAmount');
  const dias = document.getElementById('diasInput');
  const rate = document.getElementById('rateInput');
  const amount = document.getElementById('amountInput');
  const hiddenDaysUsed = document.getElementById('days_used_hidden');
  function sync() {
    if (hiddenDaysUsed && dias) hiddenDaysUsed.value = dias.value || 1;
    const isConv = conv && conv.checked;
    if (rateBox) rateBox.hidden = !isConv;
    if (amountBox) amountBox.hidden = !isConv;
    if (isConv && dias && rate && amount) {
      const d = parseFloat(dias.value || '1');
      const r = parseFloat(rate.value || '0');
      amount.value = (d * r).toFixed(2);
    }
  }
  if (uso) uso.addEventListener('change', sync);
  if (conv) conv.addEventListener('change', sync);
  if (dias) dias.addEventListener('input', sync);
  if (rate) rate.addEventListener('input', sync);
  sync();
})();

// Paginação em div (máximo 10 itens por página) para o grid de resumo
(function(){
  const grid = document.querySelector('.mm-resumo-card .mm-resumo-grid');
  if (!grid) return;
  const items = Array.from(grid.children || []);
  const pageSize = 10;
  const totalPages = Math.max(1, Math.ceil(items.length / pageSize));
  let page = 1;
  if (items.length <= pageSize) return;
  function render(){
    items.forEach((el, i)=>{
      const visible = i >= (page-1)*pageSize && i < page*pageSize;
      el.style.display = visible ? '' : 'none';
    });
    if (label) label.textContent = `Página ${page} de ${totalPages}`;
    prev.classList.toggle('mm-disabled', page <= 1);
    next.classList.toggle('mm-disabled', page >= totalPages);
  }
  const ctrl = document.createElement('div');
  ctrl.className = 'mm-pagination mm-mt-2';
  const wrap = document.createElement('div');
  wrap.className = 'mm-flex mm-items-center mm-justify-between';
  const label = document.createElement('div');
  label.className = 'mm-text-sm mm-text-muted';
  const btnBox = document.createElement('div');
  btnBox.className = 'mm-pagination';
  const prev = document.createElement('a');
  prev.href = 'javascript:void(0)';
  prev.className = 'mm-btn mm-btn-sm mm-btn-outline';
  prev.innerHTML = '<i class="bi bi-chevron-left"></i> Anterior';
  const next = document.createElement('a');
  next.href = 'javascript:void(0)';
  next.className = 'mm-btn mm-btn-sm mm-btn-outline';
  next.innerHTML = 'Próxima <i class="bi bi-chevron-right"></i>';
  btnBox.appendChild(prev);
  btnBox.appendChild(next);
  wrap.appendChild(label);
  wrap.appendChild(btnBox);
  ctrl.appendChild(wrap);
  grid.parentNode.appendChild(ctrl);
  prev.addEventListener('click', ()=>{ if (page > 1) { page--; render(); } });
  next.addEventListener('click', ()=>{ if (page < totalPages) { page++; render(); } });
  render();
})();

(function(){
  const actions = document.querySelector('.mm-card .mm-card-header .mm-flex.mm-gap-2');
  if (!actions) return;
  const anchor = actions.querySelector('a.mm-btn');
  const massaBtn = actions.querySelector('form .mm-btn[type="submit"]');
  const buscarBtn = document.querySelector('.mm-card .mm-card-body .mm-grid .mm-flex.mm-items-end .mm-btn');
  const targets = [massaBtn, buscarBtn].filter(Boolean);
  function apply(){
    if (!anchor) return;
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    const w = anchor.offsetWidth;
    const h = anchor.offsetHeight;
    targets.forEach(t=>{
      if (!t) return;
      if (h) t.style.height = h + 'px';
      if (isMobile) { if (w) t.style.width = w + 'px'; } else { t.style.width = ''; }
    });
  }
  apply();
  window.addEventListener('resize', apply);
  document.addEventListener('DOMContentLoaded', apply);
  try {
    const ro = new (window.ResizeObserver || function(){})((entries)=>{ apply(); });
    if (ro && anchor) ro.observe(anchor);
  } catch (e) {}
})();
</script>
{% endblock %}
